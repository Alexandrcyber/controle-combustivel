<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PDF Custos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üß™ Teste PDF Custos - Sistema de Combust√≠vel</h1>
    
    <div class="log">
        <h3>üìä Status dos Dados:</h3>
        <div id="statusDados">Carregando...</div>
    </div>
    
    <div class="log">
        <h3>üîß Controles de Teste:</h3>
        <button onclick="carregarDados()">üîÑ Carregar Dados</button>
        <button onclick="testarPdfCustos()">üìÑ Gerar PDF Custos</button>
        <button onclick="verificarFuncoes()">üîç Verificar Fun√ß√µes</button>
    </div>
    
    <div class="log">
        <h3>üìù Logs:</h3>
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }

        async function carregarDados() {
            log('üîÑ Iniciando carregamento de dados...');
            
            try {
                // Carregar caminh√µes
                const responseCaminhoes = await fetch('/api/caminhoes');
                const caminhoes = await responseCaminhoes.json();
                window.caminhoes = caminhoes;
                
                // Carregar abastecimentos
                const responseAbastecimentos = await fetch('/api/abastecimentos');
                const abastecimentos = await responseAbastecimentos.json();
                window.abastecimentos = abastecimentos;
                
                log(`‚úÖ Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`, 'success');
                
                const statusDiv = document.getElementById('statusDados');
                statusDiv.innerHTML = `
                    <strong>Caminh√µes:</strong> ${caminhoes.length}<br>
                    <strong>Abastecimentos:</strong> ${abastecimentos.length}<br>
                    <strong>Dados globais definidos:</strong> ‚úÖ
                `;
                
            } catch (error) {
                log(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
            }
        }

        function verificarFuncoes() {
            log('üîç Verificando fun√ß√µes dispon√≠veis...');
            
            const funcoes = [
                'exportarPdfCustos',
                'formatarNumero',
                'formatarMoeda',
                'getField',
                'getNumField',
                'normalizarTextoPDF',
                'adicionarTextoPDF'
            ];
            
            funcoes.forEach(nome => {
                if (typeof window[nome] === 'function') {
                    log(`‚úÖ Fun√ß√£o ${nome} dispon√≠vel`, 'success');
                } else {
                    log(`‚ùå Fun√ß√£o ${nome} n√£o encontrada`, 'error');
                }
            });
        }

        async function testarPdfCustos() {
            log('üìÑ Testando gera√ß√£o de PDF de custos...');
            
            // Verificar se os dados est√£o carregados
            if (!window.caminhoes || !window.abastecimentos) {
                log('‚ö†Ô∏è Carregando dados primeiro...', 'info');
                await carregarDados();
            }
            
            try {
                // Simular campos preenchidos
                const hoje = new Date();
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(hoje.getDate() - 30);
                
                const dataInicio = trintaDiasAtras.toISOString().split('T')[0];
                const dataFim = hoje.toISOString().split('T')[0];
                
                log(`üìÖ Per√≠odo teste: ${dataInicio} at√© ${dataFim}`);
                
                // Criar elementos tempor√°rios para simular o formul√°rio
                const tempForm = document.createElement('div');
                tempForm.innerHTML = `
                    <input type="date" id="custosDataInicio" value="${dataInicio}">
                    <input type="date" id="custosDataFim" value="${dataFim}">
                    <select id="caminhaoCustosSelect"><option value="todos">Todos</option></select>
                `;
                document.body.appendChild(tempForm);
                
                // Testar se a fun√ß√£o existe
                if (typeof exportarPdfCustos === 'function') {
                    log('‚úÖ Fun√ß√£o exportarPdfCustos encontrada, executando...', 'success');
                    await exportarPdfCustos();
                } else {
                    log('‚ùå Fun√ß√£o exportarPdfCustos n√£o est√° dispon√≠vel', 'error');
                    
                    // Tentar carregar o script
                    const script = document.createElement('script');
                    script.src = '/src/js/relatorios.js';
                    document.head.appendChild(script);
                    
                    script.onload = () => {
                        log('üìÑ Script de relat√≥rios carregado', 'success');
                    };
                    
                    script.onerror = () => {
                        log('‚ùå Erro ao carregar script de relat√≥rios', 'error');
                    };
                }
                
                // Limpar elementos tempor√°rios
                document.body.removeChild(tempForm);
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }

        // Carregar dados automaticamente
        window.addEventListener('load', () => {
            carregarDados();
            verificarFuncoes();
        });
    </script>
</body>
</html>
