<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Debug PDF</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>üêû Debug - Teste PDF</h1>
        
        <div class="alert alert-info">
            <strong>Status:</strong> <span id="status">Carregando...</span>
        </div>
        
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary me-2" onclick="carregarDados()">1. Carregar Dados</button>
                <button class="btn btn-warning me-2" onclick="testarValidacao()">2. Testar Valida√ß√£o</button>
                <button class="btn btn-danger me-2" onclick="testarPdf()">3. Gerar PDF</button>
                <button class="btn btn-info" onclick="limparLog()">Limpar Log</button>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Log Detalhado:</h5>
            <div id="log" class="border p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="src/js/alerts.js"></script>
    <script src="src/js/relatorios.js"></script>
    
    <script>
        let caminhoes = [];
        let abastecimentos = [];
        
        function log(mensagem, tipo = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const cor = {
                'info': '#0066cc',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            }[tipo] || '#000';
            
            logDiv.innerHTML += `<div style="color: ${cor}; margin: 2px 0;">[${timestamp}] ${mensagem}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${tipo.toUpperCase()}] ${mensagem}`);
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Verifica√ß√£o inicial
        window.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina carregada', 'info');
            
            // Verificar depend√™ncias
            const dependencias = [
                { nome: 'SweetAlert2', check: () => typeof Swal !== 'undefined' },
                { nome: 'jsPDF', check: () => typeof window.jspdf !== 'undefined' },
                { nome: 'jsPDF AutoTable', check: () => typeof window.jspdf?.jsPDF?.prototype?.autoTable !== 'undefined' },
                { nome: 'Sistema de Alertas', check: () => typeof AlertSuccess !== 'undefined' },
                { nome: 'obterDadosDoRelatorio', check: () => typeof obterDadosDoRelatorio === 'function' },
                { nome: 'exportarPdfCompleto', check: () => typeof exportarPdfCompleto === 'function' }
            ];
            
            let todasOk = true;
            dependencias.forEach(dep => {
                if (dep.check()) {
                    log(`‚úÖ ${dep.nome}: OK`, 'success');
                } else {
                    log(`‚ùå ${dep.nome}: FALTANDO`, 'error');
                    todasOk = false;
                }
            });
            
            if (todasOk) {
                document.getElementById('status').textContent = '‚úÖ Todas as depend√™ncias carregadas';
                document.getElementById('status').className = 'text-success fw-bold';
            } else {
                document.getElementById('status').textContent = '‚ùå Algumas depend√™ncias est√£o faltando';
                document.getElementById('status').className = 'text-danger fw-bold';
            }
        });
        
        // 1. Carregar dados
        async function carregarDados() {
            try {
                log('üì• Iniciando carregamento de dados...', 'info');
                
                const [caminhoesData, abastecimentosData] = await Promise.all([
                    fetch('http://localhost:3001/api/caminhoes').then(r => {
                        log(`üì° Response caminh√µes: ${r.status}`, 'info');
                        return r.json();
                    }),
                    fetch('http://localhost:3001/api/abastecimentos').then(r => {
                        log(`üì° Response abastecimentos: ${r.status}`, 'info');
                        return r.json();
                    })
                ]);
                
                caminhoes = caminhoesData;
                abastecimentos = abastecimentosData;
                
                // Definir globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;
                
                log(`‚úÖ Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`, 'success');
                
                if (abastecimentos.length > 0) {
                    const primeiro = abastecimentos[0];
                    log(`üìä Primeiro abastecimento: ID=${primeiro.id}, Data=${primeiro.data}, Caminh√£o=${primeiro.caminhao_id}`, 'info');
                } else {
                    log('‚ö†Ô∏è Nenhum abastecimento encontrado!', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }
        
        // 2. Testar valida√ß√£o
        function testarValidacao() {
            try {
                log('üîç Testando fun√ß√£o obterDadosDoRelatorio()...', 'info');
                
                const resultado = obterDadosDoRelatorio();
                
                log(`üìä Resultado da valida√ß√£o:`, 'info');
                log(`  ‚û§ valid: ${resultado.valid}`, resultado.valid ? 'success' : 'error');
                
                if (resultado.message) {
                    log(`  ‚û§ message: ${resultado.message}`, resultado.valid ? 'info' : 'warning');
                }
                
                if (resultado.valid) {
                    log(`  ‚û§ dadosPorCaminhao: ${Object.keys(resultado.dadosPorCaminhao || {}).length} caminh√µes`, 'info');
                    log(`  ‚û§ abastecimentos: ${(resultado.abastecimentos || []).length} registros`, 'info');
                    log(`  ‚û§ per√≠odo: ${resultado.periodo?.inicio} at√© ${resultado.periodo?.fim}`, 'info');
                    log('‚úÖ Valida√ß√£o passou - dados prontos para PDF', 'success');
                } else {
                    log('‚ùå Valida√ß√£o falhou - PDF n√£o ser√° gerado', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }
        
        // 3. Testar PDF
        function testarPdf() {
            try {
                log('üìÑ Iniciando teste de gera√ß√£o de PDF...', 'info');
                
                // Verificar se h√° dados
                if (!window.abastecimentos || window.abastecimentos.length === 0) {
                    log('‚ö†Ô∏è Nenhum dado carregado. Execute "Carregar Dados" primeiro.', 'warning');
                    return;
                }
                
                log('üéØ Chamando exportarPdfCompleto()...', 'info');
                
                // Interceptar console.log temporariamente para capturar logs da fun√ß√£o
                const originalLog = console.log;
                const originalError = console.error;
                
                console.log = (...args) => {
                    log(`[PDF] ${args.join(' ')}`, 'info');
                    originalLog.apply(console, args);
                };
                
                console.error = (...args) => {
                    log(`[PDF ERROR] ${args.join(' ')}`, 'error');
                    originalError.apply(console, args);
                };
                
                // Tentar executar a fun√ß√£o
                const resultado = exportarPdfCompleto();
                
                // Restaurar console
                setTimeout(() => {
                    console.log = originalLog;
                    console.error = originalError;
                }, 5000);
                
                log('‚úÖ Fun√ß√£o exportarPdfCompleto() executada', 'success');
                
                if (resultado instanceof Promise) {
                    log('‚è≥ Fun√ß√£o retornou Promise, aguardando...', 'info');
                    resultado
                        .then(() => log('‚úÖ PDF gerado com sucesso!', 'success'))
                        .catch(error => log(`‚ùå Erro na Promise: ${error.message}`, 'error'));
                } else {
                    log('‚úÖ Fun√ß√£o executada sincronamente', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao gerar PDF: ${error.message}`, 'error');
                log(`‚ùå Stack: ${error.stack}`, 'error');
                console.error('Erro completo:', error);
            }
        }
    </script>
</body>
</html>
