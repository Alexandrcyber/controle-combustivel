<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Espec√≠fico - Erro toFixed()</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .debug-panel { background: white; border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .console-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üîç Teste Espec√≠fico - Erro toFixed()</h1>
        
        <div class="debug-panel">
            <h3>üìä Status da Investiga√ß√£o</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Backend API</h5>
                            <p class="card-text" id="backend-status">üîÑ Verificando...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Dados Carregados</h5>
                            <p class="card-text" id="dados-status">üîÑ Verificando...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Erro Reproduzido</h5>
                            <p class="card-text" id="erro-status">üîÑ Aguardando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-panel">
            <h3>üéØ Teste de Gera√ß√£o de PDF</h3>
            <div class="row">
                <div class="col-md-6">
                    <button id="testarPDF" class="btn btn-primary btn-lg w-100">üöÄ Gerar PDF (Reproduzir Erro)</button>
                </div>
                <div class="col-md-6">
                    <button id="inspecionarDados" class="btn btn-info btn-lg w-100">üîç Inspecionar Dados Brutos</button>
                </div>
            </div>
        </div>

        <div class="debug-panel">
            <h3>üñ•Ô∏è Console de Debug</h3>
            <div class="console-output" id="debugConsole">
                <div class="info">üîÑ Inicializando sistema de debug...</div>
            </div>
        </div>

        <div class="debug-panel" id="dadosInspecao" style="display: none;">
            <h3>üìã Inspe√ß√£o de Dados</h3>
            <div id="dadosDetalhados"></div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="src/js/db-api.js"></script>
    <script src="src/js/relatorios.js"></script>

    <script>
        // Interceptar console.log para mostrar no debug
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(message, type = 'info') {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            
            console.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('‚ùå ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('‚ö†Ô∏è ' + args.join(' '), 'warning');
        };

        // Vari√°veis globais
        let caminhoes = [];
        let abastecimentos = [];
        let erroEncontrado = false;

        // Fun√ß√£o para verificar status do backend
        async function verificarBackend() {
            try {
                const response = await fetch('http://localhost:3001/api/caminhoes');
                if (response.ok) {
                    document.getElementById('backend-status').innerHTML = '<span class="text-success">‚úÖ Online</span>';
                    console.log('‚úÖ Backend API conectado');
                    return true;
                } else {
                    throw new Error('Status n√£o ok');
                }
            } catch (error) {
                document.getElementById('backend-status').innerHTML = '<span class="text-danger">‚ùå Offline</span>';
                console.error('‚ùå Backend API desconectado:', error.message);
                return false;
            }
        }

        // Fun√ß√£o para carregar dados
        async function carregarDados() {
            try {
                console.log('üîÑ Carregando dados da API...');
                
                const [caminhoesResponse, abastecimentosResponse] = await Promise.all([
                    fetch('http://localhost:3001/api/caminhoes'),
                    fetch('http://localhost:3001/api/abastecimentos')
                ]);

                caminhoes = await caminhoesResponse.json();
                abastecimentos = await abastecimentosResponse.json();

                console.log(`‚úÖ Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`);
                document.getElementById('dados-status').innerHTML = `<span class="text-success">‚úÖ ${caminhoes.length}C, ${abastecimentos.length}A</span>`;

                // Verificar estrutura dos dados
                if (abastecimentos.length > 0) {
                    console.log('üìä Estrutura do primeiro abastecimento:', Object.keys(abastecimentos[0]));
                    console.log('üìä Exemplo de abastecimento:', abastecimentos[0]);
                }

                return true;
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('dados-status').innerHTML = '<span class="text-danger">‚ùå Erro</span>';
                return false;
            }
        }

        // Fun√ß√£o para inspecionar dados detalhadamente
        function inspecionarDados() {
            console.log('üîç Iniciando inspe√ß√£o detalhada dos dados...');
            
            const detalhes = document.getElementById('dadosDetalhados');
            let html = '<h4>An√°lise de Campos e Valores</h4>';
            
            // Agrupar dados por caminh√£o (similar ao c√≥digo original)
            const dadosPorCaminhao = {};
            
            abastecimentos.forEach((abastecimento, index) => {
                const caminhaoId = abastecimento.caminhao_id;
                const caminhao = caminhoes.find(c => c.id === caminhaoId);
                
                if (!dadosPorCaminhao[caminhaoId]) {
                    dadosPorCaminhao[caminhaoId] = {
                        id: caminhaoId,
                        placa: caminhao ? caminhao.placa : 'PLACA_INDEFINIDA',
                        modelo: caminhao ? caminhao.modelo : 'MODELO_INDEFINIDO',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }

                // Verificar tipos e valores ANTES de calcular
                const kmInicial = abastecimento.km_inicial;
                const kmFinal = abastecimento.km_final;
                const litros = abastecimento.litros;
                const valorTotal = abastecimento.valor_total;

                console.log(`[${index}] Abastecimento ${caminhaoId}:`);
                console.log(`  km_inicial: ${kmInicial} (tipo: ${typeof kmInicial})`);
                console.log(`  km_final: ${kmFinal} (tipo: ${typeof kmFinal})`);
                console.log(`  litros: ${litros} (tipo: ${typeof litros})`);
                console.log(`  valor_total: ${valorTotal} (tipo: ${typeof valorTotal})`);

                // Tentar converter e detectar problemas
                try {
                    const distancia = parseFloat(kmFinal) - parseFloat(kmInicial);
                    const litrosFloat = parseFloat(litros);
                    const valorFloat = parseFloat(valorTotal);

                    console.log(`  distancia calculada: ${distancia} (tipo: ${typeof distancia})`);
                    console.log(`  litros convertido: ${litrosFloat} (tipo: ${typeof litrosFloat})`);
                    console.log(`  valor convertido: ${valorFloat} (tipo: ${typeof valorFloat})`);

                    if (isNaN(distancia) || isNaN(litrosFloat) || isNaN(valorFloat)) {
                        console.warn(`‚ö†Ô∏è Valores inv√°lidos detectados no abastecimento ${index}!`);
                    } else {
                        dadosPorCaminhao[caminhaoId].totalKm += distancia;
                        dadosPorCaminhao[caminhaoId].totalLitros += litrosFloat;
                        dadosPorCaminhao[caminhaoId].totalGasto += valorFloat;
                    }
                } catch (error) {
                    console.error(`‚ùå Erro no abastecimento ${index}:`, error);
                }
            });

            // Verificar propriedades finais que s√£o usadas com toFixed()
            console.log('üéØ Verificando propriedades que usam toFixed():');
            Object.values(dadosPorCaminhao).forEach((dados, index) => {
                console.log(`\n[Caminh√£o ${index}] ${dados.placa}:`);
                console.log(`  totalKm: ${dados.totalKm} (tipo: ${typeof dados.totalKm}, isNaN: ${isNaN(dados.totalKm)})`);
                console.log(`  totalLitros: ${dados.totalLitros} (tipo: ${typeof dados.totalLitros}, isNaN: ${isNaN(dados.totalLitros)})`);
                console.log(`  totalGasto: ${dados.totalGasto} (tipo: ${typeof dados.totalGasto}, isNaN: ${isNaN(dados.totalGasto)})`);

                // ESTE √â O TESTE CR√çTICO - tentar usar toFixed() e capturar o erro
                try {
                    const testeKm = dados.totalKm.toFixed(0);
                    console.log(`  ‚úÖ totalKm.toFixed(0): ${testeKm}`);
                } catch (error) {
                    console.error(`  ‚ùå ERRO totalKm.toFixed(): ${error.message}`);
                    erroEncontrado = true;
                }

                try {
                    const testeLitros = dados.totalLitros.toFixed(2);
                    console.log(`  ‚úÖ totalLitros.toFixed(2): ${testeLitros}`);
                } catch (error) {
                    console.error(`  ‚ùå ERRO totalLitros.toFixed(): ${error.message}`);
                    erroEncontrado = true;
                }

                try {
                    const testeGasto = dados.totalGasto.toFixed(2);
                    console.log(`  ‚úÖ totalGasto.toFixed(2): ${testeGasto}`);
                } catch (error) {
                    console.error(`  ‚ùå ERRO totalGasto.toFixed(): ${error.message}`);
                    erroEncontrado = true;
                }
            });

            if (erroEncontrado) {
                document.getElementById('erro-status').innerHTML = '<span class="text-danger">‚ùå Reproduzido</span>';
                console.error('üéØ ERRO REPRODUZIDO! O problema est√° nas propriedades undefined.');
            } else {
                document.getElementById('erro-status').innerHTML = '<span class="text-success">‚úÖ Sem erro</span>';
                console.log('‚úÖ Nenhum erro toFixed() encontrado na inspe√ß√£o.');
            }

            document.getElementById('dadosInspecao').style.display = 'block';
        }

        // Fun√ß√£o para testar PDF
        function testarPDF() {
            console.log('üöÄ Iniciando teste de gera√ß√£o de PDF...');
            
            try {
                // Usar a fun√ß√£o do sistema original
                exportarPdfCompleto();
                console.log('‚úÖ PDF gerado sem erro');
                document.getElementById('erro-status').innerHTML = '<span class="text-success">‚úÖ PDF OK</span>';
            } catch (error) {
                console.error('‚ùå ERRO NA GERA√á√ÉO DO PDF:', error.message);
                console.error('Stack trace:', error.stack);
                document.getElementById('erro-status').innerHTML = '<span class="text-danger">‚ùå PDF Erro</span>';
                erroEncontrado = true;
            }
        }

        // Event listeners
        document.getElementById('testarPDF').addEventListener('click', testarPDF);
        document.getElementById('inspecionarDados').addEventListener('click', inspecionarDados);

        // Inicializa√ß√£o
        async function inicializar() {
            console.log('üöÄ Iniciando sistema de debug do erro toFixed()...');
            
            const backendOk = await verificarBackend();
            if (backendOk) {
                const dadosOk = await carregarDados();
                if (dadosOk) {
                    console.log('‚úÖ Sistema pronto para testes');
                }
            }
        }

        // Executar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>
