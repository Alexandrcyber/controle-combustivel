<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - PDF de Custos Corrigido</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        .status-card.success { border-left-color: #27ae60; }
        .status-card.error { border-left-color: #e74c3c; }
        .status-card.warning { border-left-color: #f39c12; }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input[type="date"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: block;
            margin: 30px auto;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f5f8b);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(-1px);
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .debug-log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #34495e;
        }
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .data-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .data-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .data-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöõ Teste Final - PDF de Custos</h1>
        
        <div id="statusInicial" class="status-card">
            <h3>üîÑ Carregando dados do sistema...</h3>
            <div class="progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <div id="dadosResumo" class="data-summary" style="display: none;">
            <div class="data-item">
                <div id="totalCaminhoes" class="data-number">0</div>
                <div class="data-label">Caminh√µes</div>
            </div>
            <div class="data-item">
                <div id="totalAbastecimentos" class="data-number">0</div>
                <div class="data-label">Abastecimentos</div>
            </div>
            <div class="data-item">
                <div id="periodoUltimo" class="data-number">30</div>
                <div class="data-label">Dias (per√≠odo)</div>
            </div>
        </div>
        
        <div id="formSection" class="form-section" style="display: none;">
            <h3>üìÖ Configurar Per√≠odo do Relat√≥rio</h3>
            <div class="form-group">
                <label for="custosDataInicio">Data de In√≠cio:</label>
                <input type="date" id="custosDataInicio" />
            </div>
            <div class="form-group">
                <label for="custosDataFim">Data de Fim:</label>
                <input type="date" id="custosDataFim" />
            </div>
            <button class="btn" onclick="executarTestePdf()">
                üìÑ Gerar Relat√≥rio PDF de Custos
            </button>
        </div>
        
        <div id="logDebug" class="debug-log" style="display: none;"></div>
    </div>

    <!-- Bibliotecas necess√°rias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="src/js/relatorios.js"></script>
    
    <script>
        let logBuffer = '';
        let dadosCarregados = false;
        
        // Interceptar console.log para mostrar no debug
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            logBuffer += 'üìù ' + args.join(' ') + '\n';
            atualizarLog();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            logBuffer += '‚ùå ERROR: ' + args.join(' ') + '\n';
            atualizarLog();
            originalError.apply(console, args);
        };
        
        function atualizarLog() {
            const logElement = document.getElementById('logDebug');
            logElement.textContent = logBuffer;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function mostrarStatus(mensagem, tipo = 'info', elemento = 'statusInicial') {
            const statusDiv = document.getElementById(elemento);
            statusDiv.innerHTML = `<h3>${mensagem}</h3>`;
            statusDiv.className = `status-card ${tipo}`;
        }
        
        function atualizarProgresso(porcentagem) {
            document.getElementById('progressBar').style.width = porcentagem + '%';
        }
        
        // Carregar dados do sistema
        async function carregarDados() {
            try {
                mostrarStatus('üîÑ Carregando caminh√µes...', 'info');
                atualizarProgresso(25);
                
                const responseCaminhoes = await fetch('/api/caminhoes');
                if (!responseCaminhoes.ok) {
                    throw new Error(`Erro ao carregar caminh√µes: ${responseCaminhoes.status}`);
                }
                const caminhoes = await responseCaminhoes.json();
                window.caminhoes = caminhoes;
                console.log(`‚úÖ ${caminhoes.length} caminh√µes carregados`);
                
                mostrarStatus('üîÑ Carregando abastecimentos...', 'info');
                atualizarProgresso(50);
                
                const responseAbastecimentos = await fetch('/api/abastecimentos');
                if (!responseAbastecimentos.ok) {
                    throw new Error(`Erro ao carregar abastecimentos: ${responseAbastecimentos.status}`);
                }
                const abastecimentos = await responseAbastecimentos.json();
                window.abastecimentos = abastecimentos;
                console.log(`‚úÖ ${abastecimentos.length} abastecimentos carregados`);
                
                atualizarProgresso(75);
                
                // Verificar fun√ß√£o PDF
                if (typeof exportarPdfCustos !== 'function') {
                    throw new Error('Fun√ß√£o exportarPdfCustos n√£o encontrada!');
                }
                console.log('‚úÖ Fun√ß√£o exportarPdfCustos verificada');
                
                atualizarProgresso(100);
                mostrarStatus('‚úÖ Dados carregados com sucesso!', 'success');
                
                // Mostrar resumo dos dados
                document.getElementById('totalCaminhoes').textContent = caminhoes.length;
                document.getElementById('totalAbastecimentos').textContent = abastecimentos.length;
                document.getElementById('dadosResumo').style.display = 'grid';
                
                // Configurar datas padr√£o
                const hoje = new Date();
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(hoje.getDate() - 30);
                
                document.getElementById('custosDataFim').value = hoje.toISOString().split('T')[0];
                document.getElementById('custosDataInicio').value = trintaDiasAtras.toISOString().split('T')[0];
                
                // Mostrar formul√°rio
                document.getElementById('formSection').style.display = 'block';
                document.getElementById('logDebug').style.display = 'block';
                
                dadosCarregados = true;
                console.log('üéâ Sistema pronto para gerar PDF!');
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarStatus(`‚ùå Erro: ${error.message}`, 'error');
                atualizarProgresso(0);
            }
        }
        
        // Executar teste de PDF
        async function executarTestePdf() {
            if (!dadosCarregados) {
                alert('‚ö†Ô∏è Aguarde o carregamento dos dados!');
                return;
            }
            
            try {
                console.log('üöÄ Iniciando teste de gera√ß√£o de PDF...');
                mostrarStatus('üîÑ Gerando PDF de custos...', 'info');
                
                // Executar a fun√ß√£o corrigida
                await exportarPdfCustos();
                
                mostrarStatus('‚úÖ PDF gerado com sucesso! Verifique os downloads.', 'success');
                console.log('üéâ Teste de PDF conclu√≠do com sucesso!');
                
            } catch (error) {
                console.error('Erro no teste de PDF:', error);
                mostrarStatus(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }
        
        // Interceptar alerts para mostrar na interface
        window.alert = function(mensagem) {
            console.log('üö® ALERT:', mensagem);
            const alertDiv = document.createElement('div');
            alertDiv.className = 'status-card warning';
            alertDiv.innerHTML = `<h3>‚ö†Ô∏è ${mensagem}</h3>`;
            document.querySelector('.container').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
            
            return true;
        };
        
        // Inicializar quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ P√°gina de teste carregada');
            setTimeout(carregarDados, 500);
        });
    </script>
</body>
</html>
