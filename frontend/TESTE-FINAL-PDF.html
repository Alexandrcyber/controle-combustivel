<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste FINAL - Relat√≥rio PDF Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 900px;
        }
        .header-section {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            text-align: center;
        }
        .status-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            margin: 5px;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .btn-pdf {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .btn-test {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .progress-container {
            margin: 20px 0;
        }
        .card-body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <h1>üéØ TESTE FINAL</h1>
                <h2>Sistema de Relat√≥rio PDF Completo</h2>
                <p class="mb-0">Valida√ß√£o da funcionalidade completa implementada</p>
            </div>

            <div class="card-body">
                <!-- Status dos Servi√ßos -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card status-card bg-light">
                            <div class="card-body text-center">
                                <h5>üîß Backend</h5>
                                <div id="backend-status" class="fw-bold">Verificando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card status-card bg-light">
                            <div class="card-body text-center">
                                <h5>üìä Dados</h5>
                                <div id="data-status" class="fw-bold">Verificando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card status-card bg-light">
                            <div class="card-body text-center">
                                <h5>üõ†Ô∏è Fun√ß√µes</h5>
                                <div id="functions-status" class="fw-bold">Verificando...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de Teste -->
                <div class="text-center mb-4">
                    <button class="btn btn-custom btn-pdf btn-lg" onclick="testarPdfCompleto()">
                        üìÑ GERAR PDF COMPLETO (9 p√°ginas)
                    </button>
                    <br>
                    <button class="btn btn-custom btn-test" onclick="verificarSistema()">
                        üîç Verificar Sistema
                    </button>
                    <button class="btn btn-custom btn-test" onclick="testarConectividade()">
                        üåê Testar Conectividade
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress" style="height: 20px;">
                        <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Console de Sa√≠da -->
                <div class="console-output" id="console-output">
                    <div>[SISTEMA] Inicializando teste final do sistema...</div>
                    <div>[SISTEMA] Aguardando comandos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Carregamento do arquivo de relat√≥rios -->
    <script src="src/js/relatorios.js"></script>
    
    <script>
        const consoleElement = document.getElementById('console-output');
        const progressBar = document.getElementById('progress-bar');
        let testProgress = 0;

        function logConsole(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'INFO': '#00ff00',
                'SUCCESS': '#00ff88',
                'ERROR': '#ff6b6b',
                'WARNING': '#ffeb3b',
                'SYSTEM': '#00bfff'
            };
            
            const color = colors[type] || colors['INFO'];
            consoleElement.innerHTML += `<div style="color: ${color}">[${timestamp}] [${type}] ${message}</div>`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function updateProgress(percent) {
            testProgress = Math.max(0, Math.min(100, percent));
            progressBar.style.width = testProgress + '%';
            progressBar.textContent = Math.round(testProgress) + '%';
        }

        // Verifica√ß√£o inicial autom√°tica
        async function inicializarTestes() {
            logConsole('Iniciando verifica√ß√µes do sistema...', 'SYSTEM');
            updateProgress(10);

            try {
                // Verificar backend
                const backendResponse = await fetch('/api/health');
                const backendData = await backendResponse.json();
                
                document.getElementById('backend-status').innerHTML = '‚úÖ Online';
                document.getElementById('backend-status').className = 'fw-bold text-success';
                logConsole(`Backend conectado: ${backendData.status}`, 'SUCCESS');
                updateProgress(30);

                // Verificar dados
                const [caminhoesResp, abastecimentosResp] = await Promise.all([
                    fetch('/api/caminhoes'),
                    fetch('/api/abastecimentos')
                ]);

                const caminhoes = await caminhoesResp.json();
                const abastecimentos = await abastecimentosResp.json();

                document.getElementById('data-status').innerHTML = `‚úÖ ${caminhoes.length} caminh√µes<br>${abastecimentos.length} abastecimentos`;
                document.getElementById('data-status').className = 'fw-bold text-success';
                logConsole(`Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`, 'SUCCESS');
                updateProgress(60);

                // Verificar fun√ß√µes essenciais
                const funcoesEssenciais = [
                    'exportarPdfCompleto',
                    'obterDadosDoRelatorio',
                    'calcularTotaisGerais',
                    'formatDate'
                ];

                let funcoesOk = 0;
                funcoesEssenciais.forEach(funcao => {
                    if (typeof window[funcao] === 'function') {
                        funcoesOk++;
                        logConsole(`Fun√ß√£o ${funcao}: OK`, 'SUCCESS');
                    } else {
                        logConsole(`Fun√ß√£o ${funcao}: AUSENTE`, 'ERROR');
                    }
                });

                if (funcoesOk === funcoesEssenciais.length) {
                    document.getElementById('functions-status').innerHTML = '‚úÖ Todas OK';
                    document.getElementById('functions-status').className = 'fw-bold text-success';
                    logConsole('Todas as fun√ß√µes essenciais est√£o dispon√≠veis', 'SUCCESS');
                } else {
                    document.getElementById('functions-status').innerHTML = `‚ö†Ô∏è ${funcoesOk}/${funcoesEssenciais.length}`;
                    document.getElementById('functions-status').className = 'fw-bold text-warning';
                    logConsole(`Apenas ${funcoesOk} de ${funcoesEssenciais.length} fun√ß√µes encontradas`, 'WARNING');
                }

                updateProgress(100);
                logConsole('Sistema verificado e pronto para uso!', 'SYSTEM');

            } catch (error) {
                logConsole(`Erro na inicializa√ß√£o: ${error.message}`, 'ERROR');
                updateProgress(0);
            }
        }

        async function testarPdfCompleto() {
            logConsole('üöÄ INICIANDO TESTE DE PDF COMPLETO...', 'SYSTEM');
            
            try {
                // Verificar se a fun√ß√£o existe
                if (typeof exportarPdfCompleto !== 'function') {
                    throw new Error('Fun√ß√£o exportarPdfCompleto n√£o encontrada!');
                }

                logConsole('Fun√ß√£o exportarPdfCompleto encontrada', 'SUCCESS');
                logConsole('Executando gera√ß√£o de PDF...', 'INFO');

                // Executar a fun√ß√£o
                await exportarPdfCompleto();
                
                logConsole('üéâ PDF COMPLETO GERADO COM SUCESSO!', 'SUCCESS');

            } catch (error) {
                logConsole(`‚ùå ERRO: ${error.message}`, 'ERROR');
                console.error('Erro detalhado:', error);
                
                Swal.fire({
                    icon: 'error',
                    title: 'Erro na Gera√ß√£o do PDF',
                    text: error.message,
                    footer: 'Verifique o console (F12) para mais detalhes'
                });
            }
        }

        async function verificarSistema() {
            logConsole('Executando verifica√ß√£o completa do sistema...', 'SYSTEM');
            await inicializarTestes();
        }

        async function testarConectividade() {
            logConsole('Testando conectividade com todas as APIs...', 'INFO');
            
            const endpoints = [
                '/api/health',
                '/api/caminhoes', 
                '/api/abastecimentos',
                '/api/info'
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        logConsole(`${endpoint}: ‚úÖ OK`, 'SUCCESS');
                    } else {
                        logConsole(`${endpoint}: ‚ùå Status ${response.status}`, 'ERROR');
                    }
                } catch (error) {
                    logConsole(`${endpoint}: ‚ùå ${error.message}`, 'ERROR');
                }
            }
        }

        // Inicializa√ß√£o autom√°tica
        window.addEventListener('load', () => {
            logConsole('P√°gina carregada, iniciando verifica√ß√µes...', 'SYSTEM');
            setTimeout(inicializarTestes, 1000);
        });
    </script>
</body>
</html>
