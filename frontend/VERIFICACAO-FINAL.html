<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ VERIFICA√á√ÉO FINAL - Sistema Funcionando</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .content {
            padding: 40px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .status-item {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .status-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .status-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .test-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 20px 0;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        .test-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .result-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ VERIFICA√á√ÉO FINAL</h1>
            <h2>Sistema de Controle de Combust√≠vel</h2>
            <p>Teste da funcionalidade completa implementada</p>
        </div>
        
        <div class="content">
            <h3>üìä Status do Sistema</h3>
            <div class="status-grid">
                <div class="status-item" id="backend-status">
                    <h4>üîß Backend</h4>
                    <div>Verificando...</div>
                </div>
                <div class="status-item" id="data-status">
                    <h4>üìä Dados</h4>
                    <div>Verificando...</div>
                </div>
                <div class="status-item" id="functions-status">
                    <h4>üõ†Ô∏è Fun√ß√µes</h4>
                    <div>Verificando...</div>
                </div>
                <div class="status-item" id="pdf-status">
                    <h4>üìÑ PDF</h4>
                    <div>Aguardando...</div>
                </div>
            </div>

            <button class="test-button btn-success" onclick="executarTesteCompleto()">
                üöÄ EXECUTAR TESTE COMPLETO DO PDF
            </button>

            <button class="test-button btn-primary" onclick="verificarTodoSistema()">
                üîç VERIFICAR TODO O SISTEMA
            </button>

            <div class="result-area" id="results">
                <h4>üìã Resultados dos Testes</h4>
                <div id="log-output">
                    <p><strong>[SISTEMA]</strong> Aguardando execu√ß√£o dos testes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Carregar arquivo de relat√≥rios -->
    <script src="src/js/relatorios.js"></script>
    
    <script>
        let logArea = document.getElementById('log-output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const icon = icons[type] || '‚ÑπÔ∏è';
            
            logArea.innerHTML += `<p><strong>[${timestamp}]</strong> ${icon} ${message}</p>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-item ${status}`;
            element.querySelector('div').textContent = text;
        }

        async function verificarTodoSistema() {
            log('Iniciando verifica√ß√£o completa do sistema...', 'info');

            try {
                // 1. Verificar backend
                log('Verificando conex√£o com backend...', 'info');
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                updateStatus('backend-status', 'success', `‚úÖ Online (${healthData.status})`);
                log(`Backend: ${healthData.status} - ${healthData.version}`, 'success');

                // 2. Verificar dados
                log('Carregando dados do sistema...', 'info');
                const [caminhoesResp, abastecimentosResp] = await Promise.all([
                    fetch('/api/caminhoes'),
                    fetch('/api/abastecimentos')
                ]);

                const caminhoes = await caminhoesResp.json();
                const abastecimentos = await abastecimentosResp.json();

                updateStatus('data-status', 'success', `‚úÖ ${caminhoes.length}C / ${abastecimentos.length}A`);
                log(`Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`, 'success');

                // 3. Verificar fun√ß√µes
                log('Verificando fun√ß√µes JavaScript...', 'info');
                const funcoes = [
                    'exportarPdfCompleto',
                    'obterDadosDoRelatorio', 
                    'calcularTotaisGerais',
                    'formatDate',
                    'criarAnaliseDetalhadaPdf',
                    'criarAnaliseCustosPdf'
                ];

                let funcoesOk = 0;
                funcoes.forEach(f => {
                    if (typeof window[f] === 'function') {
                        funcoesOk++;
                    } else {
                        log(`Fun√ß√£o ${f} n√£o encontrada`, 'error');
                    }
                });

                if (funcoesOk === funcoes.length) {
                    updateStatus('functions-status', 'success', `‚úÖ ${funcoesOk}/${funcoes.length}`);
                    log(`Todas as ${funcoes.length} fun√ß√µes est√£o dispon√≠veis`, 'success');
                } else {
                    updateStatus('functions-status', 'error', `‚ùå ${funcoesOk}/${funcoes.length}`);
                    log(`Apenas ${funcoesOk} de ${funcoes.length} fun√ß√µes encontradas`, 'error');
                }

                log('‚úÖ Verifica√ß√£o do sistema conclu√≠da!', 'success');

            } catch (error) {
                log(`Erro na verifica√ß√£o: ${error.message}`, 'error');
                updateStatus('backend-status', 'error', '‚ùå Erro');
            }
        }

        async function executarTesteCompleto() {
            log('üöÄ INICIANDO TESTE COMPLETO DO PDF...', 'info');
            
            try {
                // Verificar se fun√ß√£o existe
                if (typeof exportarPdfCompleto !== 'function') {
                    throw new Error('Fun√ß√£o exportarPdfCompleto n√£o encontrada!');
                }

                log('Fun√ß√£o exportarPdfCompleto encontrada', 'success');
                updateStatus('pdf-status', 'success', 'üîÑ Gerando...');

                // Executar fun√ß√£o
                log('Executando gera√ß√£o do PDF...', 'info');
                await exportarPdfCompleto();

                updateStatus('pdf-status', 'success', '‚úÖ Conclu√≠do!');
                log('üéâ PDF COMPLETO GERADO COM SUCESSO!', 'success');
                log('O arquivo PDF de 9 p√°ginas foi criado e baixado automaticamente.', 'success');

                // Sucesso total
                Swal.fire({
                    icon: 'success',
                    title: 'üéâ TESTE CONCLU√çDO!',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>‚úÖ Sistema verificado com sucesso!</strong></p>
                            <p><strong>‚úÖ PDF completo gerado!</strong></p>
                            <p><strong>‚úÖ Todas as funcionalidades implementadas!</strong></p>
                            <br>
                            <p>O arquivo PDF com 9 p√°ginas foi gerado contendo:</p>
                            <ul style="text-align: left;">
                                <li>üìä Dashboard executivo</li>
                                <li>üìà An√°lises detalhadas</li>
                                <li>üí∞ An√°lise de custos</li>
                                <li>üéØ Indicadores de performance</li>
                                <li>üîÆ An√°lise preditiva</li>
                                <li>üìã Dados detalhados</li>
                                <li>üéÆ Simulador de cen√°rios</li>
                                <li>üîß Manuten√ß√£o preventiva</li>
                            </ul>
                        </div>
                    `,
                    confirmButtonText: 'Excelente!',
                    confirmButtonColor: '#28a745'
                });

            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error');
                updateStatus('pdf-status', 'error', '‚ùå Falha');
                console.error('Erro detalhado:', error);

                Swal.fire({
                    icon: 'error',
                    title: 'Erro no Teste',
                    text: error.message,
                    footer: 'Verifique o console (F12) para mais detalhes'
                });
            }
        }

        // Verifica√ß√£o autom√°tica ao carregar
        window.addEventListener('load', () => {
            log('P√°gina carregada, iniciando verifica√ß√£o autom√°tica...', 'info');
            setTimeout(verificarTodoSistema, 1000);
        });
    </script>
</body>
</html>
