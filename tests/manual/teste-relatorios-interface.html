<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Relat√≥rios - Controle de Combust√≠vel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .resultado { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; }
        .erro { border-color: #f00; background: #ffe6e6; }
        .sucesso { border-color: #0a0; background: #e6ffe6; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #log { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fff; }
    </style>
</head>
<body>
    <h1>üß™ Teste dos Relat√≥rios</h1>
    
    <button onclick="testarCarregamentoDados()">1. Testar Carregamento de Dados</button>
    <button onclick="testarRelatorioConsumo()">2. Testar Relat√≥rio de Consumo</button>
    <button onclick="testarRelatorioCustos()">3. Testar Relat√≥rio de Custos</button>
    <button onclick="limparLog()">Limpar Log</button>
    
    <div id="log"></div>
    
    <div id="resultado"></div>

    <script>
        let caminhoes = [];
        let abastecimentos = [];
        
        function log(mensagem, tipo = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const cor = tipo === 'erro' ? 'red' : tipo === 'sucesso' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${cor}">[${timestamp}] ${mensagem}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('resultado').innerHTML = '';
        }
        
        async function testarCarregamentoDados() {
            log('üîÑ Iniciando teste de carregamento de dados...');
            
            try {
                // Carregar caminh√µes
                const caminhoesResponse = await fetch('http://localhost:3001/api/caminhoes');
                if (!caminhoesResponse.ok) {
                    throw new Error(`Erro HTTP ${caminhoesResponse.status} ao carregar caminh√µes`);
                }
                caminhoes = await caminhoesResponse.json();
                log(`‚úÖ ${caminhoes.length} caminh√µes carregados`, 'sucesso');
                
                // Carregar abastecimentos
                const abastecimentosResponse = await fetch('http://localhost:3001/api/abastecimentos');
                if (!abastecimentosResponse.ok) {
                    throw new Error(`Erro HTTP ${abastecimentosResponse.status} ao carregar abastecimentos`);
                }
                abastecimentos = await abastecimentosResponse.json();
                log(`‚úÖ ${abastecimentos.length} abastecimentos carregados`, 'sucesso');
                
                // Verificar estrutura dos dados
                if (abastecimentos.length > 0) {
                    const exemplo = abastecimentos[0];
                    log(`üìä Estrutura do abastecimento: ${Object.keys(exemplo).join(', ')}`);
                    
                    // Verificar campos essenciais
                    const camposEssenciais = ['caminhao_id', 'km_inicial', 'km_final', 'valor_total'];
                    const camposFaltando = camposEssenciais.filter(campo => !(campo in exemplo));
                    
                    if (camposFaltando.length === 0) {
                        log('‚úÖ Todos os campos essenciais presentes', 'sucesso');
                    } else {
                        log(`‚ùå Campos faltando: ${camposFaltando.join(', ')}`, 'erro');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'erro');
            }
        }
        
        async function testarRelatorioConsumo() {
            log('üîÑ Testando relat√≥rio de consumo...');
            
            if (abastecimentos.length === 0) {
                log('‚ö†Ô∏è Carregue os dados primeiro', 'erro');
                return;
            }
            
            try {
                // Simular a fun√ß√£o gerarRelatorioConsumo
                const dataInicio = '2024-01-01';
                const dataFim = '2025-12-31';
                
                const abastecimentosFiltrados = abastecimentos.filter(a => 
                    a.data >= dataInicio && a.data <= dataFim
                );
                
                log(`üìä ${abastecimentosFiltrados.length} abastecimentos no per√≠odo`);
                
                // Agrupar dados por caminh√£o
                const dadosPorCaminhao = {};
                
                abastecimentosFiltrados.forEach(a => {
                    const caminhaoId = a.caminhao_id;
                    
                    if (!dadosPorCaminhao[caminhaoId]) {
                        const caminhao = caminhoes.find(c => c.id === caminhaoId);
                        dadosPorCaminhao[caminhaoId] = {
                            id: caminhaoId,
                            placa: caminhao ? caminhao.placa : 'Desconhecido',
                            modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                            totalKm: 0,
                            totalLitros: 0,
                            totalGasto: 0,
                            abastecimentos: []
                        };
                    }
                    
                    // Usar os nomes corretos da API com parseFloat
                    const distancia = parseFloat(a.km_final) - parseFloat(a.km_inicial);
                    const litros = parseFloat(a.litros);
                    const valorTotal = parseFloat(a.valor_total);
                    
                    dadosPorCaminhao[caminhaoId].totalKm += distancia;
                    dadosPorCaminhao[caminhaoId].totalLitros += litros;
                    dadosPorCaminhao[caminhaoId].totalGasto += valorTotal;
                    dadosPorCaminhao[caminhaoId].abastecimentos.push(a);
                });
                
                // Testar c√°lculos finais
                let relatorioHTML = '<h3>Teste do Relat√≥rio de Consumo</h3><table border="1"><tr><th>Caminh√£o</th><th>Dist√¢ncia</th><th>Combust√≠vel</th><th>Gasto Total</th><th>Consumo</th></tr>';
                
                Object.values(dadosPorCaminhao).forEach(dados => {
                    const mediaConsumo = dados.totalLitros > 0 ? 
                        (dados.totalKm / dados.totalLitros).toFixed(2) : 'N/A';
                    
                    // Este √© o ponto onde o erro "totalGasto.toFixed is not a function" pode ocorrer
                    const gastoFormatado = dados.totalGasto.toFixed(2);
                    
                    relatorioHTML += `<tr>
                        <td>${dados.placa} - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')} km</td>
                        <td>${dados.totalLitros.toFixed(2)} L</td>
                        <td>R$ ${gastoFormatado}</td>
                        <td>${mediaConsumo} km/l</td>
                    </tr>`;
                    
                    log(`‚úÖ ${dados.placa}: ${dados.totalKm}km, R$${gastoFormatado}, ${mediaConsumo}km/l`);
                });
                
                relatorioHTML += '</table>';
                document.getElementById('resultado').innerHTML = relatorioHTML;
                
                log('‚úÖ Relat√≥rio de consumo gerado com sucesso!', 'sucesso');
                
            } catch (error) {
                log(`‚ùå Erro no relat√≥rio de consumo: ${error.message}`, 'erro');
                console.error('Erro detalhado:', error);
            }
        }
        
        async function testarRelatorioCustos() {
            log('üîÑ Testando relat√≥rio de custos...');
            
            if (abastecimentos.length === 0) {
                log('‚ö†Ô∏è Carregue os dados primeiro', 'erro');
                return;
            }
            
            try {
                // Simular dados do relat√≥rio de custos
                const dadosAgrupados = {};
                
                abastecimentos.forEach(a => {
                    const chave = a.caminhao_id;
                    const caminhao = caminhoes.find(c => c.id === a.caminhao_id);
                    const nomeExibicao = caminhao ? `${caminhao.placa} - ${caminhao.modelo}` : 'Desconhecido';
                    
                    if (!dadosAgrupados[chave]) {
                        dadosAgrupados[chave] = {
                            chave: chave,
                            nome: nomeExibicao,
                            totalLitros: 0,
                            totalGasto: 0,
                            totalKm: 0,
                            abastecimentos: []
                        };
                    }
                    
                    const distancia = parseFloat(a.km_final) - parseFloat(a.km_inicial);
                    dadosAgrupados[chave].totalLitros += parseFloat(a.litros);
                    dadosAgrupados[chave].totalGasto += parseFloat(a.valor_total);
                    dadosAgrupados[chave].totalKm += distancia;
                    dadosAgrupados[chave].abastecimentos.push(a);
                });
                
                let relatorioHTML = '<h3>Teste do Relat√≥rio de Custos</h3><table border="1"><tr><th>Caminh√£o</th><th>Gasto Total</th><th>Combust√≠vel</th><th>Dist√¢ncia</th></tr>';
                
                Object.values(dadosAgrupados).forEach(dados => {
                    const gastoFormatado = dados.totalGasto.toFixed(2);
                    
                    relatorioHTML += `<tr>
                        <td>${dados.nome}</td>
                        <td>R$ ${gastoFormatado}</td>
                        <td>${dados.totalLitros.toFixed(2)} L</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')} km</td>
                    </tr>`;
                    
                    log(`‚úÖ ${dados.nome}: R$${gastoFormatado}`);
                });
                
                relatorioHTML += '</table>';
                document.getElementById('resultado').innerHTML = relatorioHTML;
                
                log('‚úÖ Relat√≥rio de custos gerado com sucesso!', 'sucesso');
                
            } catch (error) {
                log(`‚ùå Erro no relat√≥rio de custos: ${error.message}`, 'erro');
                console.error('Erro detalhado:', error);
            }
        }
        
        // Carregar dados automaticamente ao abrir a p√°gina
        window.onload = function() {
            log('üöÄ P√°gina de teste carregada');
            testarCarregamentoDados();
        };
    </script>
</body>
</html>
