<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Relat√≥rios de Combust√≠vel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .debug-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .log-output {
            background-color: #343a40;
            color: #fff;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üîß Teste Final - Sistema de Relat√≥rios</h1>
        
        <!-- Status de Conex√£o -->
        <div class="debug-section">
            <div class="debug-title">üì° Status de Conex√£o</div>
            <div id="statusConexao" class="alert alert-info">Verificando...</div>
        </div>

        <!-- Dados Carregados -->
        <div class="debug-section">
            <div class="debug-title">üìä Dados Carregados</div>
            <div id="statusDados" class="alert alert-secondary">Carregando...</div>
            <button class="btn btn-outline-primary btn-sm" onclick="mostrarDadosDetalhados()">Ver Dados Detalhados</button>
            <div id="dadosDetalhados" style="display: none;" class="mt-2"></div>
        </div>

        <!-- Formul√°rio de Relat√≥rio -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>üéØ Gera√ß√£o de Relat√≥rio</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="dataInicio" class="form-label">Data In√≠cio:</label>
                        <input type="date" class="form-control" id="dataInicio" value="2025-05-01">
                    </div>
                    <div class="col-md-4">
                        <label for="dataFim" class="form-label">Data Fim:</label>
                        <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                    </div>
                    <div class="col-md-4">
                        <label for="caminhaoSelect" class="form-label">Caminh√£o:</label>
                        <select class="form-select" id="caminhaoSelect">
                            <option value="todos">Todos os Caminh√µes</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="testarGeracaoRelatorio()">
                        üöÄ Gerar Relat√≥rio
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="limparLogs()">
                        üßπ Limpar Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Console de Debug -->
        <div class="debug-section">
            <div class="debug-title">üêõ Console de Debug</div>
            <div id="debugConsole" class="log-output">
                <div class="text-success">‚úÖ Console de debug inicializado...</div>
            </div>
        </div>

        <!-- Resultado do Relat√≥rio -->
        <div id="relatorioResultados" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Interceptar console.log para mostrar no debug
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addToDebugConsole(message, type = 'log') {
            const debugConsole = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-light';
            
            debugConsole.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToDebugConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToDebugConsole('‚ùå ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToDebugConsole('‚ö†Ô∏è ' + args.join(' '), 'warn');
        };

        // Vari√°veis globais
        let caminhoes = [];
        let abastecimentos = [];
        let dbApi = null;

        // Configurar API
        const API_BASE_URL = 'http://localhost:3001/api';
        
        // Objeto para simular dbApi
        window.dbApi = {
            async buscarCaminhoes() {
                console.log('üîÑ Buscando caminh√µes...');
                const response = await fetch(`${API_BASE_URL}/caminhoes`);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const data = await response.json();
                console.log('‚úÖ Caminh√µes carregados:', data.length);
                return data;
            },
            
            async buscarAbastecimentos() {
                console.log('üîÑ Buscando abastecimentos...');
                const response = await fetch(`${API_BASE_URL}/abastecimentos`);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const data = await response.json();
                console.log('‚úÖ Abastecimentos carregados:', data.length);
                return data;
            }
        };

        // Fun√ß√£o para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para criar gr√°ficos (simplificada)
        function createCustomChart(canvasId, type, labels, datasets, title, xAxisLabel, yAxisLabel) {
            console.log(`üìä Criando gr√°fico: ${title}`);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`‚ö†Ô∏è Canvas ${canvasId} n√£o encontrado`);
                return;
            }
            
            try {
                new Chart(canvas, {
                    type: type,
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: title } },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: yAxisLabel } },
                            x: { title: { display: true, text: xAxisLabel } }
                        }
                    }
                });
                console.log(`‚úÖ Gr√°fico ${title} criado com sucesso`);
            } catch (error) {
                console.error(`‚ùå Erro ao criar gr√°fico ${title}:`, error);
            }
        }

        // Fun√ß√£o principal de gera√ß√£o de relat√≥rio (copiada do arquivo original)
        async function gerarRelatorioConsumo() {
            console.log('üîÑ Iniciando gera√ß√£o de relat√≥rio de consumo...');
            
            // Mostrar loading enquanto processa
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                console.error('‚ùå Elemento relatorioResultados n√£o encontrado!');
                alert('Erro: Elemento de exibi√ß√£o do relat√≥rio n√£o encontrado.');
                return;
            }
            
            resultadosElement.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Gerando relat√≥rio...</p></div>';
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                resultadosElement.innerHTML = '<div class="alert alert-danger">Por favor, selecione o per√≠odo para o relat√≥rio.</div>';
                return;
            }

            console.log('üìÖ Per√≠odo selecionado:', dataInicio, 'at√©', dataFim);
            console.log('üöõ Caminh√£o selecionado:', caminhaoId);
            
            // Garantir que os dados est√£o carregados - for√ßar recarregamento se necess√°rio
            let dadosCaminhoes = window.caminhoes || caminhoes || [];
            let dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
            
            // Se n√£o h√° dados, tentar recarregar
            if (dadosAbastecimentos.length === 0 && typeof window.dbApi !== 'undefined') {
                console.log('‚ö†Ô∏è Dados n√£o encontrados, tentando recarregar...');
                try {
                    dadosCaminhoes = await window.dbApi.buscarCaminhoes();
                    dadosAbastecimentos = await window.dbApi.buscarAbastecimentos();
                    
                    // Atualizar globais
                    window.caminhoes = dadosCaminhoes;
                    window.abastecimentos = dadosAbastecimentos;
                    if (typeof caminhoes !== 'undefined') caminhoes = dadosCaminhoes;
                    if (typeof abastecimentos !== 'undefined') abastecimentos = dadosAbastecimentos;
                    
                    console.log('‚úÖ Dados recarregados com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao recarregar dados:', error);
                }
            }
            
            console.log('üìä Dados dispon√≠veis:', {
                caminhoes: dadosCaminhoes.length,
                abastecimentos: dadosAbastecimentos.length,
                windowCaminhoes: (window.caminhoes || []).length,
                windowAbastecimentos: (window.abastecimentos || []).length
            });
            
            if (dadosAbastecimentos.length === 0) {
                resultadosElement.innerHTML = 
                    '<div class="alert alert-warning">Nenhum abastecimento encontrado no sistema. Verifique se os dados foram carregados ou se h√° conex√£o com a API.</div>';
                return;
            }
            
            // Filtrar abastecimentos pelo per√≠odo com compara√ß√£o de data mais robusta
            let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                // Extrair apenas a parte da data (sem hor√°rio) para compara√ß√£o
                const dataAbast = a.data.split('T')[0]; // '2025-06-01'
                const dentroIntervalo = dataAbast >= dataInicio && dataAbast <= dataFim;
                
                if (!dentroIntervalo) {
                    console.log(`üîç Abastecimento ${a.id} fora do per√≠odo: ${dataAbast} (${dataInicio} - ${dataFim})`);
                }
                
                return dentroIntervalo;
            });
            
            console.log('üìã Abastecimentos filtrados por per√≠odo:', abastecimentosFiltrados.length);
            
            // Log detalhado dos abastecimentos filtrados
            abastecimentosFiltrados.forEach((a, i) => {
                console.log(`  ${i+1}. ${a.id} - ${a.data.split('T')[0]} - Caminh√£o: ${a.caminhao_id}`);
            });
            
            // Filtrar por caminh√£o se n√£o for "todos"
            if (caminhaoId !== 'todos') {
                const antesFiltroCaminhao = abastecimentosFiltrados.length;
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                console.log(`üöõ Filtro por caminh√£o ${caminhaoId}: ${antesFiltroCaminhao} ‚Üí ${abastecimentosFiltrados.length}`);
            }
            
            // Verificar se h√° dados para o relat√≥rio
            if (abastecimentosFiltrados.length === 0) {
                resultadosElement.innerHTML = 
                    '<div class="alert alert-warning">Nenhum dado encontrado para o per√≠odo e caminh√£o selecionados.<br><small class="text-muted">Per√≠odo: ' + dataInicio + ' a ' + dataFim + (caminhaoId !== 'todos' ? ' | Caminh√£o: ' + caminhaoId : '') + '</small></div>';
                return;
            }
            
            console.log('‚úÖ Iniciando processamento de', abastecimentosFiltrados.length, 'abastecimentos');
            
            // Agrupar dados por caminh√£o
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach((a, index) => {
                console.log(`üîç Processando abastecimento ${index + 1}:`, a.id);
                
                if (!dadosPorCaminhao[a.caminhao_id]) {
                    const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                    console.log('üöõ Caminh√£o encontrado:', caminhao ? `${caminhao.placa} - ${caminhao.modelo}` : 'N√£o encontrado');
                    
                    dadosPorCaminhao[a.caminhao_id] = {
                        id: a.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Adicionar dados deste abastecimento com valida√ß√£o
                const kmInicial = parseFloat(a.km_inicial || 0);
                const kmFinal = parseFloat(a.km_final || 0);
                const litros = parseFloat(a.litros || 0);
                const valorTotal = parseFloat(a.valor_total || 0);
                
                const distancia = kmFinal - kmInicial;
                
                console.log(`üìè C√°lculos: KM ${kmInicial} ‚Üí ${kmFinal} = ${distancia}km, ${litros}L, R$${valorTotal}`);
                
                dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
            });
            
            console.log('üìä Dados agrupados por caminh√£o:', Object.keys(dadosPorCaminhao).length, 'caminh√µes');
            
            // Calcular consumo m√©dio e outros indicadores
            Object.values(dadosPorCaminhao).forEach(dadosCaminhao => {
                dadosCaminhao.mediaConsumo = dadosCaminhao.totalLitros > 0 ? 
                    (dadosCaminhao.totalKm / dadosCaminhao.totalLitros).toFixed(2) : 'N/A';
                dadosCaminhao.custoMedio = dadosCaminhao.totalKm > 0 ? 
                    (dadosCaminhao.totalGasto / dadosCaminhao.totalKm).toFixed(2) : 'N/A';
                    
                console.log(`üìà ${dadosCaminhao.placa}: KM=${dadosCaminhao.totalKm}, L=${dadosCaminhao.totalLitros}, R$=${dadosCaminhao.totalGasto}, Consumo=${dadosCaminhao.mediaConsumo}, Custo/km=R$${dadosCaminhao.custoMedio}`);
            });
            
            // Gerar HTML para exibir os resultados
            let html = `
                <h4 class="mb-3">Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminh√£o</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Combust√≠vel (L)</th>
                                <th>Consumo M√©dio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Adicionar linha para cada caminh√£o
            Object.values(dadosPorCaminhao).forEach(dados => {
                console.log(`üèóÔ∏è Gerando linha para caminh√£o: ${dados.placa}`, {
                    totalKm: dados.totalKm,
                    totalLitros: dados.totalLitros,
                    totalGasto: dados.totalGasto,
                    mediaConsumo: dados.mediaConsumo,
                    custoMedio: dados.custoMedio
                });
                
                html += `
                    <tr>
                        <td>${dados.placa} - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td>${dados.totalLitros.toFixed(2)}</td>
                        <td>${dados.mediaConsumo}</td>
                        <td>R$ ${dados.totalGasto.toFixed(2)}</td>
                        <td>R$ ${dados.custoMedio}</td>
                    </tr>
                `;
            });
            
            // Fechar tabela principal
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('üìã HTML gerado:', html.length, 'caracteres');
            console.log('üìä Dados finais para exibi√ß√£o:', Object.values(dadosPorCaminhao).map(d => ({
                placa: d.placa,
                modelo: d.modelo, 
                totalKm: d.totalKm,
                totalLitros: d.totalLitros,
                totalGasto: d.totalGasto,
                mediaConsumo: d.mediaConsumo,
                custoMedio: d.custoMedio
            })));
            
            // Exibir resultados
            console.log('üñ•Ô∏è Inserindo HTML no elemento relatorioResultados...');
            resultadosElement.innerHTML = html;
            console.log('‚úÖ Relat√≥rio exibido com sucesso!');
            console.log('üîç Conte√∫do final do elemento:', resultadosElement.innerHTML.substring(0, 200) + '...');
        }

        // Fun√ß√µes de teste
        async function verificarConexao() {
            const statusElement = document.getElementById('statusConexao');
            try {
                const response = await fetch(`${API_BASE_URL}/caminhoes`);
                if (response.ok) {
                    statusElement.className = 'alert alert-success';
                    statusElement.innerHTML = '‚úÖ Conex√£o com backend OK (porta 3001)';
                    return true;
                } else {
                    throw new Error(`Status HTTP: ${response.status}`);
                }
            } catch (error) {
                statusElement.className = 'alert alert-danger';
                statusElement.innerHTML = `‚ùå Erro de conex√£o: ${error.message}`;
                return false;
            }
        }

        async function carregarDados() {
            const statusElement = document.getElementById('statusDados');
            const caminhaoSelect = document.getElementById('caminhaoSelect');
            
            try {
                console.log('üîÑ Carregando dados...');
                
                // Carregar caminh√µes
                caminhoes = await window.dbApi.buscarCaminhoes();
                window.caminhoes = caminhoes;
                
                // Carregar abastecimentos
                abastecimentos = await window.dbApi.buscarAbastecimentos();
                window.abastecimentos = abastecimentos;
                
                // Atualizar interface
                statusElement.className = 'alert alert-success';
                statusElement.innerHTML = `‚úÖ Dados carregados: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`;
                
                // Popular select de caminh√µes
                caminhaoSelect.innerHTML = '<option value="todos">Todos os Caminh√µes</option>';
                caminhoes.forEach(c => {
                    caminhaoSelect.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });
                
                console.log('‚úÖ Dados carregados e interface atualizada');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                statusElement.className = 'alert alert-danger';
                statusElement.innerHTML = `‚ùå Erro: ${error.message}`;
                return false;
            }
        }

        function mostrarDadosDetalhados() {
            const detailsElement = document.getElementById('dadosDetalhados');
            
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>üöõ Caminh√µes (${caminhoes.length})</h6>
                        <ul class="list-group list-group-flush small">
                            ${caminhoes.map(c => `<li class="list-group-item">${c.placa} - ${c.modelo} (${c.motorista})</li>`).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>‚õΩ Abastecimentos (${abastecimentos.length})</h6>
                        <ul class="list-group list-group-flush small">
                            ${abastecimentos.map(a => `<li class="list-group-item">${a.placa} - ${a.data.split('T')[0]} - ${a.km_inicial}‚Üí${a.km_final}km - ${a.litros}L - R$${a.valor_total}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            detailsElement.innerHTML = html;
            detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
        }

        async function testarGeracaoRelatorio() {
            console.log('üöÄ Iniciando teste de gera√ß√£o de relat√≥rio...');
            await gerarRelatorioConsumo();
        }

        function limparLogs() {
            document.getElementById('debugConsole').innerHTML = '<div class="text-success">‚úÖ Console de debug limpo...</div>';
        }

        // Inicializa√ß√£o
        async function inicializar() {
            console.log('üîÑ Inicializando sistema de testes...');
            
            const conexaoOk = await verificarConexao();
            if (conexaoOk) {
                await carregarDados();
            }
            
            console.log('‚úÖ Sistema inicializado');
        }

        // Executar inicializa√ß√£o quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>
