<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Relat√≥rio de Consumo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .debug-step {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-left: 3px solid #007bff;
            background-color: #e7f3ff;
        }
        .debug-error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .debug-success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .console-output {
            background-color: #343a40;
            color: #fff;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">üîç Debug Relat√≥rio de Consumo</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="debug-panel">
                    <h4>üéõÔ∏è Controles de Teste</h4>
                    
                    <div class="mb-3">
                        <label for="dataInicio" class="form-label">Data In√≠cio:</label>
                        <input type="date" class="form-control" id="dataInicio" value="2024-01-01">
                    </div>
                    
                    <div class="mb-3">
                        <label for="dataFim" class="form-label">Data Fim:</label>
                        <input type="date" class="form-control" id="dataFim" value="2024-12-31">
                    </div>
                    
                    <div class="mb-3">
                        <label for="caminhaoSelect" class="form-label">Caminh√£o:</label>
                        <select class="form-select" id="caminhaoSelect">
                            <option value="todos">Todos os caminh√µes</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testarRelatorio()">üöÄ Gerar Relat√≥rio</button>
                    <button class="btn btn-secondary" onclick="verificarDados()">üìä Verificar Dados</button>
                    <button class="btn btn-info" onclick="testarAPI()">üîó Testar API</button>
                    <button class="btn btn-warning" onclick="limparConsole()">üßπ Limpar Console</button>
                </div>
                
                <div class="debug-panel">
                    <h4>üìã Status do Sistema</h4>
                    <div id="statusSistema">Aguardando verifica√ß√£o...</div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="debug-panel">
                    <h4>üì± Console Output</h4>
                    <div class="console-output" id="consoleOutput">Aguardando logs...</div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="debug-panel">
                    <h4>üìä Resultado do Relat√≥rio</h4>
                    <div id="relatorioResultados">Nenhum relat√≥rio gerado ainda...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Interceptar console.log para exibir no HTML
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function logToHTML(message, type = 'log') {
            const consoleOutput = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            consoleOutput.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToHTML(args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToHTML(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToHTML(args.join(' '), 'warn');
        };
        
        // Vari√°veis globais simuladas
        let caminhoes = [];
        let abastecimentos = [];
        
        // Fun√ß√£o para limpar console
        function limparConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
            console.log('Console limpo!');
        }
        
        // Fun√ß√£o para testar API
        async function testarAPI() {
            console.log('üîó Testando conex√£o com APIs...');
            
            try {
                // Testar API de caminh√µes
                const responseCaminhoes = await fetch('http://localhost:3001/api/caminhoes');
                if (responseCaminhoes.ok) {
                    caminhoes = await responseCaminhoes.json();
                    console.log('‚úÖ API Caminh√µes OK:', caminhoes.length, 'caminh√µes carregados');
                    
                    // Atualizar select de caminh√µes
                    const select = document.getElementById('caminhaoSelect');
                    select.innerHTML = '<option value="todos">Todos os caminh√µes</option>';
                    caminhoes.forEach(c => {
                        select.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                    });
                } else {
                    console.error('‚ùå Erro ao carregar caminh√µes:', responseCaminhoes.status);
                }
                
                // Testar API de abastecimentos
                const responseAbastecimentos = await fetch('http://localhost:3001/api/abastecimentos');
                if (responseAbastecimentos.ok) {
                    abastecimentos = await responseAbastecimentos.json();
                    console.log('‚úÖ API Abastecimentos OK:', abastecimentos.length, 'abastecimentos carregados');
                    console.log('üîç Estrutura dos dados:', abastecimentos[0] || 'Nenhum abastecimento');
                } else {
                    console.error('‚ùå Erro ao carregar abastecimentos:', responseAbastecimentos.status);
                }
                
                atualizarStatus();
            } catch (error) {
                console.error('‚ùå Erro na conex√£o com API:', error.message);
            }
        }
        
        // Fun√ß√£o para verificar dados
        function verificarDados() {
            console.log('üìä Verificando dados carregados...');
            console.log('Caminh√µes:', caminhoes.length);
            console.log('Abastecimentos:', abastecimentos.length);
            
            if (abastecimentos.length > 0) {
                const primeiro = abastecimentos[0];
                console.log('üîç Estrutura do primeiro abastecimento:', {
                    id: primeiro.id,
                    caminhao_id: primeiro.caminhao_id,
                    data: primeiro.data,
                    km_inicial: primeiro.km_inicial,
                    km_final: primeiro.km_final,
                    litros: primeiro.litros,
                    valor_total: primeiro.valor_total,
                    motorista: primeiro.motorista
                });
            }
            
            atualizarStatus();
        }
        
        // Fun√ß√£o para atualizar status
        function atualizarStatus() {
            const statusDiv = document.getElementById('statusSistema');
            statusDiv.innerHTML = `
                <div class="debug-step debug-success">‚úÖ Caminh√µes: ${caminhoes.length}</div>
                <div class="debug-step debug-success">‚úÖ Abastecimentos: ${abastecimentos.length}</div>
                <div class="debug-step">üìÖ Per√≠odo: ${document.getElementById('dataInicio').value} - ${document.getElementById('dataFim').value}</div>
                <div class="debug-step">üöõ Caminh√£o: ${document.getElementById('caminhaoSelect').selectedOptions[0]?.text || 'Nenhum'}</div>
            `;
        }
        
        // Fun√ß√£o principal de teste do relat√≥rio
        async function testarRelatorio() {
            console.log('üöÄ Iniciando teste completo do relat√≥rio...');
            
            if (caminhoes.length === 0 || abastecimentos.length === 0) {
                console.warn('‚ö†Ô∏è Dados n√£o carregados. Carregando APIs primeiro...');
                await testarAPI();
            }
            
            // Usar a fun√ß√£o original do relat√≥rio
            gerarRelatorioConsumo();
        }
        
        // Fun√ß√£o de formata√ß√£o de datas
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        // Fun√ß√£o original do relat√≥rio (copiada e adaptada)
        function gerarRelatorioConsumo() {
            console.log('üîÑ Iniciando gera√ß√£o de relat√≥rio de consumo...');
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                console.error('‚ùå Datas n√£o selecionadas');
                alert('Por favor, selecione o per√≠odo para o relat√≥rio.');
                return;
            }

            console.log('üìÖ Per√≠odo selecionado:', dataInicio, 'at√©', dataFim);
            console.log('üöõ Caminh√£o selecionado:', caminhaoId);
            
            // Usar dados globais
            const dadosCaminhoes = caminhoes;
            const dadosAbastecimentos = abastecimentos;
            
            console.log('üìä Dados dispon√≠veis:', {
                caminhoes: dadosCaminhoes.length,
                abastecimentos: dadosAbastecimentos.length
            });
            
            if (dadosAbastecimentos.length === 0) {
                const resultadosElement = document.getElementById('relatorioResultados');
                resultadosElement.innerHTML = '<div class="alert alert-warning">Nenhum abastecimento encontrado no sistema. Verifique se os dados foram carregados.</div>';
                console.warn('‚ö†Ô∏è Nenhum abastecimento dispon√≠vel');
                return;
            }
            
            // Filtrar abastecimentos pelo per√≠odo
            let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                return a.data >= dataInicio && a.data <= dataFim;
            });
            
            console.log('üìã Abastecimentos filtrados por per√≠odo:', abastecimentosFiltrados.length);
            
            // Filtrar por caminh√£o se n√£o for "todos"
            if (caminhaoId !== 'todos') {
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                console.log('üöõ Abastecimentos filtrados por caminh√£o:', abastecimentosFiltrados.length);
            }
            
            // Verificar se h√° dados para o relat√≥rio
            if (abastecimentosFiltrados.length === 0) {
                const resultadosElement = document.getElementById('relatorioResultados');
                resultadosElement.innerHTML = '<div class="alert alert-warning">Nenhum dado encontrado para o per√≠odo e caminh√£o selecionados.</div>';
                console.warn('‚ö†Ô∏è Nenhum abastecimento no per√≠odo/caminh√£o selecionado');
                return;
            }
            
            console.log('‚úÖ Iniciando processamento de', abastecimentosFiltrados.length, 'abastecimentos');
            
            // Agrupar dados por caminh√£o
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach((a, index) => {
                console.log(`üîç Processando abastecimento ${index + 1}:`, a.id);
                
                if (!dadosPorCaminhao[a.caminhao_id]) {
                    const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                    console.log('üöõ Caminh√£o encontrado:', caminhao ? `${caminhao.placa} - ${caminhao.modelo}` : 'N√£o encontrado');
                    
                    dadosPorCaminhao[a.caminhao_id] = {
                        id: a.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Adicionar dados deste abastecimento com valida√ß√£o
                const kmInicial = parseFloat(a.km_inicial || 0);
                const kmFinal = parseFloat(a.km_final || 0);
                const litros = parseFloat(a.litros || 0);
                const valorTotal = parseFloat(a.valor_total || 0);
                
                const distancia = kmFinal - kmInicial;
                
                console.log(`üìè C√°lculos abastecimento ${a.id}:`, {
                    kmInicial, 
                    kmFinal, 
                    distancia, 
                    litros, 
                    valorTotal
                });
                
                dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
            });
            
            console.log('üìä Dados agrupados por caminh√£o:', Object.keys(dadosPorCaminhao).length, 'caminh√µes');
            
            // Calcular consumo m√©dio e outros indicadores
            Object.values(dadosPorCaminhao).forEach(dadosCaminhao => {
                dadosCaminhao.mediaConsumo = dadosCaminhao.totalLitros > 0 ? 
                    (dadosCaminhao.totalKm / dadosCaminhao.totalLitros).toFixed(2) : 'N/A';
                dadosCaminhao.custoMedio = dadosCaminhao.totalKm > 0 ? 
                    (dadosCaminhao.totalGasto / dadosCaminhao.totalKm).toFixed(2) : 'N/A';
                    
                console.log(`üìà Dados finais ${dadosCaminhao.placa}:`, {
                    totalKm: dadosCaminhao.totalKm,
                    totalLitros: dadosCaminhao.totalLitros, 
                    totalGasto: dadosCaminhao.totalGasto,
                    mediaConsumo: dadosCaminhao.mediaConsumo,
                    custoMedio: dadosCaminhao.custoMedio
                });
            });
            
            // Gerar HTML para exibir os resultados
            console.log('üé® Gerando HTML do relat√≥rio...');
            
            let html = `
                <h4 class="mb-3">Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminh√£o</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Combust√≠vel (L)</th>
                                <th>Consumo M√©dio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Adicionar linha para cada caminh√£o
            Object.values(dadosPorCaminhao).forEach(dados => {
                console.log(`üîß Adicionando linha para caminh√£o:`, dados.placa, dados);
                
                html += `
                    <tr>
                        <td>${dados.placa} - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td>${dados.totalLitros.toFixed(2)}</td>
                        <td>${dados.mediaConsumo}</td>
                        <td>R$ ${dados.totalGasto.toFixed(2)}</td>
                        <td>R$ ${dados.custoMedio}</td>
                    </tr>
                `;
            });
            
            // Fechar tabela principal
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('üìã HTML gerado com sucesso. Tamanho:', html.length, 'caracteres');
            console.log('üîç Preview HTML (primeiros 500 chars):', html.substring(0, 500));
            
            // Exibir resultados
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                console.error('‚ùå Elemento relatorioResultados n√£o encontrado!');
                alert('Erro: Elemento de exibi√ß√£o do relat√≥rio n√£o encontrado.');
                return;
            }
            
            console.log('üì• Inserindo HTML no elemento relatorioResultados...');
            resultadosElement.innerHTML = html;
            console.log('‚úÖ Relat√≥rio exibido com sucesso!');
            
            // Verificar se o conte√∫do foi realmente inserido
            setTimeout(() => {
                const conteudoInserido = resultadosElement.innerHTML;
                console.log('üîç Verifica√ß√£o p√≥s-inser√ß√£o:', {
                    tamanhoHTML: conteudoInserido.length,
                    temTabela: conteudoInserido.includes('<table'),
                    temDados: conteudoInserido.includes('Caminh√£o'),
                    preview: conteudoInserido.substring(0, 200)
                });
            }, 100);
        }
        
        // Carregar dados ao inicializar
        window.addEventListener('load', () => {
            console.log('üåü P√°gina carregada. Testando APIs...');
            testarAPI();
        });
    </script>
</body>
</html>
