<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste Espec√≠fico - Problema do Relat√≥rio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section { border: 2px solid #007bff; margin: 10px 0; padding: 15px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Teste Espec√≠fico - Problema dos Dados do Relat√≥rio</h1>
        
        <div class="debug-section success">
            <h3>üìä Status dos Dados</h3>
            <div id="status-dados">Carregando...</div>
        </div>
        
        <div class="debug-section">
            <h3>üéØ Teste do Relat√≥rio</h3>
            <div class="row">
                <div class="col-md-4">
                    <label>Data In√≠cio:</label>
                    <input type="date" id="dataInicio" class="form-control" value="2025-01-01">
                </div>
                <div class="col-md-4">
                    <label>Data Fim:</label>
                    <input type="date" id="dataFim" class="form-control" value="2025-12-31">
                </div>
                <div class="col-md-4">
                    <label>Caminh√£o:</label>
                    <select id="caminhaoSelect" class="form-control">
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="executarTesteCompleto()">üöÄ Executar Teste Completo</button>
        </div>
        
        <div class="debug-section" id="resultado-processamento" style="display: none;">
            <h3>üîç Resultado do Processamento</h3>
            <div id="detalhes-processamento"></div>
        </div>
        
        <div class="debug-section">
            <h3>üìã Relat√≥rio Final</h3>
            <div id="relatorioResultados"></div>
        </div>
        
        <div class="debug-section">
            <h3>üîß Debug Console</h3>
            <div id="debug-console" style="background: #f8f9fa; padding: 10px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let caminhoes = [];
        let abastecimentos = [];
        
        // Interceptar console.log para mostrar na p√°gina
        const originalLog = console.log;
        const debugConsole = document.getElementById('debug-console');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (debugConsole) {
                debugConsole.textContent += args.join(' ') + '\n';
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        };

        async function carregarDados() {
            try {
                console.log('üîÑ Carregando dados da API...');
                
                const [caminhoesResponse, abastecimentosResponse] = await Promise.all([
                    fetch('http://localhost:3001/api/caminhoes'),
                    fetch('http://localhost:3001/api/abastecimentos')
                ]);

                caminhoes = await caminhoesResponse.json();
                abastecimentos = await abastecimentosResponse.json();

                // Atualizar vari√°veis globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;

                console.log('‚úÖ Dados carregados:', {
                    caminhoes: caminhoes.length,
                    abastecimentos: abastecimentos.length
                });

                // Atualizar status na p√°gina
                document.getElementById('status-dados').innerHTML = `
                    <p>‚úÖ <strong>Caminh√µes:</strong> ${caminhoes.length}</p>
                    <p>‚úÖ <strong>Abastecimentos:</strong> ${abastecimentos.length}</p>
                `;

                // Preencher select de caminh√µes
                const select = document.getElementById('caminhaoSelect');
                select.innerHTML = '<option value="todos">Todos os Caminh√µes</option>';
                caminhoes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });

                console.log('üìã Dados de exemplo:', {
                    caminhao: caminhoes[0],
                    abastecimento: abastecimentos[0]
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('status-dados').innerHTML = '‚ùå Erro ao carregar dados';
            }
        }

        async function executarTesteCompleto() {
            console.log('\nüöÄ ===== INICIANDO TESTE COMPLETO =====');
            
            const resultadoDiv = document.getElementById('resultado-processamento');
            const detalhesDiv = document.getElementById('detalhes-processamento');
            
            resultadoDiv.style.display = 'block';
            
            try {
                // Executar a mesma l√≥gica da fun√ß√£o gerarRelatorioConsumo
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const caminhaoId = document.getElementById('caminhaoSelect').value;
                
                console.log('üìÖ Par√¢metros:', { dataInicio, dataFim, caminhaoId });
                
                // Validar datas
                if (!dataInicio || !dataFim) {
                    throw new Error('Datas n√£o informadas');
                }

                // Acessar dados de forma robusta
                const dadosCaminhoes = window.caminhoes || caminhoes || [];
                const dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
                
                console.log('üìä Dados dispon√≠veis:', {
                    caminhoes: dadosCaminhoes.length,
                    abastecimentos: dadosAbastecimentos.length
                });
                
                if (dadosAbastecimentos.length === 0) {
                    throw new Error('Nenhum abastecimento encontrado');
                }
                
                // Filtrar abastecimentos pelo per√≠odo
                let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                    return a.data >= dataInicio && a.data <= dataFim;
                });
                
                console.log('üìã Abastecimentos filtrados:', abastecimentosFiltrados.length);
                
                // Filtrar por caminh√£o se necess√°rio
                if (caminhaoId !== 'todos') {
                    abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                    console.log('üöõ Filtrados por caminh√£o:', abastecimentosFiltrados.length);
                }
                
                if (abastecimentosFiltrados.length === 0) {
                    throw new Error('Nenhum abastecimento no per√≠odo selecionado');
                }
                
                // Processar dados
                const dadosPorCaminhao = {};
                
                abastecimentosFiltrados.forEach((a, index) => {
                    console.log(`üîç Processando ${index + 1}/${abastecimentosFiltrados.length}: ${a.id}`);
                    
                    if (!dadosPorCaminhao[a.caminhao_id]) {
                        const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                        console.log('üöõ Caminh√£o:', caminhao ? `${caminhao.placa} - ${caminhao.modelo}` : 'N√£o encontrado');
                        
                        dadosPorCaminhao[a.caminhao_id] = {
                            id: a.caminhao_id,
                            placa: caminhao ? caminhao.placa : 'Desconhecido',
                            modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                            totalKm: 0,
                            totalLitros: 0,
                            totalGasto: 0,
                            abastecimentos: []
                        };
                    }
                    
                    // Processar valores com valida√ß√£o
                    const kmInicial = parseFloat(a.km_inicial || 0);
                    const kmFinal = parseFloat(a.km_final || 0);
                    const litros = parseFloat(a.litros || 0);
                    const valorTotal = parseFloat(a.valor_total || 0);
                    
                    const distancia = kmFinal - kmInicial;
                    
                    console.log(`üìè ${a.id}: KM ${kmInicial}‚Üí${kmFinal} = ${distancia}km, ${litros}L, R$${valorTotal}`);
                    
                    dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                    dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                    dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                    dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
                });
                
                // Calcular m√©tricas
                Object.values(dadosPorCaminhao).forEach(dados => {
                    dados.mediaConsumo = dados.totalLitros > 0 ? 
                        (dados.totalKm / dados.totalLitros).toFixed(2) : 'N/A';
                    dados.custoMedio = dados.totalKm > 0 ? 
                        (dados.totalGasto / dados.totalKm).toFixed(2) : 'N/A';
                        
                    console.log(`üìà RESULTADO ${dados.placa}: KM=${dados.totalKm}, L=${dados.totalLitros}, R$=${dados.totalGasto}, Consumo=${dados.mediaConsumo}km/L, Custo=R$${dados.custoMedio}/km`);
                });
                
                // Gerar HTML da tabela
                let html = `
                    <div class="alert alert-success">‚úÖ Processamento conclu√≠do com sucesso!</div>
                    <h4>Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>Caminh√£o</th>
                                    <th>Dist√¢ncia (km)</th>
                                    <th>Combust√≠vel (L)</th>
                                    <th>Consumo M√©dio (km/l)</th>
                                    <th>Gasto Total (R$)</th>
                                    <th>Custo por km (R$)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Adicionar linhas da tabela
                Object.values(dadosPorCaminhao).forEach(dados => {
                    html += `
                        <tr>
                            <td><strong>${dados.placa}</strong><br><small>${dados.modelo}</small></td>
                            <td class="text-end">${dados.totalKm.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                            <td class="text-end">${dados.totalLitros.toFixed(2)}</td>
                            <td class="text-end"><span class="badge bg-info">${dados.mediaConsumo}</span></td>
                            <td class="text-end"><strong>R$ ${dados.totalGasto.toFixed(2)}</strong></td>
                            <td class="text-end"><span class="badge bg-warning">R$ ${dados.custoMedio}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                console.log('üìã HTML gerado com sucesso');
                
                // Mostrar detalhes do processamento
                detalhesDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ Teste Conclu√≠do com Sucesso!</h5>
                        <ul>
                            <li><strong>Caminh√µes processados:</strong> ${Object.keys(dadosPorCaminhao).length}</li>
                            <li><strong>Abastecimentos processados:</strong> ${abastecimentosFiltrados.length}</li>
                            <li><strong>Per√≠odo:</strong> ${dataInicio} a ${dataFim}</li>
                        </ul>
                    </div>
                `;
                
                // Inserir no DOM
                document.getElementById('relatorioResultados').innerHTML = html;
                
                console.log('‚úÖ Relat√≥rio exibido com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                detalhesDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Erro no Teste</h5>
                        <p><strong>Mensagem:</strong> ${error.message}</p>
                        <p><strong>Stack:</strong> ${error.stack}</p>
                    </div>
                `;
            }
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('pt-BR');
        }
        
        // Inicializar
        window.onload = function() {
            carregarDados();
        };
    </script>
</body>
</html>
