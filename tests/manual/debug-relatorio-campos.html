<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debugging de Relatório</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #console {
            background-color: #1e1e1e;
            color: #dcdcdc;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Debugging de Relatórios</h1>
        
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Console</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearConsole()">Limpar</button>
                    </div>
                    <div class="card-body">
                        <div id="console"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Relatório de Consumo</h5>
                    </div>
                    <div class="card-body">
                        <form id="relatorioForm" class="row g-3">
                            <div class="col-md-4">
                                <label for="dataInicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="dataInicio" value="2025-01-01">
                            </div>
                            <div class="col-md-4">
                                <label for="dataFim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                            </div>
                            <div class="col-md-4">
                                <label for="caminhaoSelect" class="form-label">Caminhão</label>
                                <select class="form-select" id="caminhaoSelect">
                                    <option value="todos">Todos os caminhões</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Gerar Relatório</button>
                                <button type="button" class="btn btn-secondary" onclick="inspecionarDados()">Inspecionar Dados</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="data-display">
            <h5>Dados Carregados:</h5>
            <div id="dataInfo"></div>
        </div>
        
        <div id="relatorioResultados"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Simular console.log para exibir no elemento console
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addToConsole(message, type = 'log') {
            const consoleElement = document.getElementById('console');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            if (typeof message === 'object') {
                message = JSON.stringify(message, null, 2);
            }
            
            const colors = {
                log: '#dcdcdc',
                error: '#ff6b6b',
                warn: '#feca57',
                debug: '#54a0ff'
            };
            
            logEntry.innerHTML = `<span style="color: ${colors[type] || colors.log}">[${type.toUpperCase()}] ${message}</span>`;
            consoleElement.appendChild(logEntry);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        console.log = function(message) {
            originalConsoleLog.apply(console, arguments);
            addToConsole(message, 'log');
        };
        
        console.error = function(message) {
            originalConsoleError.apply(console, arguments);
            addToConsole(message, 'error');
        };
        
        console.warn = function(message) {
            originalConsoleWarn.apply(console, arguments);
            addToConsole(message, 'warn');
        };
        
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        
        // Variáveis globais para caminhões e abastecimentos
        let caminhoes = [];
        let abastecimentos = [];
        
        // Disponibilizar dados globalmente
        window.caminhoes = caminhoes;
        window.abastecimentos = abastecimentos;
        
        // API_BASE_URL
        const API_BASE_URL = 'http://localhost:3001/api';
        
        // Criar objeto dbApi para simular a API real
        window.dbApi = {
            async buscarCaminhoes() {
                console.log('Buscando caminhões da API...');
                const response = await fetch(`${API_BASE_URL}/caminhoes`);
                const data = await response.json();
                console.log(`Caminhões carregados: ${data.length}`);
                return data;
            },
            
            async buscarAbastecimentos() {
                console.log('Buscando abastecimentos da API...');
                const response = await fetch(`${API_BASE_URL}/abastecimentos`);
                const data = await response.json();
                console.log(`Abastecimentos carregados: ${data.length}`);
                return data;
            }
        };
        
        // Função para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        // Função para criar gráfico
        function createCustomChart(canvasId, type, labels, datasets, title, xAxisLabel, yAxisLabel) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Canvas ${canvasId} não encontrado`);
                return;
            }
            
            new Chart(canvas, {
                type: type,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: title } },
                    scales: {
                        y: { title: { display: true, text: yAxisLabel } },
                        x: { title: { display: true, text: xAxisLabel } }
                    }
                }
            });
        }
        
        // Função para carregar dados
        async function carregarDados() {
            try {
                // Buscar dados da API
                caminhoes = await window.dbApi.buscarCaminhoes();
                abastecimentos = await window.dbApi.buscarAbastecimentos();
                
                // Atualizar variáveis globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;
                
                // Popular select de caminhões
                const caminhaoSelect = document.getElementById('caminhaoSelect');
                caminhaoSelect.innerHTML = '<option value="todos">Todos os caminhões</option>';
                
                caminhoes.forEach(caminhao => {
                    const option = document.createElement('option');
                    option.value = caminhao.id;
                    option.textContent = `${caminhao.placa} - ${caminhao.modelo}`;
                    caminhaoSelect.appendChild(option);
                });
                
                // Exibir informações sobre os dados
                atualizarInfoDados();
                
                console.log('Dados carregados com sucesso');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }
        
        // Função para atualizar informações dos dados
        function atualizarInfoDados() {
            const dataInfo = document.getElementById('dataInfo');
            dataInfo.innerHTML = `
                <p><strong>Caminhões:</strong> ${caminhoes.length}</p>
                <p><strong>Abastecimentos:</strong> ${abastecimentos.length}</p>
            `;
        }
        
        // Função para inspecionar os dados
        function inspecionarDados() {
            console.log('=== INSPEÇÃO DE DADOS ===');
            console.log('Caminhões:', caminhoes);
            console.log('Abastecimentos:', abastecimentos);
            
            if (abastecimentos.length > 0) {
                console.log('Estrutura de um abastecimento:', abastecimentos[0]);
                console.log('Campos do abastecimento:', Object.keys(abastecimentos[0]).join(', '));
            }
            
            if (caminhoes.length > 0) {
                console.log('Estrutura de um caminhão:', caminhoes[0]);
                console.log('Campos do caminhão:', Object.keys(caminhoes[0]).join(', '));
            }
        }
        
        // Função para gerar relatório
        async function gerarRelatorioConsumo() {
            console.log('🔄 Iniciando geração de relatório de consumo...');
            
            // Mostrar loading enquanto processa
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                console.error('❌ Elemento relatorioResultados não encontrado!');
                alert('Erro: Elemento de exibição do relatório não encontrado.');
                return;
            }
            
            resultadosElement.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Gerando relatório...</p></div>';
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                resultadosElement.innerHTML = '<div class="alert alert-danger">Por favor, selecione o período para o relatório.</div>';
                return;
            }

            console.log('📅 Período selecionado:', dataInicio, 'até', dataFim);
            console.log('🚛 Caminhão selecionado:', caminhaoId);
            
            // Garantir que os dados estão carregados
            let dadosCaminhoes = window.caminhoes || caminhoes || [];
            let dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
            
            console.log('📊 Dados disponíveis:', {
                caminhoes: dadosCaminhoes.length,
                abastecimentos: dadosAbastecimentos.length
            });
            
            if (dadosAbastecimentos.length === 0) {
                resultadosElement.innerHTML = 
                    '<div class="alert alert-warning">Nenhum abastecimento encontrado no sistema.</div>';
                return;
            }
            
            // Exibir os primeiros abastecimentos para debug
            console.log('Amostra de abastecimentos:', dadosAbastecimentos.slice(0, 2));
            
            // Filtrar abastecimentos pelo período
            let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                // Extrair apenas a parte da data (sem horário) para comparação
                const dataAbast = a.data.split('T')[0]; // '2025-06-01'
                const dentroIntervalo = dataAbast >= dataInicio && dataAbast <= dataFim;
                return dentroIntervalo;
            });
            
            console.log('📋 Abastecimentos filtrados por período:', abastecimentosFiltrados.length);
            
            // Filtrar por caminhão se não for "todos"
            if (caminhaoId !== 'todos') {
                const antesFiltroCaminhao = abastecimentosFiltrados.length;
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                console.log(`🚛 Filtro por caminhão ${caminhaoId}: ${antesFiltroCaminhao} → ${abastecimentosFiltrados.length}`);
            }
            
            // Verificar se há dados para o relatório
            if (abastecimentosFiltrados.length === 0) {
                resultadosElement.innerHTML = 
                    '<div class="alert alert-warning">Nenhum dado encontrado para o período e caminhão selecionados.</div>';
                return;
            }
            
            console.log('✅ Iniciando processamento de', abastecimentosFiltrados.length, 'abastecimentos');
            
            // Agrupar dados por caminhão
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach((a, index) => {
                console.log(`🔍 Processando abastecimento ${index + 1}:`, a.id, a);
                
                if (!dadosPorCaminhao[a.caminhao_id]) {
                    const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                    console.log('🚛 Caminhão encontrado:', caminhao);
                    
                    dadosPorCaminhao[a.caminhao_id] = {
                        id: a.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Adicionar dados deste abastecimento com validação
                const kmInicial = parseFloat(a.km_inicial || 0);
                const kmFinal = parseFloat(a.km_final || 0);
                const litros = parseFloat(a.litros || 0);
                const valorTotal = parseFloat(a.valor_total || 0);
                
                const distancia = kmFinal - kmInicial;
                
                console.log(`📏 Cálculos: KM ${kmInicial} → ${kmFinal} = ${distancia}km, ${litros}L, R$${valorTotal}`);
                
                dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
            });
            
            console.log('📊 Dados agrupados por caminhão:', Object.keys(dadosPorCaminhao).length, 'caminhões');
            console.log('Dados processados:', dadosPorCaminhao);
            
            // Calcular consumo médio e outros indicadores
            Object.values(dadosPorCaminhao).forEach(dadosCaminhao => {
                dadosCaminhao.mediaConsumo = dadosCaminhao.totalLitros > 0 ? 
                    (dadosCaminhao.totalKm / dadosCaminhao.totalLitros).toFixed(2) : 'N/A';
                dadosCaminhao.custoMedio = dadosCaminhao.totalKm > 0 ? 
                    (dadosCaminhao.totalGasto / dadosCaminhao.totalKm).toFixed(2) : 'N/A';
                    
                console.log(`📈 ${dadosCaminhao.placa}: KM=${dadosCaminhao.totalKm}, L=${dadosCaminhao.totalLitros}, R$=${dadosCaminhao.totalGasto}, Consumo=${dadosCaminhao.mediaConsumo}, Custo/km=R$${dadosCaminhao.custoMedio}`);
            });
            
            // Gerar HTML para exibir os resultados
            let html = `
                <h4 class="mb-3">Relatório de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminhão</th>
                                <th>Distância (km)</th>
                                <th>Combustível (L)</th>
                                <th>Consumo Médio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Adicionar linha para cada caminhão
            Object.values(dadosPorCaminhao).forEach(dados => {
                console.log("Gerando linha HTML para:", dados);
                html += `
                    <tr>
                        <td>${dados.placa} - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td>${dados.totalLitros.toFixed(2)}</td>
                        <td>${dados.mediaConsumo}</td>
                        <td>R$ ${dados.totalGasto.toFixed(2)}</td>
                        <td>R$ ${dados.custoMedio}</td>
                    </tr>
                `;
            });
            
            // Fechar tabela principal
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('📋 HTML gerado:', html.substring(0, 500) + '...');
            
            // Exibir resultados
            resultadosElement.innerHTML = html;
            console.log('✅ Relatório exibido com sucesso!');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarDados();
            
            document.getElementById('relatorioForm').addEventListener('submit', (e) => {
                e.preventDefault();
                gerarRelatorioConsumo();
            });
        });
    </script>
</body>
</html>
