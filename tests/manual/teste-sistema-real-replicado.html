<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sistema Real Replicado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-console {
            background: #2d3748;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center my-4">üîß Teste Sistema Real - Relat√≥rios</h1>
        
        <!-- Se√ß√£o de Relat√≥rios (replicada do sistema real) -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Relat√≥rio de Consumo</h5>
                    </div>
                    <div class="card-body">
                        <form id="relatorioConsumoForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="dataInicio" class="form-label">Data In√≠cio</label>
                                    <input type="date" class="form-control" id="dataInicio" value="2025-05-01">
                                </div>
                                <div class="col-md-6">
                                    <label for="dataFim" class="form-label">Data Fim</label>
                                    <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                                </div>
                                <div class="col-12">
                                    <label for="caminhaoSelect" class="form-label">Caminh√£o</label>
                                    <select class="form-select" id="caminhaoSelect">
                                        <option value="todos">Todos os caminh√µes</option>
                                        <!-- Op√ß√µes ser√£o adicionadas via JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">Gerar Relat√≥rio</button>
                                <button type="button" class="btn btn-outline-info ms-2" onclick="mostrarDadosDebug()">Debug</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Status do Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusSistema" class="alert alert-info">Carregando...</div>
                        <div id="statusDados" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados do Relat√≥rio -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resultados do Relat√≥rio</h5>
                    </div>
                    <div class="card-body">
                        <div id="relatorioResultados">
                            <p class="text-center text-muted">Clique em "Gerar Relat√≥rio" para visualizar os resultados.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>üêõ Debug Console</strong>
            <button class="btn btn-sm btn-outline-secondary" onclick="limparDebug()">Limpar</button>
        </div>
        <div id="debugConsole" class="debug-console">
            <div style="color: #68d391;">‚úÖ Sistema inicializado</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // === VARI√ÅVEIS GLOBAIS (simulando o sistema real) ===
        let caminhoes = [];
        let abastecimentos = [];
        let dbApi = null;

        // === DEBUG FUNCTIONS ===
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addDebugMessage(msg, tipo = 'log') {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                log: '#e2e8f0',
                error: '#fc8181', 
                warn: '#f6ad55',
                success: '#68d391',
                info: '#63b3ed'
            };
            
            console.innerHTML += `<div style="color: ${colors[tipo] || colors.log}">[${timestamp}] ${msg}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addDebugMessage(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addDebugMessage('‚ùå ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addDebugMessage('‚ö†Ô∏è ' + args.join(' '), 'warn');
        };

        function limparDebug() {
            document.getElementById('debugConsole').innerHTML = '<div style="color: #68d391;">‚úÖ Console limpo</div>';
        }

        // === API CONFIGURATION ===
        const API_BASE_URL = 'http://localhost:3001/api';

        window.dbApi = {
            async buscarCaminhoes() {
                console.log('üîÑ API: Buscando caminh√µes...');
                const response = await fetch(`${API_BASE_URL}/caminhoes`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('‚úÖ API: Caminh√µes carregados:', data.length);
                return data;
            },
            
            async buscarAbastecimentos() {
                console.log('üîÑ API: Buscando abastecimentos...');
                const response = await fetch(`${API_BASE_URL}/abastecimentos`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('‚úÖ API: Abastecimentos carregados:', data.length);
                return data;
            }
        };

        // === UTILITY FUNCTIONS ===
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function createCustomChart(canvasId, type, labels, datasets, title, xAxisLabel, yAxisLabel) {
            console.log(`üìä Criar gr√°fico: ${title}`);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Canvas ${canvasId} n√£o encontrado`);
                return;
            }

            try {
                new Chart(canvas, {
                    type: type,
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: title } }
                    }
                });
                console.log(`‚úÖ Gr√°fico ${title} criado`);
            } catch (error) {
                console.error(`Erro no gr√°fico ${title}:`, error);
            }
        }

        // === FUN√á√ÉO PRINCIPAL DE RELAT√ìRIOS (copiada e corrigida do arquivo real) ===
        async function gerarRelatorioConsumo() {
            console.log('üöÄ INICIANDO gerarRelatorioConsumo()');
            
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                console.error('‚ùå Elemento relatorioResultados n√£o encontrado!');
                alert('Erro: Elemento de exibi√ß√£o do relat√≥rio n√£o encontrado.');
                return;
            }
            
            resultadosElement.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Gerando relat√≥rio...</p></div>';
            
            // Capturar valores do formul√°rio
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            console.log('üìã Par√¢metros:', { dataInicio, dataFim, caminhaoId });
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                resultadosElement.innerHTML = '<div class="alert alert-danger">Por favor, selecione o per√≠odo para o relat√≥rio.</div>';
                return;
            }

            // Garantir que os dados est√£o carregados
            let dadosCaminhoes = window.caminhoes || caminhoes || [];
            let dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
            
            console.log('üìä Dados iniciais:', {
                caminhoes: dadosCaminhoes.length,
                abastecimentos: dadosAbastecimentos.length
            });
            
            // Recarregar dados se necess√°rio
            if (dadosAbastecimentos.length === 0) {
                console.log('‚ö†Ô∏è Recarregando dados...');
                try {
                    dadosCaminhoes = await window.dbApi.buscarCaminhoes();
                    dadosAbastecimentos = await window.dbApi.buscarAbastecimentos();
                    
                    // Atualizar globais
                    window.caminhoes = dadosCaminhoes;
                    window.abastecimentos = dadosAbastecimentos;
                    caminhoes = dadosCaminhoes;
                    abastecimentos = dadosAbastecimentos;
                    
                    console.log('‚úÖ Dados recarregados');
                } catch (error) {
                    console.error('‚ùå Erro ao recarregar:', error);
                    resultadosElement.innerHTML = '<div class="alert alert-danger">Erro ao carregar dados: ' + error.message + '</div>';
                    return;
                }
            }
            
            if (dadosAbastecimentos.length === 0) {
                resultadosElement.innerHTML = '<div class="alert alert-warning">Nenhum abastecimento encontrado no sistema.</div>';
                return;
            }
            
            // Filtrar por per√≠odo
            let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                const dataAbast = a.data.split('T')[0];
                return dataAbast >= dataInicio && dataAbast <= dataFim;
            });
            
            console.log('üìã Filtrados por per√≠odo:', abastecimentosFiltrados.length);
            
            // Filtrar por caminh√£o
            if (caminhaoId !== 'todos') {
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                console.log('üöõ Filtrados por caminh√£o:', abastecimentosFiltrados.length);
            }
            
            if (abastecimentosFiltrados.length === 0) {
                resultadosElement.innerHTML = '<div class="alert alert-warning">Nenhum dado encontrado para o per√≠odo e caminh√£o selecionados.</div>';
                return;
            }
            
            // Agrupar por caminh√£o
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach(a => {
                console.log('üîç Processando:', a.id, a.placa);
                
                if (!dadosPorCaminhao[a.caminhao_id]) {
                    const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                    dadosPorCaminhao[a.caminhao_id] = {
                        id: a.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Calcular dados
                const kmInicial = parseFloat(a.km_inicial || 0);
                const kmFinal = parseFloat(a.km_final || 0);
                const litros = parseFloat(a.litros || 0);
                const valorTotal = parseFloat(a.valor_total || 0);
                const distancia = kmFinal - kmInicial;
                
                console.log(`üìè ${a.placa}: ${kmInicial}‚Üí${kmFinal}=${distancia}km, ${litros}L, R$${valorTotal}`);
                
                dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
            });
            
            // Calcular m√©dias
            Object.values(dadosPorCaminhao).forEach(dados => {
                dados.mediaConsumo = dados.totalLitros > 0 ? 
                    (dados.totalKm / dados.totalLitros).toFixed(2) : 'N/A';
                dados.custoMedio = dados.totalKm > 0 ? 
                    (dados.totalGasto / dados.totalKm).toFixed(2) : 'N/A';
                    
                console.log(`üìà ${dados.placa}: Dist√¢ncia=${dados.totalKm}km, Consumo=${dados.mediaConsumo}km/l, Custo=R$${dados.custoMedio}/km`);
            });
            
            // Gerar HTML
            let html = `
                <h4 class="mb-3">Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminh√£o</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Combust√≠vel (L)</th>
                                <th>Consumo M√©dio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.values(dadosPorCaminhao).forEach(dados => {
                console.log(`üèóÔ∏è Gerando linha HTML para: ${dados.placa}`);
                html += `
                    <tr>
                        <td><strong>${dados.placa}</strong> - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td>${dados.totalLitros.toFixed(2)}</td>
                        <td>${dados.mediaConsumo}</td>
                        <td>R$ ${dados.totalGasto.toFixed(2)}</td>
                        <td>R$ ${dados.custoMedio}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('üìÑ HTML gerado:', html.length, 'caracteres');
            console.log('üñ•Ô∏è Inserindo no DOM...');
            
            // Inserir no DOM
            resultadosElement.innerHTML = html;
            
            console.log('‚úÖ RELAT√ìRIO EXIBIDO COM SUCESSO!');
            console.log('üîç Verifica√ß√£o DOM:', document.getElementById('relatorioResultados').innerHTML.length, 'caracteres inseridos');
        }

        // === DATA LOADING ===
        async function loadDataFromLocalStorage() {
            console.log('üîÑ Carregando dados do sistema...');
            
            try {
                // Carregar dados da API
                caminhoes = await window.dbApi.buscarCaminhoes();
                abastecimentos = await window.dbApi.buscarAbastecimentos();
                
                // Atualizar vari√°veis globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;
                
                // Popular select de caminh√µes
                const caminhaoSelect = document.getElementById('caminhaoSelect');
                caminhaoSelect.innerHTML = '<option value="todos">Todos os caminh√µes</option>';
                caminhoes.forEach(c => {
                    caminhaoSelect.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });
                
                // Atualizar status
                document.getElementById('statusSistema').innerHTML = '‚úÖ Sistema conectado e funcionando';
                document.getElementById('statusSistema').className = 'alert alert-success';
                
                document.getElementById('statusDados').innerHTML = `
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <strong>${caminhoes.length}</strong><br>
                                <small class="text-muted">Caminh√µes</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <strong>${abastecimentos.length}</strong><br>
                                <small class="text-muted">Abastecimentos</small>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Dados carregados e interface atualizada');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('statusSistema').innerHTML = '‚ùå Erro de conex√£o: ' + error.message;
                document.getElementById('statusSistema').className = 'alert alert-danger';
            }
        }

        function mostrarDadosDebug() {
            console.log('=== DEBUG DE DADOS ===');
            console.log('Caminh√µes globais:', window.caminhoes?.length || 0);
            console.log('Abastecimentos globais:', window.abastecimentos?.length || 0);
            console.log('Caminh√µes locais:', caminhoes?.length || 0);
            console.log('Abastecimentos locais:', abastecimentos?.length || 0);
            
            if (abastecimentos?.length > 0) {
                console.log('Primeiro abastecimento:', abastecimentos[0]);
            }
            if (caminhoes?.length > 0) {
                console.log('Primeiro caminh√£o:', caminhoes[0]);
            }
        }

        // === EVENT LISTENERS (simulando o app.js real) ===
        function setupEventListeners() {
            console.log('‚öôÔ∏è Configurando event listeners...');
            
            // Formul√°rio de relat√≥rio (exatamente como no app.js corrigido)
            document.getElementById('relatorioConsumoForm').addEventListener('submit', (e) => {
                e.preventDefault();
                console.log('üìã Formul√°rio submetido - chamando gerarRelatorioConsumo()');
                gerarRelatorioConsumo(); // SEM PAR√ÇMETROS!
            });
            
            console.log('‚úÖ Event listeners configurados');
        }

        // === INICIALIZA√á√ÉO ===
        async function init() {
            console.log('üöÄ Inicializando sistema de teste...');
            
            await loadDataFromLocalStorage();
            setupEventListeners();
            
            console.log('‚úÖ Sistema inicializado e pronto para uso!');
        }

        // Executar quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
