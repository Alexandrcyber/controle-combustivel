<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Dados dos Relat√≥rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>üîç Debug - Carregamento de Dados para Relat√≥rios</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>API Status</h5>
                    </div>
                    <div class="card-body" id="apiStatus">
                        <p>Verificando...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Dados Carregados</h5>
                    </div>
                    <div class="card-body" id="dadosStatus">
                        <p>Verificando...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console de Debug</h5>
                    </div>
                    <div class="card-body">
                        <pre id="debugConsole" style="background-color: #f8f9fa; padding: 10px; max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <button id="recarregarDados" class="btn btn-primary">üîÑ Recarregar Dados</button>
                <button id="testarRelatorio" class="btn btn-success">üìä Testar Relat√≥rio</button>
                <button id="limparConsole" class="btn btn-secondary">üßπ Limpar Console</button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Caminh√µes</h5>
                    </div>
                    <div class="card-body" id="caminhoesData">
                        <p>Aguardando dados...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Abastecimentos</h5>
                    </div>
                    <div class="card-body" id="abastecimentosData">
                        <p>Aguardando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug console functionality
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            updateDebugConsole();
            console.log(logEntry);
        }
        
        function updateDebugConsole() {
            document.getElementById('debugConsole').textContent = debugLog.slice(-20).join('\n');
        }
        
        // Simular dbApi para teste standalone
        const API_BASE = 'http://localhost:3001/api';
        
        const dbApi = {
            async buscarCaminhoes() {
                const response = await fetch(`${API_BASE}/caminhoes`);
                return await response.json();
            },
            
            async buscarAbastecimentos() {
                const response = await fetch(`${API_BASE}/abastecimentos`);
                return await response.json();
            },
            
            async testarConexao() {
                try {
                    const response = await fetch(`${API_BASE}/caminhoes`);
                    return response.ok;
                } catch {
                    return false;
                }
            }
        };
        
        window.dbApi = dbApi;
        
        let caminhoes = [];
        let abastecimentos = [];
        
        async function verificarAPI() {
            try {
                log('Verificando conex√£o com API...');
                const conectado = await dbApi.testarConexao();
                
                if (conectado) {
                    log('‚úÖ API conectada com sucesso', 'success');
                    document.getElementById('apiStatus').innerHTML = '<span class="badge bg-success">‚úÖ API Conectada</span>';
                } else {
                    log('‚ùå API n√£o est√° respondendo', 'error');
                    document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">‚ùå API Desconectada</span>';
                }
                
                return conectado;
            } catch (error) {
                log(`‚ùå Erro ao verificar API: ${error.message}`, 'error');
                document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">‚ùå Erro na API</span>';
                return false;
            }
        }
        
        async function carregarDados() {
            try {
                log('Carregando dados da API...');
                
                // Carregar caminh√µes
                caminhoes = await dbApi.buscarCaminhoes();
                log(`üì¶ Carregados ${caminhoes.length} caminh√µes`);
                
                // Carregar abastecimentos
                abastecimentos = await dbApi.buscarAbastecimentos();
                log(`‚õΩ Carregados ${abastecimentos.length} abastecimentos`);
                
                // Atualizar vari√°veis globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;
                log('üåê Vari√°veis globais atualizadas');
                
                // Atualizar UI
                atualizarDadosUI();
                
                document.getElementById('dadosStatus').innerHTML = `
                    <span class="badge bg-success">${caminhoes.length} Caminh√µes</span>
                    <span class="badge bg-primary">${abastecimentos.length} Abastecimentos</span>
                `;
                
            } catch (error) {
                log(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
                document.getElementById('dadosStatus').innerHTML = '<span class="badge bg-danger">‚ùå Erro no carregamento</span>';
            }
        }
        
        function atualizarDadosUI() {
            // Mostrar caminh√µes
            const caminhoesHtml = caminhoes.map(c => `
                <div class="border-bottom pb-2 mb-2">
                    <strong>${c.placa}</strong> - ${c.modelo} (${c.ano})<br>
                    <small class="text-muted">ID: ${c.id}</small>
                </div>
            `).join('');
            document.getElementById('caminhoesData').innerHTML = caminhoesHtml || '<em>Nenhum caminh√£o encontrado</em>';
            
            // Mostrar abastecimentos
            const abastecimentosHtml = abastecimentos.map(a => {
                const caminhao = caminhoes.find(c => c.id === a.caminhao_id);
                const distancia = parseFloat(a.km_final) - parseFloat(a.km_inicial);
                return `
                    <div class="border-bottom pb-2 mb-2">
                        <strong>${caminhao ? caminhao.placa : 'Caminh√£o n√£o encontrado'}</strong><br>
                        <small>
                            ${distancia}km | ${a.litros}L | R$${parseFloat(a.valor_total).toFixed(2)}<br>
                            Data: ${new Date(a.data).toLocaleDateString()}
                        </small>
                    </div>
                `;
            }).join('');
            document.getElementById('abastecimentosData').innerHTML = abastecimentosHtml || '<em>Nenhum abastecimento encontrado</em>';
        }
        
        function testarRelatorio() {
            try {
                log('üß™ Testando gera√ß√£o de relat√≥rio...');
                
                if (abastecimentos.length === 0) {
                    log('‚ö†Ô∏è Nenhum abastecimento para gerar relat√≥rio', 'warning');
                    return;
                }
                
                // Simular filtro de dados (√∫ltimos 30 dias)
                const hoje = new Date();
                const data30dias = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
                
                let abastecimentosFiltrados = abastecimentos.filter(a => {
                    return new Date(a.data) >= data30dias;
                });
                
                log(`üìä ${abastecimentosFiltrados.length} abastecimentos nos √∫ltimos 30 dias`);
                
                // Agrupar por caminh√£o
                const dadosPorCaminhao = {};
                
                abastecimentosFiltrados.forEach(a => {
                    if (!dadosPorCaminhao[a.caminhao_id]) {
                        const caminhao = caminhoes.find(c => c.id === a.caminhao_id);
                        dadosPorCaminhao[a.caminhao_id] = {
                            placa: caminhao ? caminhao.placa : 'Desconhecido',
                            totalKm: 0,
                            totalLitros: 0,
                            totalGasto: 0
                        };
                    }
                    
                    const dados = dadosPorCaminhao[a.caminhao_id];
                    dados.totalKm += parseFloat(a.km_final) - parseFloat(a.km_inicial);
                    dados.totalLitros += parseFloat(a.litros);
                    dados.totalGasto += parseFloat(a.valor_total);
                });
                
                // Mostrar resultados
                Object.keys(dadosPorCaminhao).forEach(caminhaoId => {
                    const dados = dadosPorCaminhao[caminhaoId];
                    const consumoMedio = dados.totalLitros > 0 ? (dados.totalKm / dados.totalLitros).toFixed(2) : 0;
                    log(`üìà ${dados.placa}: ${dados.totalKm}km, ${dados.totalLitros}L, R$${dados.totalGasto.toFixed(2)}, ${consumoMedio}km/L`);
                });
                
                log('‚úÖ Teste de relat√≥rio conclu√≠do com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro no teste de relat√≥rio: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('recarregarDados').addEventListener('click', carregarDados);
        document.getElementById('testarRelatorio').addEventListener('click', testarRelatorio);
        document.getElementById('limparConsole').addEventListener('click', () => {
            debugLog = [];
            updateDebugConsole();
        });
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Iniciando debug de dados dos relat√≥rios...');
            
            const apiOk = await verificarAPI();
            if (apiOk) {
                await carregarDados();
            }
        });
    </script>
</body>
</html>
