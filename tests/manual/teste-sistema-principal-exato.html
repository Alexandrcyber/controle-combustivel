<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste EXATO do Sistema Principal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .debug-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .console-log {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #4a5568;
        }
        .step-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 10px;
        }
        .resultado-final {
            border: 3px solid #48bb78;
            border-radius: 10px;
            background-color: #f0fff4;
            min-height: 200px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="text-center mb-4">
            <h1 class="display-4">üéØ Teste EXATO do Sistema Principal</h1>
            <p class="lead">Reproduzindo exatamente o comportamento da aplica√ß√£o principal</p>
        </div>
        
        <div class="row">
            <div class="col-lg-4">
                <div class="debug-panel">
                    <h4><i class="bi bi-gear-fill"></i> Controles</h4>
                    
                    <div class="mb-3">
                        <label for="dataInicio" class="form-label">Data In√≠cio:</label>
                        <input type="date" class="form-control" id="dataInicio" value="2025-05-01">
                    </div>
                    
                    <div class="mb-3">
                        <label for="dataFim" class="form-label">Data Fim:</label>
                        <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                    </div>
                    
                    <div class="mb-3">
                        <label for="caminhaoSelect" class="form-label">Caminh√£o:</label>
                        <select class="form-select" id="caminhaoSelect">
                            <option value="todos">Todos os caminh√µes</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success w-100 mb-2" onclick="executarTesteCompleto()">
                        üöÄ Executar Teste Completo
                    </button>
                    
                    <button class="btn btn-warning w-100 mb-2" onclick="testarApenasDados()">
                        üìä Testar Apenas Dados
                    </button>
                    
                    <button class="btn btn-info w-100" onclick="resetarTeste()">
                        üîÑ Resetar Teste
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="bi bi-activity"></i> Status do Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusSistema">
                            <div class="text-muted">Aguardando inicializa√ß√£o...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="bi bi-terminal"></i> Log de Execu√ß√£o</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="console-log" id="consoleOutput">
                            Aguardando execu√ß√£o do teste...\n
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-table"></i> Resultado Final - relatorioResultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="relatorioResultados" class="resultado-final">
                            <div class="text-center text-muted">
                                <i class="bi bi-clock display-1 d-block mb-3"></i>
                                <p>Aguardando gera√ß√£o do relat√≥rio...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da URL da API
        window.API_BASE_URL = 'http://localhost:3001/api';
        
        // Vari√°veis globais - EXATAMENTE como na aplica√ß√£o principal
        let caminhoes = [];
        let abastecimentos = [];
        
        // Disponibilizar dados globalmente para os relat√≥rios - IGUAL ao app.js
        window.caminhoes = caminhoes;
        window.abastecimentos = abastecimentos;
        
        let testeStep = 0;
        
        // Sistema de logging
        function logTeste(mensagem, tipo = 'info') {
            testeStep++;
            const console_div = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const emojis = {
                'info': 'üìù',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîç',
                'api': 'üåê'
            };
            
            const emoji = emojis[tipo] || 'üìù';
            console_div.innerHTML += `<span class="step-badge">${testeStep}</span>[${timestamp}] ${emoji} ${mensagem}\n`;
            console_div.scrollTop = console_div.scrollHeight;
            
            // Tambi√©n logar no console real
            console.log(`[TESTE-${testeStep}] ${mensagem}`);
        }
        
        function resetarTeste() {
            document.getElementById('consoleOutput').innerHTML = 'Console resetado...\n';
            document.getElementById('relatorioResultados').innerHTML = '<div class="text-center text-muted"><i class="bi bi-clock display-1 d-block mb-3"></i><p>Aguardando gera√ß√£o do relat√≥rio...</p></div>';
            testeStep = 0;
            logTeste('Sistema resetado para novo teste');
        }
        
        // Fun√ß√£o de atualiza√ß√£o de refer√™ncias globais - IGUAL ao app.js
        function updateGlobalReferences() {
            window.caminhoes = caminhoes;
            window.abastecimentos = abastecimentos;
            logTeste(`Refer√™ncias globais atualizadas: ${caminhoes.length} caminh√µes, ${abastecimentos.length} abastecimentos`, 'debug');
        }
        
        // Carregar dados das APIs - SIMILAR ao app.js
        async function carregarDadosAPIs() {
            logTeste('üîÑ Iniciando carregamento de dados das APIs...', 'api');
            
            try {
                // Carregar caminh√µes
                logTeste('üì° Requisi√ß√£o: GET /api/caminhoes', 'api');
                const responseCaminhoes = await fetch(`${window.API_BASE_URL}/caminhoes`);
                if (!responseCaminhoes.ok) {
                    throw new Error(`HTTP ${responseCaminhoes.status} - Caminh√µes`);
                }
                caminhoes = await responseCaminhoes.json();
                logTeste(`‚úÖ ${caminhoes.length} caminh√µes carregados`, 'success');
                
                // Carregar abastecimentos
                logTeste('üì° Requisi√ß√£o: GET /api/abastecimentos', 'api');
                const responseAbastecimentos = await fetch(`${window.API_BASE_URL}/abastecimentos`);
                if (!responseAbastecimentos.ok) {
                    throw new Error(`HTTP ${responseAbastecimentos.status} - Abastecimentos`);
                }
                abastecimentos = await responseAbastecimentos.json();
                logTeste(`‚úÖ ${abastecimentos.length} abastecimentos carregados`, 'success');
                
                // Atualizar refer√™ncias globais - IGUAL ao app.js
                updateGlobalReferences();
                
                // Atualizar select de caminh√µes
                const select = document.getElementById('caminhaoSelect');
                select.innerHTML = '<option value="todos">Todos os caminh√µes</option>';
                caminhoes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });
                logTeste('üîÑ Select de caminh√µes atualizado', 'debug');
                
                atualizarStatus();
                return true;
                
            } catch (error) {
                logTeste(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
                return false;
            }
        }
        
        function atualizarStatus() {
            const statusDiv = document.getElementById('statusSistema');
            statusDiv.innerHTML = `
                <div class="mb-2"><strong>‚úÖ Caminh√µes:</strong> ${caminhoes.length}</div>
                <div class="mb-2"><strong>‚úÖ Abastecimentos:</strong> ${abastecimentos.length}</div>
                <div class="mb-2"><strong>üìÖ Per√≠odo:</strong> ${document.getElementById('dataInicio').value} ‚Üí ${document.getElementById('dataFim').value}</div>
                <div><strong>üöõ Selecionado:</strong> ${document.getElementById('caminhaoSelect').selectedOptions[0]?.text || 'Nenhum'}</div>
            `;
        }
        
        async function testarApenasDados() {
            logTeste('üß™ TESTE SIMPLES: Apenas verificar dados', 'info');
            await carregarDadosAPIs();
            
            if (abastecimentos.length > 0) {
                logTeste('üîç Estrutura do primeiro abastecimento:', 'debug');
                const primeiro = abastecimentos[0];
                logTeste(`   - ID: ${primeiro.id}`, 'debug');
                logTeste(`   - Data: ${primeiro.data}`, 'debug');
                logTeste(`   - Caminh√£o ID: ${primeiro.caminhao_id}`, 'debug');
                logTeste(`   - KM Inicial: ${primeiro.km_inicial} (${typeof primeiro.km_inicial})`, 'debug');
                logTeste(`   - KM Final: ${primeiro.km_final} (${typeof primeiro.km_final})`, 'debug');
                logTeste(`   - Litros: ${primeiro.litros} (${typeof primeiro.litros})`, 'debug');
                logTeste(`   - Valor Total: ${primeiro.valor_total} (${typeof primeiro.valor_total})`, 'debug');
                
                // Teste de c√°lculos b√°sicos
                const kmInicial = parseFloat(primeiro.km_inicial || 0);
                const kmFinal = parseFloat(primeiro.km_final || 0);
                const litros = parseFloat(primeiro.litros || 0);
                const valorTotal = parseFloat(primeiro.valor_total || 0);
                const distancia = kmFinal - kmInicial;
                const consumo = distancia / litros;
                
                logTeste(`üßÆ C√°lculos: ${kmInicial} ‚Üí ${kmFinal} = ${distancia}km, ${litros}L = ${consumo.toFixed(2)}km/L`, 'debug');
                logTeste(`üí∞ Custo: R$ ${valorTotal} = R$ ${(valorTotal / distancia).toFixed(2)}/km`, 'debug');
            }
        }
        
        // Fun√ß√£o formatDate - IGUAL aos relat√≥rios
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        // FUN√á√ÉO PRINCIPAL - C√ìPIA EXATA da gerarRelatorioConsumo() do relatorios.js
        function gerarRelatorioConsumo() {
            logTeste('üîÑ INICIANDO gera√ß√£o de relat√≥rio de consumo...', 'info');
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            // Validar datas
            if (!dataInicio || !dataFim) {
                logTeste('‚ùå Datas n√£o selecionadas', 'error');
                alert('Por favor, selecione o per√≠odo para o relat√≥rio.');
                return;
            }

            logTeste(`üìÖ Per√≠odo selecionado: ${dataInicio} at√© ${dataFim}`, 'info');
            
            // Acessar dados globais de forma robusta - IGUAL ao c√≥digo original
            const dadosCaminhoes = window.caminhoes || caminhoes || [];
            const dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
            
            logTeste(`üìä Dados dispon√≠veis: ${dadosCaminhoes.length} caminh√µes, ${dadosAbastecimentos.length} abastecimentos`, 'debug');
            
            if (dadosAbastecimentos.length === 0) {
                document.getElementById('relatorioResultados').innerHTML = 
                    '<div class="alert alert-warning">Nenhum abastecimento encontrado no sistema. Verifique se os dados foram carregados.</div>';
                logTeste('‚ö†Ô∏è Nenhum abastecimento dispon√≠vel', 'warning');
                return;
            }
            
            // Filtrar abastecimentos pelo per√≠odo
            let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                return a.data >= dataInicio && a.data <= dataFim;
            });
            
            logTeste(`üìã Abastecimentos filtrados por per√≠odo: ${abastecimentosFiltrados.length}`, 'debug');
            
            // Filtrar por caminh√£o se n√£o for "todos"
            if (caminhaoId !== 'todos') {
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                logTeste(`üöõ Abastecimentos filtrados por caminh√£o: ${abastecimentosFiltrados.length}`, 'debug');
            }
            
            // Verificar se h√° dados para o relat√≥rio
            if (abastecimentosFiltrados.length === 0) {
                document.getElementById('relatorioResultados').innerHTML = 
                    '<div class="alert alert-warning">Nenhum dado encontrado para o per√≠odo e caminh√£o selecionados.</div>';
                logTeste('‚ö†Ô∏è Nenhum abastecimento no per√≠odo/caminh√£o selecionado', 'warning');
                return;
            }
            
            logTeste(`‚úÖ Processando ${abastecimentosFiltrados.length} abastecimentos`, 'success');
            
            // Agrupar dados por caminh√£o - C√ìDIGO ORIGINAL
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach((a, index) => {
                logTeste(`üîç Processando abastecimento ${index + 1}: ${a.id}`, 'debug');
                
                if (!dadosPorCaminhao[a.caminhao_id]) {
                    const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                    logTeste(`üöõ Caminh√£o encontrado: ${caminhao ? `${caminhao.placa} - ${caminhao.modelo}` : 'N√£o encontrado'}`, 'debug');
                    
                    dadosPorCaminhao[a.caminhao_id] = {
                        id: a.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Adicionar dados deste abastecimento com valida√ß√£o - C√ìDIGO ORIGINAL
                const kmInicial = parseFloat(a.km_inicial || 0);
                const kmFinal = parseFloat(a.km_final || 0);
                const litros = parseFloat(a.litros || 0);
                const valorTotal = parseFloat(a.valor_total || 0);
                
                const distancia = kmFinal - kmInicial;
                
                logTeste(`üìè C√°lculos: KM ${kmInicial} ‚Üí ${kmFinal} = ${distancia}km, ${litros}L, R$${valorTotal}`, 'debug');
                
                dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
            });
            
            logTeste(`üìä Dados agrupados por caminh√£o: ${Object.keys(dadosPorCaminhao).length} caminh√µes`, 'debug');
            
            // Calcular consumo m√©dio e outros indicadores - C√ìDIGO ORIGINAL
            Object.values(dadosPorCaminhao).forEach(dadosCaminhao => {
                dadosCaminhao.mediaConsumo = dadosCaminhao.totalLitros > 0 ? 
                    (dadosCaminhao.totalKm / dadosCaminhao.totalLitros).toFixed(2) : 'N/A';
                dadosCaminhao.custoMedio = dadosCaminhao.totalKm > 0 ? 
                    (dadosCaminhao.totalGasto / dadosCaminhao.totalKm).toFixed(2) : 'N/A';
                    
                logTeste(`üìà ${dadosCaminhao.placa}: KM=${dadosCaminhao.totalKm}, L=${dadosCaminhao.totalLitros}, R$=${dadosCaminhao.totalGasto}, Consumo=${dadosCaminhao.mediaConsumo}, Custo/km=R$${dadosCaminhao.custoMedio}`, 'debug');
            });
            
            // Gerar HTML para exibir os resultados - C√ìDIGO ORIGINAL
            logTeste('üé® Gerando HTML do relat√≥rio...', 'info');
            
            let html = `
                <h4 class="mb-3">Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminh√£o</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Combust√≠vel (L)</th>
                                <th>Consumo M√©dio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Adicionar linha para cada caminh√£o - C√ìDIGO ORIGINAL
            Object.values(dadosPorCaminhao).forEach(dados => {
                logTeste(`üîß Adicionando linha para caminh√£o: ${dados.placa}`, 'debug');
                
                html += `
                    <tr>
                        <td>${dados.placa} - ${dados.modelo}</td>
                        <td>${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td>${dados.totalLitros.toFixed(2)}</td>
                        <td>${dados.mediaConsumo}</td>
                        <td>R$ ${dados.totalGasto.toFixed(2)}</td>
                        <td>R$ ${dados.custoMedio}</td>
                    </tr>
                `;
            });
            
            // Fechar tabela principal - C√ìDIGO ORIGINAL
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            logTeste(`üìã HTML gerado com sucesso. Tamanho: ${html.length} caracteres`, 'success');
            logTeste(`üîç Preview HTML (primeiros 200 chars): ${html.substring(0, 200)}...`, 'debug');
            
            // Exibir resultados - C√ìDIGO ORIGINAL
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                logTeste('‚ùå Elemento relatorioResultados n√£o encontrado!', 'error');
                alert('Erro: Elemento de exibi√ß√£o do relat√≥rio n√£o encontrado.');
                return;
            }
            
            logTeste('üì• Inserindo HTML no elemento relatorioResultados...', 'info');
            resultadosElement.innerHTML = html;
            logTeste('‚úÖ Relat√≥rio exibido com sucesso!', 'success');
            
            // Verificar se o conte√∫do foi realmente inserido
            setTimeout(() => {
                const conteudoInserido = resultadosElement.innerHTML;
                logTeste(`üîç Verifica√ß√£o p√≥s-inser√ß√£o: ${conteudoInserido.length} caracteres inseridos`, 'debug');
                logTeste(`üîç Cont√©m tabela: ${conteudoInserido.includes('<table') ? 'SIM' : 'N√ÉO'}`, 'debug');
                logTeste(`üîç Cont√©m dados: ${conteudoInserido.includes('Caminh√£o') ? 'SIM' : 'N√ÉO'}`, 'debug');
                
                if (conteudoInserido.includes('<table') && conteudoInserido.includes('R$')) {
                    logTeste('üéâ SUCESSO TOTAL! Relat√≥rio gerado e exibido!', 'success');
                } else {
                    logTeste('‚ùå PROBLEMA: HTML n√£o foi inserido corretamente', 'error');
                }
            }, 500);
        }
        
        async function executarTesteCompleto() {
            logTeste('üöÄ EXECUTANDO TESTE COMPLETO DO SISTEMA', 'info');
            
            // Passo 1: Carregar dados
            const dadosOk = await carregarDadosAPIs();
            if (!dadosOk) {
                logTeste('‚ùå FALHA CR√çTICA: N√£o foi poss√≠vel carregar dados', 'error');
                return;
            }
            
            // Passo 2: Executar fun√ß√£o de relat√≥rio
            logTeste('üìã Executando fun√ß√£o gerarRelatorioConsumo()...', 'info');
            gerarRelatorioConsumo();
            
            logTeste('üèÅ Teste completo finalizado!', 'success');
        }
        
        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            logTeste('üåü P√°gina de teste carregada e pronta!', 'success');
            carregarDadosAPIs();
        });
    </script>
</body>
</html>
