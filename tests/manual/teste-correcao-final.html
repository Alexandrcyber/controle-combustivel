<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Corre√ß√£o de Relat√≥rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-left: 4px solid #28a745;
            background: #f8f9fa;
        }
        .test-results {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <h1 class="text-center mb-4">üéØ Teste Final de Corre√ß√£o</h1>
                
                <!-- Status -->
                <div class="card status-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Status do Sistema</h5>
                        <div id="statusSistema">üîÑ Verificando...</div>
                    </div>
                </div>

                <!-- Teste de Formul√°rio -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üß™ Teste de Gera√ß√£o de Relat√≥rio</h5>
                    </div>
                    <div class="card-body">
                        <form id="relatorioConsumoForm">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="dataInicio" class="form-label">Data In√≠cio</label>
                                    <input type="date" class="form-control" id="dataInicio" value="2025-05-01">
                                </div>
                                <div class="col-md-4">
                                    <label for="dataFim" class="form-label">Data Fim</label>
                                    <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                                </div>
                                <div class="col-md-4">
                                    <label for="caminhaoSelect" class="form-label">Caminh√£o</label>
                                    <select class="form-select" id="caminhaoSelect">
                                        <option value="todos">Todos os caminh√µes</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">üöÄ Testar Relat√≥rio</button>
                        </form>
                    </div>
                </div>

                <!-- Resultados do Teste -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Resultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="relatorioResultados" class="test-results">
                            <p class="text-muted">Aguardando teste...</p>
                        </div>
                    </div>
                </div>

                <!-- Log de Debug -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">üêõ Log de Debug</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="limparLog()">Limpar</button>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" style="background: #2d3748; color: #fff; font-family: monospace; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto;">
                            <div style="color: #68d391;">‚úÖ Sistema inicializado</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // === CONFIGURA√á√ÉO DE DEBUG ===
        function addLogMessage(msg, tipo = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#e2e8f0',
                success: '#68d391',
                error: '#fc8181',
                warn: '#f6ad55'
            };
            
            log.innerHTML += `<div style="color: ${colors[tipo]}">[${timestamp}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        console.log = function(...args) {
            addLogMessage(args.join(' '), 'info');
        };

        function limparLog() {
            document.getElementById('debugLog').innerHTML = '<div style="color: #68d391;">‚úÖ Log limpo</div>';
        }

        // === VARI√ÅVEIS GLOBAIS ===
        let caminhoes = [];
        let abastecimentos = [];
        const API_BASE_URL = 'http://localhost:3001/api';

        // === API ===
        window.dbApi = {
            async buscarCaminhoes() {
                console.log('üîÑ Buscando caminh√µes via API...');
                const response = await fetch(`${API_BASE_URL}/caminhoes`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log(`‚úÖ ${data.length} caminh√µes carregados`);
                return data;
            },
            
            async buscarAbastecimentos() {
                console.log('üîÑ Buscando abastecimentos via API...');
                const response = await fetch(`${API_BASE_URL}/abastecimentos`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log(`‚úÖ ${data.length} abastecimentos carregados`);
                return data;
            }
        };

        // === FUN√á√ïES UTILIT√ÅRIAS ===
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function createCustomChart() {
            // Placeholder para compatibilidade
            console.log('üìä createCustomChart chamado');
        }

        // === FUN√á√ÉO DE RELAT√ìRIO (a que acabamos de corrigir) ===
        async function gerarRelatorioConsumo() {
            console.log('üöÄ === INICIANDO TESTE DE RELAT√ìRIO ===');
            
            const resultadosElement = document.getElementById('relatorioResultados');
            if (!resultadosElement) {
                console.log('‚ùå Elemento relatorioResultados n√£o encontrado!');
                return;
            }
            
            resultadosElement.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Gerando relat√≥rio...</p></div>';
            
            try {
                // Capturar par√¢metros
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const caminhaoId = document.getElementById('caminhaoSelect').value;
                
                console.log(`üìã Par√¢metros: ${dataInicio} a ${dataFim}, caminh√£o: ${caminhaoId}`);
                
                // Validar datas
                if (!dataInicio || !dataFim) {
                    resultadosElement.innerHTML = '<div class="alert alert-danger">‚ùå Por favor, selecione o per√≠odo para o relat√≥rio.</div>';
                    return;
                }

                // Acessar dados (estrat√©gia robusta)
                let dadosCaminhoes = window.caminhoes || caminhoes || [];
                let dadosAbastecimentos = window.abastecimentos || abastecimentos || [];
                
                console.log(`üìä Dados iniciais: ${dadosCaminhoes.length} caminh√µes, ${dadosAbastecimentos.length} abastecimentos`);
                
                // Recarregar se necess√°rio
                if (dadosAbastecimentos.length === 0) {
                    console.log('‚ö†Ô∏è Dados vazios, recarregando...');
                    dadosCaminhoes = await window.dbApi.buscarCaminhoes();
                    dadosAbastecimentos = await window.dbApi.buscarAbastecimentos();
                    
                    // Atualizar globais
                    window.caminhoes = dadosCaminhoes;
                    window.abastecimentos = dadosAbastecimentos;
                    caminhoes = dadosCaminhoes;
                    abastecimentos = dadosAbastecimentos;
                }
                
                if (dadosAbastecimentos.length === 0) {
                    resultadosElement.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Nenhum abastecimento encontrado no sistema.</div>';
                    return;
                }
                
                // Filtrar por per√≠odo
                let abastecimentosFiltrados = dadosAbastecimentos.filter(a => {
                    const dataAbast = a.data.split('T')[0];
                    return dataAbast >= dataInicio && dataAbast <= dataFim;
                });
                
                console.log(`üìã Filtrados por per√≠odo: ${abastecimentosFiltrados.length}`);
                
                // Filtrar por caminh√£o se necess√°rio
                if (caminhaoId !== 'todos') {
                    abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                    console.log(`üöõ Filtrados por caminh√£o: ${abastecimentosFiltrados.length}`);
                }
                
                if (abastecimentosFiltrados.length === 0) {
                    resultadosElement.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Nenhum dado encontrado para o per√≠odo e caminh√£o selecionados.</div>';
                    return;
                }
                
                // Agrupar por caminh√£o
                const dadosPorCaminhao = {};
                
                abastecimentosFiltrados.forEach(a => {
                    if (!dadosPorCaminhao[a.caminhao_id]) {
                        const caminhao = dadosCaminhoes.find(c => c.id === a.caminhao_id);
                        dadosPorCaminhao[a.caminhao_id] = {
                            id: a.caminhao_id,
                            placa: caminhao ? caminhao.placa : 'Desconhecido',
                            modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                            totalKm: 0,
                            totalLitros: 0,
                            totalGasto: 0,
                            abastecimentos: []
                        };
                    }
                    
                    // Calcular dados
                    const kmInicial = parseFloat(a.km_inicial || 0);
                    const kmFinal = parseFloat(a.km_final || 0);
                    const litros = parseFloat(a.litros || 0);
                    const valorTotal = parseFloat(a.valor_total || 0);
                    const distancia = kmFinal - kmInicial;
                    
                    dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                    dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                    dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                    dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
                });
                
                // Calcular m√©dias
                Object.values(dadosPorCaminhao).forEach(dados => {
                    dados.mediaConsumo = dados.totalLitros > 0 ? 
                        (dados.totalKm / dados.totalLitros).toFixed(2) : 'N/A';
                    dados.custoMedio = dados.totalKm > 0 ? 
                        (dados.totalGasto / dados.totalKm).toFixed(2) : 'N/A';
                });
                
                console.log(`üìä Processados ${Object.keys(dadosPorCaminhao).length} caminh√µes`);
                
                // Gerar HTML
                let html = `
                    <div class="alert alert-success">‚úÖ <strong>Relat√≥rio gerado com sucesso!</strong></div>
                    <h5 class="mb-3">üìä Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>üöõ Caminh√£o</th>
                                    <th>üìè Dist√¢ncia (km)</th>
                                    <th>‚õΩ Combust√≠vel (L)</th>
                                    <th>üìà Consumo M√©dio (km/l)</th>
                                    <th>üí∞ Gasto Total (R$)</th>
                                    <th>üí∏ Custo por km (R$)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.values(dadosPorCaminhao).forEach(dados => {
                    html += `
                        <tr>
                            <td><strong>${dados.placa}</strong> - ${dados.modelo}</td>
                            <td class="text-end">${dados.totalKm.toLocaleString('pt-BR')}</td>
                            <td class="text-end">${dados.totalLitros.toFixed(2)}</td>
                            <td class="text-center">${dados.mediaConsumo}</td>
                            <td class="text-end">R$ ${dados.totalGasto.toFixed(2)}</td>
                            <td class="text-end">R$ ${dados.custoMedio}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            ‚úÖ Relat√≥rio processou ${abastecimentosFiltrados.length} abastecimentos de ${Object.keys(dadosPorCaminhao).length} caminh√µes.
                        </small>
                    </div>
                `;
                
                // Inserir no DOM
                resultadosElement.innerHTML = html;
                console.log('‚úÖ === RELAT√ìRIO EXIBIDO COM SUCESSO! ===');
                addLogMessage('üéâ SUCESSO: Relat√≥rio gerado e exibido corretamente!', 'success');
                
            } catch (error) {
                console.log(`‚ùå Erro: ${error.message}`);
                resultadosElement.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${error.message}</div>`;
                addLogMessage(`‚ùå ERRO: ${error.message}`, 'error');
            }
        }

        // === INICIALIZA√á√ÉO ===
        async function carregarDados() {
            try {
                console.log('üîÑ Carregando dados...');
                
                // Carregar dados
                caminhoes = await window.dbApi.buscarCaminhoes();
                abastecimentos = await window.dbApi.buscarAbastecimentos();
                
                // Atualizar globais
                window.caminhoes = caminhoes;
                window.abastecimentos = abastecimentos;
                
                // Popular select
                const select = document.getElementById('caminhaoSelect');
                select.innerHTML = '<option value="todos">Todos os caminh√µes</option>';
                caminhoes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });
                
                // Atualizar status
                document.getElementById('statusSistema').innerHTML = `
                    ‚úÖ <strong>Sistema funcionando:</strong><br>
                    üöõ ${caminhoes.length} caminh√µes carregados<br>
                    ‚õΩ ${abastecimentos.length} abastecimentos carregados<br>
                    üîó Conectado ao backend (porta 3001)
                `;
                
                console.log('‚úÖ Dados carregados com sucesso');
                
            } catch (error) {
                console.log(`‚ùå Erro ao carregar: ${error.message}`);
                document.getElementById('statusSistema').innerHTML = `‚ùå <strong>Erro:</strong> ${error.message}`;
            }
        }

        function setupEventListeners() {
            // Event listener para o formul√°rio (como no app.js corrigido)
            document.getElementById('relatorioConsumoForm').addEventListener('submit', (e) => {
                e.preventDefault();
                console.log('üìã Formul√°rio submetido - chamando gerarRelatorioConsumo()');
                gerarRelatorioConsumo(); // SEM PAR√ÇMETROS!
            });
            
            console.log('‚úÖ Event listeners configurados');
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando teste...');
            await carregarDados();
            setupEventListeners();
            console.log('‚úÖ Teste pronto para uso!');
        });
    </script>
</body>
</html>
