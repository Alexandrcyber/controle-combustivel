<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Sistema de Relat√≥rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .test-panel { 
            background: white; 
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        pre { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üöõ Teste Final - Sistema de Relat√≥rios de Combust√≠vel</h1>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="test-panel p-4">
                    <h3>üì° Status da Conex√£o</h3>
                    <div class="mb-3">
                        <strong>Backend API:</strong> <span id="backend-status" class="status-badge">Verificando...</span>
                    </div>
                    <div class="mb-3">
                        <strong>Dados Carregados:</strong> <span id="data-status" class="status-badge">Verificando...</span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="verificarStatus()">üîÑ Recarregar Status</button>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="test-panel p-4">
                    <h3>üìä Dados Dispon√≠veis</h3>
                    <div id="dados-info">
                        <p><strong>Caminh√µes:</strong> <span id="total-caminhoes">0</span></p>
                        <p><strong>Abastecimentos:</strong> <span id="total-abastecimentos">0</span></p>
                        <p><strong>Per√≠odo:</strong> <span id="periodo-dados">N/A</span></p>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="carregarDados()">üì• Carregar Dados</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="test-panel p-4">
                    <h3>üß™ Teste de Gera√ß√£o de Relat√≥rio</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Data In√≠cio:</label>
                            <input type="date" id="dataInicio" class="form-control" value="2025-01-01">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Fim:</label>
                            <input type="date" id="dataFim" class="form-control" value="2025-12-31">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Caminh√£o:</label>
                            <select id="caminhaoSelect" class="form-control">
                                <option value="todos">Todos os Caminh√µes</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary d-block w-100" onclick="testarRelatorio()">üìã Gerar Relat√≥rio</button>
                        </div>
                    </div>
                    
                    <div id="teste-resultado" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div id="relatorio-display" class="test-panel p-4" style="display: none;">
                    <h3>üìà Relat√≥rio Gerado</h3>
                    <div id="relatorio-content"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="test-panel p-4">
                    <h3>üîç Debug - Dados Brutos</h3>
                    <button class="btn btn-info btn-sm" onclick="mostrarDadosBrutos()">üëÄ Mostrar Dados</button>
                    <div id="dados-brutos" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais para simular o ambiente da aplica√ß√£o
        let caminhoes = [];
        let abastecimentos = [];
        
        // Carregar dados na inicializa√ß√£o
        window.onload = function() {
            verificarStatus();
            carregarDados();
        };

        async function verificarStatus() {
            try {
                const response = await fetch('http://localhost:3001/api/caminhoes');
                if (response.ok) {
                    document.getElementById('backend-status').textContent = '‚úÖ Online';
                    document.getElementById('backend-status').className = 'status-badge status-success';
                } else {
                    document.getElementById('backend-status').textContent = '‚ùå Erro';
                    document.getElementById('backend-status').className = 'status-badge status-error';
                }
            } catch (error) {
                document.getElementById('backend-status').textContent = '‚ùå Offline';
                document.getElementById('backend-status').className = 'status-badge status-error';
            }
        }

        async function carregarDados() {
            try {
                const [caminhaoData, abastecimentoData] = await Promise.all([
                    fetch('http://localhost:3001/api/caminhoes').then(r => r.json()),
                    fetch('http://localhost:3001/api/abastecimentos').then(r => r.json())
                ]);

                caminhoes = caminhaoData;
                abastecimentos = abastecimentoData;

                // Atualizar interface
                document.getElementById('total-caminhoes').textContent = caminhoes.length;
                document.getElementById('total-abastecimentos').textContent = abastecimentos.length;
                
                if (abastecimentos.length > 0) {
                    const datas = abastecimentos.map(a => new Date(a.data));
                    const dataMin = new Date(Math.min(...datas)).toLocaleDateString('pt-BR');
                    const dataMax = new Date(Math.max(...datas)).toLocaleDateString('pt-BR');
                    document.getElementById('periodo-dados').textContent = `${dataMin} - ${dataMax}`;
                }

                // Preencher select de caminh√µes
                const caminhaoSelect = document.getElementById('caminhaoSelect');
                caminhaoSelect.innerHTML = '<option value="todos">Todos os Caminh√µes</option>';
                caminhoes.forEach(c => {
                    caminhaoSelect.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });

                document.getElementById('data-status').textContent = '‚úÖ Carregados';
                document.getElementById('data-status').className = 'status-badge status-success';

            } catch (error) {
                document.getElementById('data-status').textContent = '‚ùå Erro';
                document.getElementById('data-status').className = 'status-badge status-error';
                console.error('Erro ao carregar dados:', error);
            }
        }

        function testarRelatorio() {
            const resultadoDiv = document.getElementById('teste-resultado');
            const displayDiv = document.getElementById('relatorio-display');
            const contentDiv = document.getElementById('relatorio-content');
            
            try {
                // Obter par√¢metros
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const caminhaoId = document.getElementById('caminhaoSelect').value;

                // Valida√ß√µes
                if (!dataInicio || !dataFim) {
                    throw new Error('Por favor, selecione as datas de in√≠cio e fim.');
                }

                if (abastecimentos.length === 0) {
                    throw new Error('Nenhum abastecimento encontrado no sistema.');
                }

                // Filtrar abastecimentos pelo per√≠odo
                let abastecimentosFiltrados = abastecimentos.filter(a => {
                    return a.data >= dataInicio && a.data <= dataFim;
                });

                // Filtrar por caminh√£o se n√£o for "todos"
                if (caminhaoId !== 'todos') {
                    abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                }

                if (abastecimentosFiltrados.length === 0) {
                    throw new Error('Nenhum abastecimento encontrado para o per√≠odo e caminh√£o selecionados.');
                }

                // *** ESTE √â O TESTE CR√çTICO - USANDO OS CAMPOS CORRETOS ***
                const dadosPorCaminhao = {};
                
                abastecimentosFiltrados.forEach(a => {
                    console.log('Processando abastecimento:', a);
                    
                    if (!dadosPorCaminhao[a.caminhao_id]) {
                        const caminhao = caminhoes.find(c => c.id === a.caminhao_id);
                        dadosPorCaminhao[a.caminhao_id] = {
                            id: a.caminhao_id,
                            placa: caminhao ? caminhao.placa : 'Desconhecido',
                            modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                            totalKm: 0,
                            totalLitros: 0,
                            totalGasto: 0,
                            abastecimentos: []
                        };
                    }

                    // *** TESTE DOS CAMPOS CR√çTICOS COM snake_case E parseFloat ***
                    const kmInicial = parseFloat(a.km_inicial || 0);
                    const kmFinal = parseFloat(a.km_final || 0);
                    const litros = parseFloat(a.litros || 0);
                    const valorTotal = parseFloat(a.valor_total || 0);
                    
                    console.log(`Campos processados - KM: ${kmInicial} -> ${kmFinal}, Litros: ${litros}, Valor: ${valorTotal}`);
                    
                    const distancia = kmFinal - kmInicial;
                    
                    dadosPorCaminhao[a.caminhao_id].totalKm += distancia;
                    dadosPorCaminhao[a.caminhao_id].totalLitros += litros;
                    dadosPorCaminhao[a.caminhao_id].totalGasto += valorTotal;
                    dadosPorCaminhao[a.caminhao_id].abastecimentos.push(a);
                });

                // Gerar HTML do relat√≥rio
                let html = '<div class="alert alert-success"><strong>‚úÖ Relat√≥rio gerado com sucesso!</strong></div>';
                
                // Resumo geral
                const totalGeral = Object.values(dadosPorCaminhao).reduce((acc, dados) => ({
                    totalKm: acc.totalKm + dados.totalKm,
                    totalLitros: acc.totalLitros + dados.totalLitros,
                    totalGasto: acc.totalGasto + dados.totalGasto
                }), {totalKm: 0, totalLitros: 0, totalGasto: 0});

                html += `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Total KM</h5>
                                    <h3 class="text-primary">${totalGeral.totalKm.toFixed(0)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Total Litros</h5>
                                    <h3 class="text-info">${totalGeral.totalLitros.toFixed(2)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Total Gasto</h5>
                                    <h3 class="text-success">R$ ${totalGeral.totalGasto.toFixed(2)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Consumo M√©dio</h5>
                                    <h3 class="text-warning">${(totalGeral.totalKm / totalGeral.totalLitros).toFixed(2)} km/L</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Detalhe por caminh√£o
                html += '<h4>Detalhamento por Caminh√£o</h4>';
                for (const [caminhaoId, dados] of Object.entries(dadosPorCaminhao)) {
                    const consumoMedio = dados.totalKm / dados.totalLitros;
                    html += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>${dados.placa} - ${dados.modelo}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2"><strong>Abastecimentos:</strong> ${dados.abastecimentos.length}</div>
                                    <div class="col-md-2"><strong>KM:</strong> ${dados.totalKm.toFixed(0)}</div>
                                    <div class="col-md-2"><strong>Litros:</strong> ${dados.totalLitros.toFixed(2)}</div>
                                    <div class="col-md-2"><strong>Gasto:</strong> R$ ${dados.totalGasto.toFixed(2)}</div>
                                    <div class="col-md-2"><strong>Consumo:</strong> ${consumoMedio.toFixed(2)} km/L</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                resultadoDiv.innerHTML = '<div class="alert alert-success">‚úÖ Relat√≥rio processado com sucesso! Nenhum erro de campo encontrado.</div>';
                contentDiv.innerHTML = html;
                displayDiv.style.display = 'block';

            } catch (error) {
                resultadoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Erro ao gerar relat√≥rio:</strong><br>
                        ${error.message}<br>
                        <small class="text-muted">Stack: ${error.stack}</small>
                    </div>
                `;
                displayDiv.style.display = 'none';
                console.error('Erro completo:', error);
            }
        }

        function mostrarDadosBrutos() {
            const dadosDiv = document.getElementById('dados-brutos');
            
            if (dadosDiv.style.display === 'none') {
                dadosDiv.innerHTML = `
                    <h5>Caminh√µes (${caminhoes.length}):</h5>
                    <pre>${JSON.stringify(caminhoes, null, 2)}</pre>
                    <h5>Abastecimentos (${abastecimentos.length}):</h5>
                    <pre>${JSON.stringify(abastecimentos, null, 2)}</pre>
                `;
                dadosDiv.style.display = 'block';
            } else {
                dadosDiv.style.display = 'none';
            }
        }
    </script>
</body>
</html>
