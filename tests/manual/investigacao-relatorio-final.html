<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Investiga√ß√£o Espec√≠fica - Relat√≥rio de Consumo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .step-counter {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        .result-table {
            border: 2px solid #28a745;
        }
        .result-table th, .result-table td {
            border: 1px solid #6c757d;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">üî¨ Investiga√ß√£o: Por que os dados n√£o aparecem?</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>üéõÔ∏è Controles</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="dataInicio" class="form-label">Data In√≠cio:</label>
                            <input type="date" class="form-control" id="dataInicio" value="2025-05-01">
                        </div>
                        
                        <div class="mb-3">
                            <label for="dataFim" class="form-label">Data Fim:</label>
                            <input type="date" class="form-control" id="dataFim" value="2025-12-31">
                        </div>
                        
                        <div class="mb-3">
                            <label for="caminhaoSelect" class="form-label">Caminh√£o:</label>
                            <select class="form-select" id="caminhaoSelect">
                                <option value="todos">Todos os caminh√µes</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-success w-100 mb-2" onclick="investigarCompleto()">
                            üîç Investigar Problema
                        </button>
                        
                        <button class="btn btn-warning w-100 mb-2" onclick="testarDadosSimples()">
                            üìä Teste Dados Simples
                        </button>
                        
                        <button class="btn btn-info w-100" onclick="limparTudo()">
                            üßπ Limpar Resultados
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>üìã Log de Investiga√ß√£o</h5>
                    </div>
                    <div class="card-body">
                        <div id="logInvestigacao" class="debug-info" style="height: 400px; overflow-y: auto;">
                            Aguardando investiga√ß√£o...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>üéØ √Årea de Teste - relatorioResultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="relatorioResultados" style="border: 2px dashed #dc3545; min-height: 100px; padding: 10px;">
                            <p class="text-center text-muted">Aguardando relat√≥rio...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let investigacaoStep = 0;
        let dadosCarregados = {
            caminhoes: [],
            abastecimentos: []
        };
        
        function log(mensagem, tipo = 'info') {
            investigacaoStep++;
            const logDiv = document.getElementById('logInvestigacao');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : tipo === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            
            logDiv.innerHTML += `<div><span class="step-counter">${investigacaoStep}</span>[${timestamp}] ${emoji} ${mensagem}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limparTudo() {
            document.getElementById('logInvestigacao').innerHTML = 'Log limpo...<hr>';
            document.getElementById('relatorioResultados').innerHTML = '<p class="text-center text-muted">Aguardando relat√≥rio...</p>';
            investigacaoStep = 0;
        }
        
        async function carregarDados() {
            log('üîÑ Iniciando carregamento de dados das APIs...');
            
            try {
                // Carregar caminh√µes
                log('üì° Fazendo requisi√ß√£o para /api/caminhoes...');
                const responseCaminhoes = await fetch('http://localhost:3001/api/caminhoes');
                
                if (!responseCaminhoes.ok) {
                    log(`‚ùå Erro HTTP ${responseCaminhoes.status} ao carregar caminh√µes`, 'error');
                    return false;
                }
                
                dadosCarregados.caminhoes = await responseCaminhoes.json();
                log(`‚úÖ ${dadosCarregados.caminhoes.length} caminh√µes carregados`, 'success');
                
                // Carregar abastecimentos
                log('üì° Fazendo requisi√ß√£o para /api/abastecimentos...');
                const responseAbastecimentos = await fetch('http://localhost:3001/api/abastecimentos');
                
                if (!responseAbastecimentos.ok) {
                    log(`‚ùå Erro HTTP ${responseAbastecimentos.status} ao carregar abastecimentos`, 'error');
                    return false;
                }
                
                dadosCarregados.abastecimentos = await responseAbastecimentos.json();
                log(`‚úÖ ${dadosCarregados.abastecimentos.length} abastecimentos carregados`, 'success');
                
                // Atualizar select de caminh√µes
                const select = document.getElementById('caminhaoSelect');
                select.innerHTML = '<option value="todos">Todos os caminh√µes</option>';
                dadosCarregados.caminhoes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.placa} - ${c.modelo}</option>`;
                });
                log(`üîÑ Select de caminh√µes atualizado com ${dadosCarregados.caminhoes.length} op√ß√µes`, 'success');
                
                return true;
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testarDadosSimples() {
            log('üß™ INICIANDO TESTE DE DADOS SIMPLES');
            
            if (dadosCarregados.abastecimentos.length === 0) {
                log('‚ö†Ô∏è Dados n√£o carregados, carregando primeiro...', 'warning');
                await carregarDados();
            }
            
            // Criar dados de teste super simples
            const htmlTeste = `
                <h4>üß™ TESTE SIMPLES</h4>
                <table class="table table-bordered result-table">
                    <thead class="table-primary">
                        <tr>
                            <th>Caminh√£o</th>
                            <th>Dist√¢ncia</th>
                            <th>Combust√≠vel</th>
                            <th>Consumo</th>
                            <th>Gasto</th>
                            <th>Custo/km</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>MGK-9637 - 3/4 710</td>
                            <td>349 km</td>
                            <td>150.00 L</td>
                            <td>2.33 km/l</td>
                            <td>R$ 1.080,00</td>
                            <td>R$ 3,09</td>
                        </tr>
                        <tr>
                            <td>IYC-0D05 - Mercedes</td>
                            <td>499 km</td>
                            <td>200.00 L</td>
                            <td>2.50 km/l</td>
                            <td>R$ 1.398,00</td>
                            <td>R$ 2,80</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            log('üìù HTML de teste gerado');
            log('üéØ Inserindo HTML no elemento relatorioResultados...');
            
            const elemento = document.getElementById('relatorioResultados');
            if (!elemento) {
                log('‚ùå ELEMENTO relatorioResultados N√ÉO ENCONTRADO!', 'error');
                return;
            }
            
            elemento.innerHTML = htmlTeste;
            log('‚úÖ HTML inserido com sucesso!', 'success');
            
            // Verificar se foi mesmo inserido
            setTimeout(() => {
                const conteudo = elemento.innerHTML;
                log(`üîç Verifica√ß√£o: Elemento cont√©m ${conteudo.length} caracteres`);
                log(`üîç Cont√©m tabela: ${conteudo.includes('<table') ? 'SIM' : 'N√ÉO'}`);
                log(`üîç Cont√©m dados: ${conteudo.includes('MGK-9637') ? 'SIM' : 'N√ÉO'}`);
            }, 500);
        }
        
        async function investigarCompleto() {
            log('üöÄ INICIANDO INVESTIGA√á√ÉO COMPLETA DO PROBLEMA');
            
            // Passo 1: Carregar dados
            log('üìã PASSO 1: Carregando dados das APIs...');
            const dadosOk = await carregarDados();
            if (!dadosOk) {
                log('‚ùå FALHA: N√£o foi poss√≠vel carregar dados das APIs', 'error');
                return;
            }
            
            // Passo 2: Validar par√¢metros
            log('üìã PASSO 2: Validando par√¢metros de entrada...');
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const caminhaoId = document.getElementById('caminhaoSelect').value;
            
            log(`üìÖ Data in√≠cio: ${dataInicio}`);
            log(`üìÖ Data fim: ${dataFim}`);
            log(`üöõ Caminh√£o: ${caminhaoId}`);
            
            if (!dataInicio || !dataFim) {
                log('‚ùå FALHA: Datas n√£o informadas', 'error');
                return;
            }
            
            // Passo 3: Filtrar dados
            log('üìã PASSO 3: Filtrando abastecimentos...');
            let abastecimentosFiltrados = dadosCarregados.abastecimentos.filter(a => {
                const dataAb = a.data.split('T')[0]; // Pegar apenas a parte da data
                const dentroIntervalo = dataAb >= dataInicio && dataAb <= dataFim;
                log(`üîç Abastecimento ${a.id}: data=${dataAb}, dentro do intervalo=${dentroIntervalo}`);
                return dentroIntervalo;
            });
            
            log(`‚úÖ ${abastecimentosFiltrados.length} abastecimentos no per√≠odo`, 'success');
            
            if (caminhaoId !== 'todos') {
                const antesFiltroCaminhao = abastecimentosFiltrados.length;
                abastecimentosFiltrados = abastecimentosFiltrados.filter(a => a.caminhao_id === caminhaoId);
                log(`üöõ Filtro por caminh√£o: ${antesFiltroCaminhao} ‚Üí ${abastecimentosFiltrados.length}`);
            }
            
            if (abastecimentosFiltrados.length === 0) {
                log('‚ö†Ô∏è AVISO: Nenhum abastecimento encontrado para os crit√©rios', 'warning');
                document.getElementById('relatorioResultados').innerHTML = 
                    '<div class="alert alert-warning">Nenhum abastecimento encontrado para o per√≠odo selecionado.</div>';
                return;
            }
            
            // Passo 4: Processar dados
            log('üìã PASSO 4: Processando e agrupando dados por caminh√£o...');
            const dadosPorCaminhao = {};
            
            abastecimentosFiltrados.forEach((abast, index) => {
                log(`üîÑ Processando abastecimento ${index + 1}/${abastecimentosFiltrados.length}: ${abast.id}`);
                
                if (!dadosPorCaminhao[abast.caminhao_id]) {
                    const caminhao = dadosCarregados.caminhoes.find(c => c.id === abast.caminhao_id);
                    log(`üöõ Novo caminh√£o: ${caminhao ? caminhao.placa : 'Desconhecido'}`);
                    
                    dadosPorCaminhao[abast.caminhao_id] = {
                        id: abast.caminhao_id,
                        placa: caminhao ? caminhao.placa : 'Desconhecido',
                        modelo: caminhao ? caminhao.modelo : 'Desconhecido',
                        totalKm: 0,
                        totalLitros: 0,
                        totalGasto: 0,
                        abastecimentos: []
                    };
                }
                
                // Calcular valores
                const kmInicial = parseFloat(abast.km_inicial || 0);
                const kmFinal = parseFloat(abast.km_final || 0);
                const litros = parseFloat(abast.litros || 0);
                const valorTotal = parseFloat(abast.valor_total || 0);
                const distancia = kmFinal - kmInicial;
                
                log(`üìä C√°lculos: ${kmInicial}‚Üí${kmFinal} = ${distancia}km, ${litros}L, R$${valorTotal}`);
                
                dadosPorCaminhao[abast.caminhao_id].totalKm += distancia;
                dadosPorCaminhao[abast.caminhao_id].totalLitros += litros;
                dadosPorCaminhao[abast.caminhao_id].totalGasto += valorTotal;
                dadosPorCaminhao[abast.caminhao_id].abastecimentos.push(abast);
            });
            
            // Passo 5: Calcular m√©dias
            log('üìã PASSO 5: Calculando consumo m√©dio e custo por km...');
            Object.values(dadosPorCaminhao).forEach(dados => {
                dados.mediaConsumo = dados.totalLitros > 0 ? 
                    (dados.totalKm / dados.totalLitros).toFixed(2) : 'N/A';
                dados.custoMedio = dados.totalKm > 0 ? 
                    (dados.totalGasto / dados.totalKm).toFixed(2) : 'N/A';
                    
                log(`üìà ${dados.placa}: ${dados.totalKm}km, ${dados.totalLitros}L, consumo=${dados.mediaConsumo}km/l, custo=R$${dados.custoMedio}/km`);
            });
            
            // Passo 6: Gerar HTML
            log('üìã PASSO 6: Gerando HTML da tabela...');
            
            let html = `
                <h4 class="mb-3">üèÅ Relat√≥rio de Consumo - ${formatDate(dataInicio)} a ${formatDate(dataFim)}</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered result-table">
                        <thead class="table-primary">
                            <tr>
                                <th>Caminh√£o</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Combust√≠vel (L)</th>
                                <th>Consumo M√©dio (km/l)</th>
                                <th>Gasto Total (R$)</th>
                                <th>Custo por km (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.values(dadosPorCaminhao).forEach(dados => {
                log(`üîß Adicionando linha: ${dados.placa}`);
                html += `
                    <tr>
                        <td><strong>${dados.placa}</strong> - ${dados.modelo}</td>
                        <td class="text-end">${dados.totalKm.toLocaleString('pt-BR')}</td>
                        <td class="text-end">${dados.totalLitros.toFixed(2)}</td>
                        <td class="text-end"><strong>${dados.mediaConsumo}</strong></td>
                        <td class="text-end">R$ <strong>${dados.totalGasto.toFixed(2)}</strong></td>
                        <td class="text-end">R$ <strong>${dados.custoMedio}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-success mt-3">
                    ‚úÖ Relat√≥rio gerado com sucesso! ${Object.keys(dadosPorCaminhao).length} caminh√£o(√µes) processado(s).
                </div>
            `;
            
            log(`üìù HTML gerado: ${html.length} caracteres`);
            
            // Passo 7: Inserir no DOM
            log('üìã PASSO 7: Inserindo HTML no elemento relatorioResultados...');
            
            const elemento = document.getElementById('relatorioResultados');
            if (!elemento) {
                log('‚ùå CR√çTICO: Elemento relatorioResultados n√£o encontrado!', 'error');
                return;
            }
            
            log('üéØ Elemento encontrado, inserindo HTML...');
            elemento.innerHTML = html;
            log('‚úÖ HTML inserido no elemento!', 'success');
            
            // Passo 8: Valida√ß√£o final
            setTimeout(() => {
                log('üìã PASSO 8: Valida√ß√£o final...');
                const conteudoFinal = elemento.innerHTML;
                log(`üîç Conte√∫do final: ${conteudoFinal.length} caracteres`);
                log(`üîç Cont√©m tabela: ${conteudoFinal.includes('<table') ? 'SIM' : 'N√ÉO'}`);
                log(`üîç Cont√©m dados do caminh√£o: ${conteudoFinal.includes('MGK-9637') || conteudoFinal.includes('IYC-0D05') ? 'SIM' : 'N√ÉO'}`);
                log(`üîç Cont√©m valores monet√°rios: ${conteudoFinal.includes('R$') ? 'SIM' : 'N√ÉO'}`);
                
                if (conteudoFinal.includes('<table') && conteudoFinal.includes('R$')) {
                    log('üéâ SUCESSO TOTAL! O relat√≥rio foi gerado e exibido corretamente!', 'success');
                } else {
                    log('‚ùå PROBLEMA DETECTADO: HTML n√£o foi inserido corretamente', 'error');
                }
            }, 1000);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        // Carregar dados ao inicializar
        window.addEventListener('load', () => {
            log('üåü P√°gina carregada, aguardando comando...');
        });
    </script>
</body>
</html>
