<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - PDF com Caracteres Corrigidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .status-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .status-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-primary">üß™ Teste de PDF com Caracteres Corrigidos</h1>
        <p class="lead">Valida√ß√£o das corre√ß√µes de caracteres especiais, acentos e emojis no PDF</p>

        <div class="test-section">
            <h3>Status da Corre√ß√£o</h3>
            <div id="statusCorrecao" class="status-box status-warning">
                <strong>‚è≥ Aguardando teste...</strong>
                <p>Clique no bot√£o abaixo para testar a gera√ß√£o de PDF</p>
            </div>
        </div>

        <div class="test-section">
            <h3>Dados de Teste</h3>
            <p>O teste ir√° gerar um PDF com os seguintes elementos problem√°ticos que foram corrigidos:</p>
            <ul>
                <li><strong>Se√ß√µes com acentos:</strong> ALERTAS POR VE√çCULO ‚Üí ALERTAS POR VEICULO</li>
                <li><strong>Emojis de status:</strong> üî¥ Cr√≠tico ‚Üí CRITICO</li>
                <li><strong>S√≠mbolos Unicode:</strong> ‚ö†Ô∏è ‚Üí ATENCAO</li>
                <li><strong>Caracteres especiais:</strong> √ß, √£, √µ, √°, √© ‚Üí c, a, o, a, e</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>Teste de Gera√ß√£o</h3>
            <div class="row">
                <div class="col-md-6">
                    <button id="btnTestarPDF" class="btn btn-primary btn-lg w-100">
                        üìÑ Gerar PDF de Teste
                    </button>
                </div>
                <div class="col-md-6">
                    <button id="btnTestarPDFCompleto" class="btn btn-success btn-lg w-100">
                        üìä Gerar PDF Completo
                    </button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Resultados do Teste</h3>
            <div id="resultadosTeste">
                <p class="text-muted">Nenhum teste executado ainda.</p>
            </div>
        </div>

        <div class="test-section">
            <h3>Log de Debugging</h3>
            <div id="logDebug" class="bg-light p-3" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <!-- Logs aparecer√£o aqui -->
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function adicionarLog(mensagem, tipo = 'info') {
            const logDiv = document.getElementById('logDebug');
            const timestamp = new Date().toLocaleTimeString();
            const cor = tipo === 'error' ? 'red' : tipo === 'success' ? 'green' : tipo === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${cor}">[${timestamp}] ${mensagem}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Fun√ß√£o para atualizar status
        function atualizarStatus(mensagem, tipo = 'warning') {
            const statusDiv = document.getElementById('statusCorrecao');
            statusDiv.className = `status-box status-${tipo}`;
            statusDiv.innerHTML = `<strong>${mensagem}</strong>`;
        }

        // Dados de teste simulados
        const dadosTeste = {
            valid: true,
            periodo: { 
                inicio: '2024-01-01', 
                fim: '2024-01-31' 
            },
            totalCaminhoes: 3,
            totalAbastecimentos: 15,
            dadosPorCaminhao: {
                '1': {
                    id: '1',
                    placa: 'ABC-1234',
                    modelo: 'Volvo FH',
                    totalKm: 5500,
                    totalLitros: 1100,
                    totalGasto: 6600,
                    mediaConsumo: 5.0,
                    custoMedio: 1.2,
                    valorMedioLitro: 6.0,
                    abastecimentos: [
                        { data: '2024-01-15', motorista: 'Jo√£o', kmInicial: 1000, kmFinal: 1500, litros: 100, valorTotal: 600 }
                    ]
                },
                '2': {
                    id: '2',
                    placa: 'DEF-5678',
                    modelo: 'Mercedes Actros',
                    totalKm: 4200,
                    totalLitros: 900,
                    totalGasto: 5400,
                    mediaConsumo: 4.7,
                    custoMedio: 1.3,
                    valorMedioLitro: 6.0,
                    abastecimentos: [
                        { data: '2024-01-20', motorista: 'Pedro', kmInicial: 2000, kmFinal: 2400, litros: 85, valorTotal: 510 }
                    ]
                }
            },
            abastecimentosFiltrados: [
                { id: 1, data: '2024-01-15', caminhaoId: '1', motorista: 'Jo√£o', kmInicial: 1000, kmFinal: 1500, litros: 100, valorTotal: 600 },
                { id: 2, data: '2024-01-20', caminhaoId: '2', motorista: 'Pedro', kmInicial: 2000, kmFinal: 2400, litros: 85, valorTotal: 510 }
            ],
            caminhoes: [
                { id: '1', placa: 'ABC-1234', modelo: 'Volvo FH' },
                { id: '2', placa: 'DEF-5678', modelo: 'Mercedes Actros' }
            ],
            totais: {
                gasto: 12000,
                consumo: 2000,
                distancia: 9700,
                totalGasto: 12000,
                totalLitros: 2000,
                totalKm: 9700
            },
            medias: {
                consumo: 4.85,
                custoPorKm: 1.24
            }
        };

        // Fun√ß√£o normalizadora para caracteres (baseada na do relatorios.js)
        function normalizarTextoPDF(texto) {
            if (typeof texto !== 'string') {
                return String(texto || '');
            }
            
            // Mapeamento de emojis para texto
            const emojisParaTexto = {
                'üìä': '[DADOS]',
                '‚õΩ': '[COMBUSTIVEL]',
                'üí∞': '[GASTO]',
                'üìà': '[GRAFICO]',
                'üíµ': '[CUSTO]',
                'üî¢': '[NUMERO]',
                'üí°': '[DICA]',
                'üöó': '[VEICULO]',
                'ü•á': '[1¬∫]',
                'ü•à': '[2¬∫]',
                'ü•â': '[3¬∫]',
                'üìÖ': '[DATA]',
                'üîÑ': '[PROCESSO]',
                '‚ö†Ô∏è': '[ALERTA]',
                '‚úÖ': '[OK]',
                '‚ùå': '[ERRO]',
                'üéØ': '[META]',
                'üî¥': 'CRITICO',
                'üü°': 'MEDIO',
                'üü¢': 'BOM'
            };
            
            let textoNormalizado = texto;
            
            // Substituir emojis
            for (const [emoji, textoEquivalente] of Object.entries(emojisParaTexto)) {
                textoNormalizado = textoNormalizado.replace(new RegExp(emoji, 'g'), textoEquivalente);
            }
            
            // Normalizar acentos
            textoNormalizado = textoNormalizado
                .replace(/[√°√†√¢√£√§]/g, 'a')
                .replace(/[√©√®√™√´]/g, 'e')
                .replace(/[√≠√¨√Æ√Ø]/g, 'i')
                .replace(/[√≥√≤√¥√µ√∂]/g, 'o')
                .replace(/[√∫√π√ª√º]/g, 'u')
                .replace(/[√ß]/g, 'c')
                .replace(/[√Å√Ä√Ç√É√Ñ]/g, 'A')
                .replace(/[√â√à√ä√ã]/g, 'E')
                .replace(/[√ç√å√é√è]/g, 'I')
                .replace(/[√ì√í√î√ï√ñ]/g, 'O')
                .replace(/[√ö√ô√õ√ú]/g, 'U')
                .replace(/[√á]/g, 'C')
                .replace(/[√±]/g, 'n')
                .replace(/[√ë]/g, 'N')
                .trim();
                
            return textoNormalizado;
        }

        // Fun√ß√£o para adicionar texto normalizado ao PDF
        function adicionarTextoPDF(doc, texto, x, y, opcoes = {}) {
            const textoNormalizado = normalizarTextoPDF(texto);
            doc.text(textoNormalizado, x, y, opcoes);
        }

        // Teste da gera√ß√£o de PDF simples
        document.getElementById('btnTestarPDF').addEventListener('click', function() {
            adicionarLog('Iniciando teste de PDF simples...', 'info');
            atualizarStatus('üîÑ Gerando PDF de teste...', 'warning');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Teste de textos com caracteres problem√°ticos
                let yPos = 20;
                
                adicionarLog('Testando t√≠tulos com acentos...', 'info');
                adicionarTextoPDF(doc, 'ALERTAS POR VE√çCULO', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'PROJE√á√ïES FINANCEIRAS FUTURAS', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'ALERTAS E RECOMENDA√á√ïES', 20, yPos);
                yPos += 20;
                
                adicionarLog('Testando emojis e s√≠mbolos...', 'info');
                adicionarTextoPDF(doc, 'üî¥ Status Cr√≠tico', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'üü° Status M√©dio', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'üü¢ Status Bom', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, '‚ö†Ô∏è Alerta de Manuten√ß√£o', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, '‚úÖ Recomenda√ß√£o: Realizar manuten√ß√£o', 20, yPos);
                yPos += 20;
                
                adicionarLog('Testando caracteres especiais em dados...', 'info');
                adicionarTextoPDF(doc, 'Motorista: Jo√£o Silva', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'Dist√¢ncia percorrida: 1.500 km', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'Consumo m√©dio: 5,2 km/L', 20, yPos);
                yPos += 10;
                
                // Salvar PDF
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const nomeArquivo = `teste-pdf-caracteres-${timestamp}.pdf`;
                doc.save(nomeArquivo);
                
                adicionarLog(`PDF salvo como: ${nomeArquivo}`, 'success');
                atualizarStatus('‚úÖ PDF de teste gerado com sucesso!', 'success');
                
                document.getElementById('resultadosTeste').innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ Teste Conclu√≠do com Sucesso!</h5>
                        <p><strong>Arquivo gerado:</strong> ${nomeArquivo}</p>
                        <p><strong>Caracteres testados:</strong></p>
                        <ul>
                            <li>Acentos: √ß, √£, √µ, √°, √© ‚Üí normalizados</li>
                            <li>Emojis: üî¥, üü°, üü¢, ‚ö†Ô∏è, ‚úÖ ‚Üí convertidos para texto</li>
                            <li>T√≠tulos de se√ß√µes: normalizados</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                adicionarLog(`Erro durante gera√ß√£o: ${error.message}`, 'error');
                atualizarStatus('‚ùå Erro na gera√ß√£o do PDF', 'error');
                
                document.getElementById('resultadosTeste').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Erro no Teste</h5>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique o console para mais detalhes.</p>
                    </div>
                `;
            }
        });

        // Teste da gera√ß√£o de PDF completo (simula√ß√£o das fun√ß√µes do sistema)
        document.getElementById('btnTestarPDFCompleto').addEventListener('click', function() {
            adicionarLog('Iniciando teste de PDF completo...', 'info');
            atualizarStatus('üîÑ Gerando PDF completo de teste...', 'warning');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Simular as se√ß√µes problem√°ticas do relat√≥rio
                let yPos = 20;
                
                // Capa
                adicionarLog('Gerando capa...', 'info');
                doc.setFillColor(41, 128, 185);
                doc.rect(10, 20, 190, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                adicionarTextoPDF(doc, 'RELATORIO DE COMBUSTIVEL', 105, 40, { align: 'center' });
                
                // Nova p√°gina - Indicadores
                doc.addPage();
                yPos = 20;
                
                adicionarLog('Gerando se√ß√£o de indicadores...', 'info');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                adicionarTextoPDF(doc, 'INDICADORES DE PERFORMANCE', 20, yPos);
                yPos += 20;
                
                // Tabela com dados
                doc.setFontSize(12);
                adicionarTextoPDF(doc, 'ALERTAS POR VEICULO', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'CRITICO: Veiculo ABC-1234 precisa atencao', 20, yPos);
                yPos += 8;
                
                adicionarTextoPDF(doc, 'MEDIO: Veiculo DEF-5678 monitoramento', 20, yPos);
                yPos += 8;
                
                adicionarTextoPDF(doc, 'BOM: Veiculo GHI-9012 performance adequada', 20, yPos);
                yPos += 20;
                
                adicionarTextoPDF(doc, 'PROJECOES FINANCEIRAS FUTURAS', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'Gasto projetado: R$ 15.000,00', 20, yPos);
                yPos += 8;
                
                adicionarTextoPDF(doc, 'Economia potencial: R$ 2.500,00', 20, yPos);
                yPos += 20;
                
                adicionarTextoPDF(doc, 'ALERTAS E RECOMENDACOES', 20, yPos);
                yPos += 10;
                
                adicionarTextoPDF(doc, 'RECOMENDACAO: Realizar manutencao preventiva', 20, yPos);
                yPos += 8;
                
                adicionarTextoPDF(doc, 'ATENCAO: Monitorar consumo dos veiculos', 20, yPos);
                yPos += 8;
                
                adicionarTextoPDF(doc, 'CUSTO ALTO: Revisar rotas de alguns veiculos', 20, yPos);
                
                // Salvar PDF
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const nomeArquivo = `teste-pdf-completo-${timestamp}.pdf`;
                doc.save(nomeArquivo);
                
                adicionarLog(`PDF completo salvo como: ${nomeArquivo}`, 'success');
                atualizarStatus('‚úÖ PDF completo gerado com sucesso!', 'success');
                
                document.getElementById('resultadosTeste').innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ Teste Completo Finalizado!</h5>
                        <p><strong>Arquivo gerado:</strong> ${nomeArquivo}</p>
                        <p><strong>Se√ß√µes testadas:</strong></p>
                        <ul>
                            <li>‚úÖ ALERTAS POR VEICULO (sem acento)</li>
                            <li>‚úÖ PROJECOES FINANCEIRAS FUTURAS (sem acentos)</li>
                            <li>‚úÖ ALERTAS E RECOMENDACOES (sem acentos)</li>
                            <li>‚úÖ Status CRITICO, MEDIO, BOM (sem emojis)</li>
                            <li>‚úÖ ATENCAO, RECOMENDACAO (sem s√≠mbolos Unicode)</li>
                        </ul>
                        <p><strong>Status:</strong> Todas as corre√ß√µes aplicadas com sucesso!</p>
                    </div>
                `;
                
            } catch (error) {
                adicionarLog(`Erro durante gera√ß√£o completa: ${error.message}`, 'error');
                atualizarStatus('‚ùå Erro na gera√ß√£o do PDF completo', 'error');
                
                document.getElementById('resultadosTeste').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Erro no Teste Completo</h5>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique o console para mais detalhes.</p>
                    </div>
                `;
            }
        });

        // Log inicial
        adicionarLog('Sistema de teste carregado', 'success');
        adicionarLog('Biblioteca jsPDF carregada: ' + (typeof window.jspdf !== 'undefined'), 'info');
        
    </script>
</body>
</html>
