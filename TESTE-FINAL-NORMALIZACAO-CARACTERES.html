<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Normaliza√ß√£o de Caracteres PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .emoji-test {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .emoji-original {
            font-size: 18px;
            color: #e74c3c;
        }
        .emoji-converted {
            font-size: 14px;
            color: #27ae60;
            font-weight: bold;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #3498db;
            background: #ecf0f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Final - Normaliza√ß√£o de Caracteres para PDF</h1>
        <p><strong>Objetivo:</strong> Validar que todos os emojis e caracteres especiais s√£o convertidos corretamente para texto compat√≠vel com PDFs seguindo padr√µes ABNT portugueses.</p>
        
        <div class="test-section">
            <h3>üìù Mapeamento de Emojis Testados</h3>
            <div id="emoji-mappings"></div>
        </div>
        
        <div class="test-section">
            <h3>üîß Fun√ß√µes de Teste</h3>
            <button class="test-button" onclick="testarNormalizacao()">Testar Normaliza√ß√£o B√°sica</button>
            <button class="test-button" onclick="testarPDFCompleto()">Gerar PDF de Teste</button>
            <button class="test-button" onclick="testarCasosExtremos()">Testar Casos Extremos</button>
        </div>
        
        <div id="resultados" class="results" style="display: none;"></div>
    </div>

    <script>
        // Fun√ß√£o para converter emojis e caracteres especiais para texto compat√≠vel com PDF
        function normalizarTextoPDF(texto) {
            if (typeof texto !== 'string') {
                return String(texto || '');
            }
            
            // Mapeamento de emojis para texto em portugu√™s (padr√£o ABNT)
            const emojisParaTexto = {
                'üìä': '[DADOS]',
                '‚õΩ': '[COMBUSTIVEL]',
                'üí∞': '[GASTO]',
                'üìà': '[GRAFICO]',
                'üíµ': '[CUSTO]',
                'üî¢': '[NUMERO]',
                'üí°': '[DICA]',
                'üöó': '[VEICULO]',
                'ü•á': '[1¬∫]',
                'ü•à': '[2¬∫]',
                'ü•â': '[3¬∫]',
                'üìÖ': '[DATA]',
                'üîÑ': '[PROCESSO]',
                '‚ö†Ô∏è': '[ALERTA]',
                '‚úÖ': '[OK]',
                '‚ùå': '[ERRO]',
                'üéØ': '[META]',
                'üìã': '[LISTA]',
                'üîç': '[BUSCA]',
                'üì¶': '[PACOTE]',
                'üöÄ': '[LANCAMENTO]',
                '‚≠ê': '[ESTRELA]',
                'üîß': '[MANUTENCAO]',
                'üìù': '[RELATORIO]',
                'üíØ': '[100%]',
                'üèÜ': '[PREMIO]',
                'üéâ': '[CELEBRACAO]',
                'üëç': '[APROVADO]',
                'üëé': '[REPROVADO]',
                '‚ö°': '[RAPIDO]',
                'üî•': '[DESTAQUE]',
                '‚ùó': '[IMPORTANTE]',
                '‚ùì': '[DUVIDA]',
                'üé™': '[EVENTO]',
                'üõ£Ô∏è': '[ESTRADA]',
                'üìâ': '[DECRESCIMO]',
                'üõ¢Ô∏è': '[OLEO]',
                '‚öôÔ∏è': '[CONFIGURACAO]'
            };
            
            // Substituir emojis por texto
            let textoNormalizado = texto;
            for (const [emoji, textoEquivalente] of Object.entries(emojisParaTexto)) {
                textoNormalizado = textoNormalizado.replace(new RegExp(emoji, 'g'), textoEquivalente);
            }
            
            // Remover outros caracteres especiais problem√°ticos
            textoNormalizado = textoNormalizado
                .replace(/[^\x00-\x7F]/g, '') // Remove caracteres n√£o ASCII
                .replace(/√ò/g, 'O')           // Substitui √ò por O
                .replace(/√ú/g, 'U')           // Substitui √ú por U
                .replace(/√à/g, 'E')           // Substitui √à por E
                .replace(/=/g, ' = ')         // Normaliza s√≠mbolos de igualdade
                .replace(/\s+/g, ' ')         // Remove espa√ßos extras
                .trim();                      // Remove espa√ßos no in√≠cio/fim
            
            return textoNormalizado;
        }

        // Fun√ß√£o auxiliar para adicionar texto normalizado ao PDF
        function adicionarTextoPDF(doc, texto, x, y, opcoes = {}) {
            const textoNormalizado = normalizarTextoPDF(texto);
            doc.text(textoNormalizado, x, y, opcoes);
        }

        // Exibir mapeamento de emojis
        function exibirMapeamentos() {
            const emojisParaTexto = {
                'üìä': '[DADOS]',
                '‚õΩ': '[COMBUSTIVEL]',
                'üí∞': '[GASTO]',
                'üìà': '[GRAFICO]',
                'üíµ': '[CUSTO]',
                'üî¢': '[NUMERO]',
                'üí°': '[DICA]',
                'üöó': '[VEICULO]',
                'ü•á': '[1¬∫]',
                'ü•à': '[2¬∫]',
                'ü•â': '[3¬∫]',
                'üìÖ': '[DATA]',
                'üîÑ': '[PROCESSO]',
                '‚ö†Ô∏è': '[ALERTA]',
                '‚úÖ': '[OK]',
                '‚ùå': '[ERRO]',
                'üéØ': '[META]',
                'üìã': '[LISTA]',
                'üîç': '[BUSCA]',
                'üîß': '[MANUTENCAO]',
                'üìù': '[RELATORIO]',
                'üõ£Ô∏è': '[ESTRADA]',
                'üìâ': '[DECRESCIMO]',
                'üõ¢Ô∏è': '[OLEO]',
                '‚öôÔ∏è': '[CONFIGURACAO]'
            };

            const container = document.getElementById('emoji-mappings');
            container.innerHTML = '';
            
            Object.entries(emojisParaTexto).forEach(([emoji, texto]) => {
                const div = document.createElement('div');
                div.className = 'emoji-test';
                div.innerHTML = `
                    <span class="emoji-original">${emoji}</span>
                    <span>‚Üí</span>
                    <span class="emoji-converted">${texto}</span>
                `;
                container.appendChild(div);
            });
        }

        // Teste b√°sico de normaliza√ß√£o
        function testarNormalizacao() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const testesBasicos = [
                'üìä Quilometragem Total: 15.000 km',
                '‚õΩ Combust√≠vel Total: 500 litros',
                'üí∞ Gasto Total: R$ 2.500,00',
                'üìà Consumo: 8.5 L/100km',
                'üíµ Custo/km: R$ 0.50',
                'üî¢ Abastecimentos: 25',
                '‚úÖ Status: Aprovado',
                '‚ö†Ô∏è Aten√ß√£o: Revisar',
                'Texto com caracteres especiais: √òxigen √úber √àconomia'
            ];
            
            let html = '<h3>‚úÖ Resultados do Teste de Normaliza√ß√£o</h3>';
            let sucessos = 0;
            let falhas = 0;
            
            testesBasicos.forEach((teste, index) => {
                const original = teste;
                const normalizado = normalizarTextoPDF(teste);
                const temEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{27BF}]/u.test(original);
                const temEmojiNormalizado = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{27BF}]/u.test(normalizado);
                
                const sucesso = !temEmojiNormalizado;
                if (sucesso) sucessos++;
                else falhas++;
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid ${sucesso ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${sucesso ? '#d4edda' : '#f8d7da'};">
                        <strong>Teste ${index + 1}:</strong><br>
                        <strong>Original:</strong> <code>${original}</code><br>
                        <strong>Normalizado:</strong> <code>${normalizado}</code><br>
                        <strong>Status:</strong> <span style="color: ${sucesso ? '#28a745' : '#dc3545'};">${sucesso ? '‚úÖ SUCESSO' : '‚ùå FALHA'}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="success" style="margin-top: 20px;">
                    <h4>üìä Resumo dos Testes:</h4>
                    <p>‚úÖ Sucessos: ${sucessos}</p>
                    <p>‚ùå Falhas: ${falhas}</p>
                    <p><strong>Taxa de Sucesso: ${((sucessos / testesBasicos.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Gerar PDF de teste
        function testarPDFCompleto() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // T√≠tulo
                doc.setFontSize(16);
                doc.text('TESTE DE NORMALIZACAO DE CARACTERES', 105, 20, { align: 'center' });
                
                let yPos = 40;
                
                // Teste de emojis diversos
                const testesEmojis = [
                    'üìä Dados: Este √© um teste de dados',
                    '‚õΩ Combust√≠vel: 500 litros consumidos',
                    'üí∞ Gasto: R$ 2.500,00 no per√≠odo',
                    'üìà Gr√°fico: Tend√™ncia de alta',
                    'üíµ Custo: R$ 0,50 por quil√¥metro',
                    'üî¢ N√∫mero: 150 abastecimentos',
                    '‚úÖ OK: Sistema funcionando',
                    '‚ö†Ô∏è Alerta: Verificar consumo',
                    'üéØ Meta: Reduzir 10% dos custos',
                    'üîß Manuten√ß√£o: Revisar motor'
                ];
                
                doc.setFontSize(12);
                testesEmojis.forEach(teste => {
                    adicionarTextoPDF(doc, teste, 20, yPos);
                    yPos += 10;
                });
                
                // Salvar PDF
                const nomeArquivo = `teste-normalizacao-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ PDF de Teste Gerado com Sucesso!</h3>
                        <p><strong>Arquivo:</strong> ${nomeArquivo}</p>
                        <p>O PDF foi baixado e cont√©m textos normalizados sem emojis problem√°ticos.</p>
                        <p><em>Abra o arquivo para verificar que todos os emojis foram convertidos para texto ABNT-compat√≠vel.</em></p>
                    </div>
                `;
                
            } catch (error) {
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro na Gera√ß√£o do PDF</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique se a biblioteca jsPDF est√° carregada corretamente.</p>
                    </div>
                `;
            }
        }

        // Testar casos extremos
        function testarCasosExtremos() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const testesExtremos = [
                '',  // String vazia
                null,  // Valor nulo
                undefined,  // Indefinido
                123,  // N√∫mero
                'üöóüöóüöó M√∫ltiplos emojis seguidos üìäüìàüí∞',
                'Texto sem emojis normais',
                '   Espa√ßos   extras   m√∫ltiplos   ',
                '√á√£√µ√Å√â√ç√ì√ö √†√® caracteres acentuados',
                '√òxygen √úbung √àconomic Special Chars',
                'üí∞üí∞üí∞ R$ 1.000,00 üî•üî•üî•',
                'Mix: texto üìä normal ‚õΩ com üí∞ emojis üìà intercalados'
            ];
            
            let html = '<h3>üß™ Resultados dos Testes Extremos</h3>';
            let sucessos = 0;
            
            testesExtremos.forEach((teste, index) => {
                try {
                    const normalizado = normalizarTextoPDF(teste);
                    const semErros = typeof normalizado === 'string';
                    if (semErros) sucessos++;
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid ${semErros ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${semErros ? '#d4edda' : '#f8d7da'};">
                            <strong>Teste Extremo ${index + 1}:</strong><br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Output:</strong> <code>${normalizado}</code><br>
                            <strong>Tipo:</strong> ${typeof normalizado}<br>
                            <strong>Status:</strong> <span style="color: ${semErros ? '#28a745' : '#dc3545'};">${semErros ? '‚úÖ OK' : '‚ùå ERRO'}</span>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da;">
                            <strong>Teste Extremo ${index + 1}:</strong><br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Erro:</strong> <code>${error.message}</code><br>
                            <strong>Status:</strong> <span style="color: #dc3545;">‚ùå EXCE√á√ÉO</span>
                        </div>
                    `;
                }
            });
            
            html += `
                <div class="success" style="margin-top: 20px;">
                    <h4>üìä Resumo dos Testes Extremos:</h4>
                    <p>‚úÖ Casos tratados corretamente: ${sucessos}</p>
                    <p>üìù Total de casos testados: ${testesExtremos.length}</p>
                    <p><strong>Taxa de Robustez: ${((sucessos / testesExtremos.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            exibirMapeamentos();
        });
    </script>
</body>
</html>
