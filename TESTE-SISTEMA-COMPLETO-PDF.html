<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema Completo - GeraÃ§Ã£o de PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
            margin: 10px 0;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste Sistema Completo - NormalizaÃ§Ã£o PDF</h1>
        <p><strong>Status:</strong> Sistema de normalizaÃ§Ã£o de caracteres implementado e pronto para teste</p>
        
        <div class="test-section">
            <h3>ğŸ“‹ Testes DisponÃ­veis</h3>
            <button class="test-button" onclick="testarNormalizacaoBasica()">Teste BÃ¡sico</button>
            <button class="test-button" onclick="testarRelatorioCompleto()">RelatÃ³rio Completo</button>
            <button class="test-button" onclick="testarCasosLimite()">Casos Limite</button>
            <button class="test-button" onclick="validarImplementacao()">Validar ImplementaÃ§Ã£o</button>
        </div>
        
        <div id="resultados" class="results" style="display: none;"></div>
    </div>

    <script>
        // FunÃ§Ã£o de normalizaÃ§Ã£o (copiada do sistema principal)
        function normalizarTextoPDF(texto) {
            if (typeof texto !== 'string') {
                return String(texto || '');
            }
            
            // Mapeamento de emojis para texto em portuguÃªs (padrÃ£o ABNT)
            const emojisParaTexto = {
                'ğŸ“Š': '[DADOS]',
                'â›½': '[COMBUSTIVEL]',
                'ğŸ’°': '[GASTO]',
                'ğŸ“ˆ': '[GRAFICO]',
                'ğŸ’µ': '[CUSTO]',
                'ğŸ”¢': '[NUMERO]',
                'ğŸ’¡': '[DICA]',
                'ğŸš—': '[VEICULO]',
                'ğŸ¥‡': '[1Âº]',
                'ğŸ¥ˆ': '[2Âº]',
                'ğŸ¥‰': '[3Âº]',
                'ğŸ“…': '[DATA]',
                'ğŸ”„': '[PROCESSO]',
                'âš ï¸': '[ALERTA]',
                'âœ…': '[OK]',
                'âŒ': '[ERRO]',
                'ğŸ¯': '[META]',
                'ğŸ“‹': '[LISTA]',
                'ğŸ”': '[BUSCA]',
                'ğŸ“¦': '[PACOTE]',
                'ğŸš€': '[LANCAMENTO]',
                'â­': '[ESTRELA]',
                'ğŸ”§': '[MANUTENCAO]',
                'ğŸ“': '[RELATORIO]',
                'ğŸ’¯': '[100%]',
                'ğŸ†': '[PREMIO]',
                'ğŸ‰': '[CELEBRACAO]',
                'ğŸ‘': '[APROVADO]',
                'ğŸ‘': '[REPROVADO]',
                'âš¡': '[RAPIDO]',
                'ğŸ”¥': '[DESTAQUE]',
                'â—': '[IMPORTANTE]',
                'â“': '[DUVIDA]',
                'ğŸª': '[EVENTO]',
                'ğŸ›£ï¸': '[ESTRADA]',
                'ğŸ“‰': '[DECRESCIMO]',
                'ğŸ›¢ï¸': '[OLEO]',
                'âš™ï¸': '[CONFIGURACAO]'
            };
            
            // Substituir emojis por texto
            let textoNormalizado = texto;
            for (const [emoji, textoEquivalente] of Object.entries(emojisParaTexto)) {
                textoNormalizado = textoNormalizado.replace(new RegExp(emoji, 'g'), textoEquivalente);
            }
            
            // Remover outros caracteres especiais problemÃ¡ticos
            textoNormalizado = textoNormalizado
                .replace(/[^\x00-\x7F]/g, '') // Remove caracteres nÃ£o ASCII
                .replace(/Ã˜/g, 'O')           // Substitui Ã˜ por O
                .replace(/Ãœ/g, 'U')           // Substitui Ãœ por U
                .replace(/Ãˆ/g, 'E')           // Substitui Ãˆ por E
                .replace(/=/g, ' = ')         // Normaliza sÃ­mbolos de igualdade
                .replace(/\s+/g, ' ')         // Remove espaÃ§os extras
                .trim();                      // Remove espaÃ§os no inÃ­cio/fim
            
            return textoNormalizado;
        }

        // FunÃ§Ã£o auxiliar para adicionar texto normalizado ao PDF
        function adicionarTextoPDF(doc, texto, x, y, opcoes = {}) {
            const textoNormalizado = normalizarTextoPDF(texto);
            doc.text(textoNormalizado, x, y, opcoes);
        }

        // Teste bÃ¡sico de normalizaÃ§Ã£o
        function testarNormalizacaoBasica() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const testesBasicos = [
                'ğŸ“Š RelatÃ³rio de Consumo: Janeiro 2025',
                'â›½ Total de CombustÃ­vel: 1.250 litros',
                'ğŸ’° Gasto Total: R$ 6.750,00',
                'ğŸ“ˆ EficiÃªncia: 85% do esperado',
                'ğŸ’µ Custo por km: R$ 0,45',
                'ğŸ”§ ManutenÃ§Ãµes realizadas: 3',
                'âœ… Status: Sistema funcionando',
                'âš ï¸ AtenÃ§Ã£o: Consumo acima da mÃ©dia'
            ];
            
            let html = '<h3>âœ… Teste BÃ¡sico de NormalizaÃ§Ã£o</h3>';
            let sucessos = 0;
            
            testesBasicos.forEach((teste, index) => {
                const original = teste;
                const normalizado = normalizarTextoPDF(teste);
                const temEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{27BF}]/u.test(original);
                const foiNormalizado = original !== normalizado;
                const sucesso = temEmoji ? foiNormalizado : true;
                
                if (sucesso) sucessos++;
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid ${sucesso ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${sucesso ? '#d4edda' : '#f8d7da'};">
                        <strong>Teste ${index + 1}:</strong><br>
                        <strong>Original:</strong> ${original}<br>
                        <strong>Normalizado:</strong> ${normalizado}<br>
                        <strong>Status:</strong> ${sucesso ? 'âœ… OK' : 'âŒ FALHA'}
                    </div>
                `;
            });
            
            html += `
                <div class="info">
                    <h4>ğŸ“Š Resumo do Teste BÃ¡sico</h4>
                    <p>âœ… Sucessos: ${sucessos}</p>
                    <p>âŒ Falhas: ${testesBasicos.length - sucessos}</p>
                    <p><strong>Taxa de Sucesso: ${((sucessos / testesBasicos.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Teste de relatÃ³rio completo
        function testarRelatorioCompleto() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // SimulaÃ§Ã£o de dados reais do sistema
                const dadosSimulados = {
                    periodo: 'Janeiro 2025',
                    totalKm: 15750,
                    totalLitros: 1250,
                    gastoTotal: 6750.50,
                    consumoMedio: 7.94,
                    custoKm: 0.429,
                    manutencoes: 3,
                    abastecimentos: 18
                };
                
                // TÃ­tulo do relatÃ³rio
                doc.setFontSize(16);
                adicionarTextoPDF(doc, 'ğŸ“Š RELATÃ“RIO DE CONTROLE DE COMBUSTÃVEL', 105, 20, { align: 'center' });
                
                let yPos = 40;
                doc.setFontSize(12);
                
                // Dados principais com emojis
                const linhasRelatorio = [
                    `ğŸ“… PerÃ­odo: ${dadosSimulados.periodo}`,
                    `ğŸš— Quilometragem Total: ${dadosSimulados.totalKm.toLocaleString()} km`,
                    `â›½ CombustÃ­vel Consumido: ${dadosSimulados.totalLitros.toLocaleString()} litros`,
                    `ğŸ’° Gasto Total: R$ ${dadosSimulados.gastoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                    `ğŸ“ˆ Consumo MÃ©dio: ${dadosSimulados.consumoMedio.toFixed(2)} L/100km`,
                    `ğŸ’µ Custo por km: R$ ${dadosSimulados.custoKm.toFixed(3)}`,
                    `ğŸ”§ ManutenÃ§Ãµes Realizadas: ${dadosSimulados.manutencoes}`,
                    `â›½ Abastecimentos: ${dadosSimulados.abastecimentos}`,
                    '',
                    'ğŸ“Š ANÃLISE DE DESEMPENHO:',
                    'âœ… Consumo dentro do esperado',
                    'âš ï¸ Custos 5% acima da meta',
                    'ğŸ¯ Meta para prÃ³ximo mÃªs: reduzir 3% do consumo',
                    '',
                    'ğŸ”§ RECOMENDAÃ‡Ã•ES:',
                    'â€¢ Verificar pressÃ£o dos pneus',
                    'â€¢ Revisar filtro de ar',
                    'â€¢ Agendar manutenÃ§Ã£o preventiva'
                ];
                
                // Adicionar cada linha ao PDF
                linhasRelatorio.forEach(linha => {
                    if (linha.trim()) {
                        adicionarTextoPDF(doc, linha, 20, yPos);
                    }
                    yPos += 8;
                });
                
                // Salvar PDF
                const nomeArquivo = `relatorio-teste-completo-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="success">
                        <h3>âœ… RelatÃ³rio Completo Gerado com Sucesso!</h3>
                        <p><strong>Arquivo:</strong> ${nomeArquivo}</p>
                        <p>O PDF foi gerado com ${linhasRelatorio.filter(l => l.trim()).length} linhas de dados normalizados.</p>
                        <p><em>Verifique se todos os emojis foram convertidos corretamente para texto ABNT-compatÃ­vel.</em></p>
                        <h4>ğŸ“‹ Dados IncluÃ­dos:</h4>
                        <ul>
                            <li>PerÃ­odo e datas com emoji ğŸ“…</li>
                            <li>Dados de combustÃ­vel com emoji â›½</li>
                            <li>InformaÃ§Ãµes financeiras com emojis ğŸ’°ğŸ’µ</li>
                            <li>GrÃ¡ficos e anÃ¡lises com emoji ğŸ“ŠğŸ“ˆ</li>
                            <li>Status e alertas com emojis âœ…âš ï¸</li>
                            <li>ManutenÃ§Ãµes com emoji ğŸ”§</li>
                            <li>Metas com emoji ğŸ¯</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="error">
                        <h3>âŒ Erro na GeraÃ§Ã£o do RelatÃ³rio Completo</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique se a biblioteca jsPDF estÃ¡ carregada corretamente.</p>
                    </div>
                `;
            }
        }

        // Teste de casos limite
        function testarCasosLimite() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const casosLimite = [
                '',  // String vazia
                null,  // Valor nulo
                undefined,  // Indefinido
                123,  // NÃºmero
                'ğŸš—ğŸš—ğŸš— MÃºltiplos emojis iguais ğŸ“ŠğŸ“ŠğŸ“Š',
                'Texto normal sem emojis',
                '   EspaÃ§os   mÃºltiplos   e   tabs	',
                'Ã‡Ã£ÃµÃÃ‰ÃÃ“Ãš Ã Ã¨Ã¬Ã²Ã¹ caracteres acentuados',
                'Ã˜xygen Ãœbung Ãˆconomic Special International',
                'ğŸ’°ğŸ’°ğŸ’° R$ 1.000,00 ğŸ”¥ğŸ”¥ğŸ”¥ PROMOÃ‡ÃƒO ğŸ‰ğŸ‰ğŸ‰',
                'Mix: ğŸ“Š dados â›½ combustÃ­vel ğŸ’° gasto ğŸ“ˆ grÃ¡fico intercalados'
            ];
            
            let html = '<h3>âš¡ Teste de Casos Limite</h3>';
            let sucessos = 0;
            
            casosLimite.forEach((teste, index) => {
                try {
                    const normalizado = normalizarTextoPDF(teste);
                    const tipoInput = teste === null ? 'null' : teste === undefined ? 'undefined' : typeof teste;
                    const semErros = typeof normalizado === 'string';
                    if (semErros) sucessos++;
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid ${semErros ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${semErros ? '#d4edda' : '#f8d7da'};">
                            <strong>Caso Limite ${index + 1}:</strong><br>
                            <strong>Tipo Input:</strong> ${tipoInput}<br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Output:</strong> <code>${JSON.stringify(normalizado)}</code><br>
                            <strong>Status:</strong> ${semErros ? 'âœ… OK' : 'âŒ ERRO'}
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da;">
                            <strong>Caso Limite ${index + 1}:</strong><br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Erro:</strong> ${error.message}<br>
                            <strong>Status:</strong> âŒ EXCEÃ‡ÃƒO
                        </div>
                    `;
                }
            });
            
            html += `
                <div class="info">
                    <h4>ğŸ“Š Resumo dos Casos Limite</h4>
                    <p>âœ… Sucessos: ${sucessos}</p>
                    <p>âŒ Falhas: ${casosLimite.length - sucessos}</p>
                    <p><strong>Taxa de Sucesso: ${((sucessos / casosLimite.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Validar implementaÃ§Ã£o
        function validarImplementacao() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            // Verificar se funÃ§Ãµes existem
            const funcoes = [
                { nome: 'normalizarTextoPDF', existe: typeof normalizarTextoPDF === 'function' },
                { nome: 'adicionarTextoPDF', existe: typeof adicionarTextoPDF === 'function' },
                { nome: 'jsPDF', existe: typeof window.jspdf !== 'undefined' }
            ];
            
            // Verificar mapeamentos de emojis
            const emojisTestados = ['ğŸ“Š', 'â›½', 'ğŸ’°', 'ğŸ“ˆ', 'ğŸ’µ', 'ğŸ”§', 'âœ…', 'âš ï¸'];
            const mapeamentosOK = emojisTestados.every(emoji => {
                const resultado = normalizarTextoPDF(emoji);
                return resultado !== emoji && resultado.includes('[') && resultado.includes(']');
            });
            
            let html = '<h3>ğŸ” ValidaÃ§Ã£o da ImplementaÃ§Ã£o</h3>';
            
            // Status das funÃ§Ãµes
            html += '<h4>ğŸ“‹ FunÃ§Ãµes DisponÃ­veis:</h4>';
            funcoes.forEach(funcao => {
                html += `
                    <div style="margin: 5px 0; padding: 8px; border: 1px solid ${funcao.existe ? '#28a745' : '#dc3545'}; border-radius: 3px; background: ${funcao.existe ? '#d4edda' : '#f8d7da'};">
                        ${funcao.existe ? 'âœ…' : 'âŒ'} ${funcao.nome}: ${funcao.existe ? 'DisponÃ­vel' : 'NÃ£o encontrada'}
                    </div>
                `;
            });
            
            // Status dos mapeamentos
            html += '<h4>ğŸ—ºï¸ Mapeamento de Emojis:</h4>';
            html += `
                <div style="margin: 5px 0; padding: 8px; border: 1px solid ${mapeamentosOK ? '#28a745' : '#dc3545'}; border-radius: 3px; background: ${mapeamentosOK ? '#d4edda' : '#f8d7da'};">
                    ${mapeamentosOK ? 'âœ…' : 'âŒ'} Mapeamentos: ${mapeamentosOK ? 'Funcionando corretamente' : 'Com problemas'}
                </div>
            `;
            
            // Teste de exemplos
            html += '<h4>ğŸ§ª Exemplos de ConversÃ£o:</h4>';
            emojisTestados.forEach(emoji => {
                const convertido = normalizarTextoPDF(emoji);
                html += `
                    <div style="margin: 5px 0; padding: 8px; border: 1px solid #17a2b8; border-radius: 3px; background: #d1ecf1;">
                        <code>${emoji}</code> â†’ <code>${convertido}</code>
                    </div>
                `;
            });
            
            // Status geral
            const todosOK = funcoes.every(f => f.existe) && mapeamentosOK;
            html += `
                <div class="${todosOK ? 'success' : 'error'}">
                    <h4>${todosOK ? 'âœ…' : 'âŒ'} Status Geral da ImplementaÃ§Ã£o</h4>
                    <p><strong>Sistema de NormalizaÃ§Ã£o:</strong> ${todosOK ? 'Completamente funcional' : 'Com problemas'}</p>
                    ${todosOK ? '<p>âœ… Pronto para uso em produÃ§Ã£o!</p>' : '<p>âŒ Requer correÃ§Ãµes antes do uso.</p>'}
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Inicializar pÃ¡gina
        window.onload = function() {
            console.log('ğŸ§ª Sistema de Teste de NormalizaÃ§Ã£o PDF carregado');
            console.log('ğŸ“Š FunÃ§Ãµes disponÃ­veis: normalizarTextoPDF, adicionarTextoPDF');
            console.log('ğŸ”§ Biblioteca jsPDF:', typeof window.jspdf !== 'undefined' ? 'Carregada' : 'NÃ£o encontrada');
        };
    </script>
</body>
</html>
