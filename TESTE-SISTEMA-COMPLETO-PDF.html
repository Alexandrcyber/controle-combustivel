<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema Completo - Geração de PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
            margin: 10px 0;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Teste Sistema Completo - Normalização PDF</h1>
        <p><strong>Status:</strong> Sistema de normalização de caracteres implementado e pronto para teste</p>
        
        <div class="test-section">
            <h3>📋 Testes Disponíveis</h3>
            <button class="test-button" onclick="testarNormalizacaoBasica()">Teste Básico</button>
            <button class="test-button" onclick="testarRelatorioCompleto()">Relatório Completo</button>
            <button class="test-button" onclick="testarCasosLimite()">Casos Limite</button>
            <button class="test-button" onclick="validarImplementacao()">Validar Implementação</button>
        </div>
        
        <div id="resultados" class="results" style="display: none;"></div>
    </div>

    <script>
        // Função de normalização (copiada do sistema principal)
        function normalizarTextoPDF(texto) {
            if (typeof texto !== 'string') {
                return String(texto || '');
            }
            
            // Mapeamento de emojis para texto em português (padrão ABNT)
            const emojisParaTexto = {
                '📊': '[DADOS]',
                '⛽': '[COMBUSTIVEL]',
                '💰': '[GASTO]',
                '📈': '[GRAFICO]',
                '💵': '[CUSTO]',
                '🔢': '[NUMERO]',
                '💡': '[DICA]',
                '🚗': '[VEICULO]',
                '🥇': '[1º]',
                '🥈': '[2º]',
                '🥉': '[3º]',
                '📅': '[DATA]',
                '🔄': '[PROCESSO]',
                '⚠️': '[ALERTA]',
                '✅': '[OK]',
                '❌': '[ERRO]',
                '🎯': '[META]',
                '📋': '[LISTA]',
                '🔍': '[BUSCA]',
                '📦': '[PACOTE]',
                '🚀': '[LANCAMENTO]',
                '⭐': '[ESTRELA]',
                '🔧': '[MANUTENCAO]',
                '📝': '[RELATORIO]',
                '💯': '[100%]',
                '🏆': '[PREMIO]',
                '🎉': '[CELEBRACAO]',
                '👍': '[APROVADO]',
                '👎': '[REPROVADO]',
                '⚡': '[RAPIDO]',
                '🔥': '[DESTAQUE]',
                '❗': '[IMPORTANTE]',
                '❓': '[DUVIDA]',
                '🎪': '[EVENTO]',
                '🛣️': '[ESTRADA]',
                '📉': '[DECRESCIMO]',
                '🛢️': '[OLEO]',
                '⚙️': '[CONFIGURACAO]'
            };
            
            // Substituir emojis por texto
            let textoNormalizado = texto;
            for (const [emoji, textoEquivalente] of Object.entries(emojisParaTexto)) {
                textoNormalizado = textoNormalizado.replace(new RegExp(emoji, 'g'), textoEquivalente);
            }
            
            // Remover outros caracteres especiais problemáticos
            textoNormalizado = textoNormalizado
                .replace(/[^\x00-\x7F]/g, '') // Remove caracteres não ASCII
                .replace(/Ø/g, 'O')           // Substitui Ø por O
                .replace(/Ü/g, 'U')           // Substitui Ü por U
                .replace(/È/g, 'E')           // Substitui È por E
                .replace(/=/g, ' = ')         // Normaliza símbolos de igualdade
                .replace(/\s+/g, ' ')         // Remove espaços extras
                .trim();                      // Remove espaços no início/fim
            
            return textoNormalizado;
        }

        // Função auxiliar para adicionar texto normalizado ao PDF
        function adicionarTextoPDF(doc, texto, x, y, opcoes = {}) {
            const textoNormalizado = normalizarTextoPDF(texto);
            doc.text(textoNormalizado, x, y, opcoes);
        }

        // Teste básico de normalização
        function testarNormalizacaoBasica() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const testesBasicos = [
                '📊 Relatório de Consumo: Janeiro 2025',
                '⛽ Total de Combustível: 1.250 litros',
                '💰 Gasto Total: R$ 6.750,00',
                '📈 Eficiência: 85% do esperado',
                '💵 Custo por km: R$ 0,45',
                '🔧 Manutenções realizadas: 3',
                '✅ Status: Sistema funcionando',
                '⚠️ Atenção: Consumo acima da média'
            ];
            
            let html = '<h3>✅ Teste Básico de Normalização</h3>';
            let sucessos = 0;
            
            testesBasicos.forEach((teste, index) => {
                const original = teste;
                const normalizado = normalizarTextoPDF(teste);
                const temEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{27BF}]/u.test(original);
                const foiNormalizado = original !== normalizado;
                const sucesso = temEmoji ? foiNormalizado : true;
                
                if (sucesso) sucessos++;
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid ${sucesso ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${sucesso ? '#d4edda' : '#f8d7da'};">
                        <strong>Teste ${index + 1}:</strong><br>
                        <strong>Original:</strong> ${original}<br>
                        <strong>Normalizado:</strong> ${normalizado}<br>
                        <strong>Status:</strong> ${sucesso ? '✅ OK' : '❌ FALHA'}
                    </div>
                `;
            });
            
            html += `
                <div class="info">
                    <h4>📊 Resumo do Teste Básico</h4>
                    <p>✅ Sucessos: ${sucessos}</p>
                    <p>❌ Falhas: ${testesBasicos.length - sucessos}</p>
                    <p><strong>Taxa de Sucesso: ${((sucessos / testesBasicos.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Teste de relatório completo
        function testarRelatorioCompleto() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Simulação de dados reais do sistema
                const dadosSimulados = {
                    periodo: 'Janeiro 2025',
                    totalKm: 15750,
                    totalLitros: 1250,
                    gastoTotal: 6750.50,
                    consumoMedio: 7.94,
                    custoKm: 0.429,
                    manutencoes: 3,
                    abastecimentos: 18
                };
                
                // Título do relatório
                doc.setFontSize(16);
                adicionarTextoPDF(doc, '📊 RELATÓRIO DE CONTROLE DE COMBUSTÍVEL', 105, 20, { align: 'center' });
                
                let yPos = 40;
                doc.setFontSize(12);
                
                // Dados principais com emojis
                const linhasRelatorio = [
                    `📅 Período: ${dadosSimulados.periodo}`,
                    `🚗 Quilometragem Total: ${dadosSimulados.totalKm.toLocaleString()} km`,
                    `⛽ Combustível Consumido: ${dadosSimulados.totalLitros.toLocaleString()} litros`,
                    `💰 Gasto Total: R$ ${dadosSimulados.gastoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                    `📈 Consumo Médio: ${dadosSimulados.consumoMedio.toFixed(2)} L/100km`,
                    `💵 Custo por km: R$ ${dadosSimulados.custoKm.toFixed(3)}`,
                    `🔧 Manutenções Realizadas: ${dadosSimulados.manutencoes}`,
                    `⛽ Abastecimentos: ${dadosSimulados.abastecimentos}`,
                    '',
                    '📊 ANÁLISE DE DESEMPENHO:',
                    '✅ Consumo dentro do esperado',
                    '⚠️ Custos 5% acima da meta',
                    '🎯 Meta para próximo mês: reduzir 3% do consumo',
                    '',
                    '🔧 RECOMENDAÇÕES:',
                    '• Verificar pressão dos pneus',
                    '• Revisar filtro de ar',
                    '• Agendar manutenção preventiva'
                ];
                
                // Adicionar cada linha ao PDF
                linhasRelatorio.forEach(linha => {
                    if (linha.trim()) {
                        adicionarTextoPDF(doc, linha, 20, yPos);
                    }
                    yPos += 8;
                });
                
                // Salvar PDF
                const nomeArquivo = `relatorio-teste-completo-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="success">
                        <h3>✅ Relatório Completo Gerado com Sucesso!</h3>
                        <p><strong>Arquivo:</strong> ${nomeArquivo}</p>
                        <p>O PDF foi gerado com ${linhasRelatorio.filter(l => l.trim()).length} linhas de dados normalizados.</p>
                        <p><em>Verifique se todos os emojis foram convertidos corretamente para texto ABNT-compatível.</em></p>
                        <h4>📋 Dados Incluídos:</h4>
                        <ul>
                            <li>Período e datas com emoji 📅</li>
                            <li>Dados de combustível com emoji ⛽</li>
                            <li>Informações financeiras com emojis 💰💵</li>
                            <li>Gráficos e análises com emoji 📊📈</li>
                            <li>Status e alertas com emojis ✅⚠️</li>
                            <li>Manutenções com emoji 🔧</li>
                            <li>Metas com emoji 🎯</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                const resultados = document.getElementById('resultados');
                resultados.style.display = 'block';
                resultados.innerHTML = `
                    <div class="error">
                        <h3>❌ Erro na Geração do Relatório Completo</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique se a biblioteca jsPDF está carregada corretamente.</p>
                    </div>
                `;
            }
        }

        // Teste de casos limite
        function testarCasosLimite() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            const casosLimite = [
                '',  // String vazia
                null,  // Valor nulo
                undefined,  // Indefinido
                123,  // Número
                '🚗🚗🚗 Múltiplos emojis iguais 📊📊📊',
                'Texto normal sem emojis',
                '   Espaços   múltiplos   e   tabs	',
                'ÇãõÁÉÍÓÚ àèìòù caracteres acentuados',
                'Øxygen Übung Èconomic Special International',
                '💰💰💰 R$ 1.000,00 🔥🔥🔥 PROMOÇÃO 🎉🎉🎉',
                'Mix: 📊 dados ⛽ combustível 💰 gasto 📈 gráfico intercalados'
            ];
            
            let html = '<h3>⚡ Teste de Casos Limite</h3>';
            let sucessos = 0;
            
            casosLimite.forEach((teste, index) => {
                try {
                    const normalizado = normalizarTextoPDF(teste);
                    const tipoInput = teste === null ? 'null' : teste === undefined ? 'undefined' : typeof teste;
                    const semErros = typeof normalizado === 'string';
                    if (semErros) sucessos++;
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid ${semErros ? '#28a745' : '#dc3545'}; border-radius: 5px; background: ${semErros ? '#d4edda' : '#f8d7da'};">
                            <strong>Caso Limite ${index + 1}:</strong><br>
                            <strong>Tipo Input:</strong> ${tipoInput}<br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Output:</strong> <code>${JSON.stringify(normalizado)}</code><br>
                            <strong>Status:</strong> ${semErros ? '✅ OK' : '❌ ERRO'}
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da;">
                            <strong>Caso Limite ${index + 1}:</strong><br>
                            <strong>Input:</strong> <code>${JSON.stringify(teste)}</code><br>
                            <strong>Erro:</strong> ${error.message}<br>
                            <strong>Status:</strong> ❌ EXCEÇÃO
                        </div>
                    `;
                }
            });
            
            html += `
                <div class="info">
                    <h4>📊 Resumo dos Casos Limite</h4>
                    <p>✅ Sucessos: ${sucessos}</p>
                    <p>❌ Falhas: ${casosLimite.length - sucessos}</p>
                    <p><strong>Taxa de Sucesso: ${((sucessos / casosLimite.length) * 100).toFixed(1)}%</strong></p>
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Validar implementação
        function validarImplementacao() {
            const resultados = document.getElementById('resultados');
            resultados.style.display = 'block';
            
            // Verificar se funções existem
            const funcoes = [
                { nome: 'normalizarTextoPDF', existe: typeof normalizarTextoPDF === 'function' },
                { nome: 'adicionarTextoPDF', existe: typeof adicionarTextoPDF === 'function' },
                { nome: 'jsPDF', existe: typeof window.jspdf !== 'undefined' }
            ];
            
            // Verificar mapeamentos de emojis
            const emojisTestados = ['📊', '⛽', '💰', '📈', '💵', '🔧', '✅', '⚠️'];
            const mapeamentosOK = emojisTestados.every(emoji => {
                const resultado = normalizarTextoPDF(emoji);
                return resultado !== emoji && resultado.includes('[') && resultado.includes(']');
            });
            
            let html = '<h3>🔍 Validação da Implementação</h3>';
            
            // Status das funções
            html += '<h4>📋 Funções Disponíveis:</h4>';
            funcoes.forEach(funcao => {
                html += `
                    <div style="margin: 5px 0; padding: 8px; border: 1px solid ${funcao.existe ? '#28a745' : '#dc3545'}; border-radius: 3px; background: ${funcao.existe ? '#d4edda' : '#f8d7da'};">
                        ${funcao.existe ? '✅' : '❌'} ${funcao.nome}: ${funcao.existe ? 'Disponível' : 'Não encontrada'}
                    </div>
                `;
            });
            
            // Status dos mapeamentos
            html += '<h4>🗺️ Mapeamento de Emojis:</h4>';
            html += `
                <div style="margin: 5px 0; padding: 8px; border: 1px solid ${mapeamentosOK ? '#28a745' : '#dc3545'}; border-radius: 3px; background: ${mapeamentosOK ? '#d4edda' : '#f8d7da'};">
                    ${mapeamentosOK ? '✅' : '❌'} Mapeamentos: ${mapeamentosOK ? 'Funcionando corretamente' : 'Com problemas'}
                </div>
            `;
            
            // Teste de exemplos
            html += '<h4>🧪 Exemplos de Conversão:</h4>';
            emojisTestados.forEach(emoji => {
                const convertido = normalizarTextoPDF(emoji);
                html += `
                    <div style="margin: 5px 0; padding: 8px; border: 1px solid #17a2b8; border-radius: 3px; background: #d1ecf1;">
                        <code>${emoji}</code> → <code>${convertido}</code>
                    </div>
                `;
            });
            
            // Status geral
            const todosOK = funcoes.every(f => f.existe) && mapeamentosOK;
            html += `
                <div class="${todosOK ? 'success' : 'error'}">
                    <h4>${todosOK ? '✅' : '❌'} Status Geral da Implementação</h4>
                    <p><strong>Sistema de Normalização:</strong> ${todosOK ? 'Completamente funcional' : 'Com problemas'}</p>
                    ${todosOK ? '<p>✅ Pronto para uso em produção!</p>' : '<p>❌ Requer correções antes do uso.</p>'}
                </div>
            `;
            
            resultados.innerHTML = html;
        }

        // Inicializar página
        window.onload = function() {
            console.log('🧪 Sistema de Teste de Normalização PDF carregado');
            console.log('📊 Funções disponíveis: normalizarTextoPDF, adicionarTextoPDF');
            console.log('🔧 Biblioteca jsPDF:', typeof window.jspdf !== 'undefined' ? 'Carregada' : 'Não encontrada');
        };
    </script>
</body>
</html>
